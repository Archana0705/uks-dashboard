<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>UKS Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background: #f5f7fb
    }

    .card {
      border-radius: 14px;
      border: none
    }

    .filter-bar {
      position: sticky;
      top: 0;
      background: white;
      z-index: 1000
    }

    .chart-actions {
      opacity: 0;
      transition: .2s
    }

    .card:hover .chart-actions {
      opacity: 1
    }

    body {
      background: #f4f6fb;
      font-family: Inter, system-ui;
    }

    .app-header {
      background: linear-gradient(135deg, #ffffff, #f8f9ff);
      border-bottom: 1px solid #eee;
      height: 64px;
    }

    .app-title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: .3px;
    }

    .filter-bar {
      position: sticky;
      top: 64px;
      background: white;
      z-index: 9;
      border-radius: 14px;
      margin: 5px 12px;
    }

    .filter-bar label {
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }

    .form-select,
    .form-range {
      border-radius: 10px;
    }

    .card {
      border-radius: 18px;
      border: none;
      background: white;
      box-shadow: 0 8px 25px rgba(0, 0, 0, .06);
      transition: .25s;
    }

    .card:hover {
      box-shadow: 0 12px 35px rgba(0, 0, 0, .1);
    }

    .chart-actions {
      opacity: 0;
      transition: .2s;
    }

    .card:hover .chart-actions {
      opacity: 1;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      border: none;
      border-radius: 10px;
    }

    .btn-outline-secondary {
      border-radius: 10px;
    }

    .dropdown-menu {
      border-radius: 12px;
      min-width: 180px;
    }

    .dropdown-item {
      font-size: 14px;
      padding: 10px 14px;
    }

    ul.dropdown-menu.dropdown-menu-end.shadow.show {
      z-index: 9999;
    }

    h5 i {
      opacity: 0.8;
    }

    .btn-group-sm .btn {
      border-radius: 8px;
      padding: 4px 10px;
    }

    input[type="date"] {
      border-radius: 8px;
    }

    .app-wrapper {
      display: flex;
    }

    .sidebar {
      position: fixed;
      top: 64px;
      left: 0;
      width: 240px;
      height: calc(100vh - 64px);
      background: linear-gradient(180deg, #f9fafc, #f2f4f9);
      border-right: 1px solid #eee;
      transition: transform .3s ease;
      z-index: 2000;
    }

    .sidebar-header {
      height: 64px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid #eee;
    }

    .sidebar-menu li.active {
      background: linear-gradient(135deg, #5b5df0, #7b7dff);
      color: white;
      box-shadow: 0 6px 16px rgba(91, 93, 240, .35);
    }

    .sidebar-menu i {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: #eef0f7;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar-menu li a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      text-decoration: none;
      color: #444;
      font-size: 14px;
    }

    .sidebar-menu li a:hover {
      background: #f3f5ff;
      color: #4f46e5;
    }

    .submenu {
      list-style: none;
      padding-left: 30px;
    }

    .submenu li a {
      padding: 8px 16px;
      font-size: 13px;
    }

    .main-content {
      margin-left: 240px;
      width: 100%;
      transition: .3s;
      margin-top: 64px;
    }

    .main-content.collapsed {
      margin-left: 70px;
    }

    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      z-index: 2000;
    }

    .main-content {
      margin-top: 64px;
    }

    .sidebar.collapsed .sidebar-header span {
      display: none;
    }

    .sidebar.collapsed .sidebar-menu span {
      display: none;
    }

    .sidebar.collapsed .submenu {
      display: none !important;
    }

    .sidebar.collapsed .sidebar-header img {
      display: none;
    }

    .sidebar.collapsed {
      width: 0;
      overflow: hidden;
    }

    .main-content.collapsed {
      margin-left: 0;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .filter-bar .col-md-2,
      .filter-bar .col-md-3 {
        margin-bottom: 10px;
      }
    }

    @media (max-width: 992px) {
      .chart-row {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      body {
        font-size: 14px;
      }

      h5 {
        font-size: 16px;
      }

      .app-title {
        font-size: 16px;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 240px;
      }

      .sidebar.collapsed {
        transform: translateX(-100%);
      }

      .sidebar:not(.collapsed) {
        transform: translateX(0);
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, .25);
      }

      .main-content {
        margin-left: 0 !important;
      }
    }

    @media (max-width: 768px) {
      .filterWraps {
        width: auto !important;
        margin-left: 15px;
        margin-top: 10px;
      }

      .nomob {
        display: none !important;
      }

      .sidebar {
        transform: translateX(-100%);
        width: 240px;
      }

      .sidebar.open {
        transform: translateX(0);
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, .35);
      }

      .sidebar.collapsed {
        width: 240px;
        overflow: visible;
      }

      .main-content {
        margin-left: 0 !important;
      }
    }

    .filter-section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid;
    }

    .geographic-filter {
      border-left-color: #4f46e5;
    }

    .demographic-filter {
      border-left-color: #10b981;
    }

    .scheme-filter {
      border-left-color: #f59e0b;
    }

    .active-filter-badge {
      background: #4f46e5;
      color: white;
      border-radius: 12px;
      padding: 3px 10px;
      font-size: 12px;
      margin-right: 5px;
      margin-bottom: 5px;
      display: inline-block;
    }

    .logic-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .logic-toggle .btn-group {
      width: 120px;
    }

    .logic-toggle .form-check {
      margin: 0;
    }

    .filter-group-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .count-badge {
      background: #4f46e5;
      color: white;
      border-radius: 20px;
      padding: 2px 8px;
      font-size: 11px;
      margin-left: 5px;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg app-header px-4">
    <div class="d-flex align-items-center">
      <button class="btn btn-sm btn-light" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
      </button>
      <img src="assets/img/tn_logo.png" height="36" class="me-2">
      <span class="ms-2 fw-bold">UKS Analytics</span>
    </div>
    <div class="ms-auto d-flex align-items-center gap-3 nomob">
      <div class="dropdown">
        <button class="btn btn-link text-decoration-none d-flex align-items-center gap-2" data-bs-toggle="dropdown">
          <span class="text-muted">Welcome, <b>User Name</b></span>
          <i class="bi bi-chevron-down"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow">
          <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i> Profile</a></li>
          <li>
            <hr class="dropdown-divider">
          </li>
          <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="app-wrapper">
    <div id="sidebar" class="sidebar">
      <ul class="sidebar-menu">
        <li class="active"><a href="#"><i class="bi bi-speedometer2"></i> <span>Dashboard</span></a></li>
        <li><a href="#"><i class="bi bi-people"></i> <span>Beneficiary</span></a></li>
        <li><a href="#"><i class="bi bi-card-checklist"></i> <span>Beneficial Scheme</span></a></li>
        <li><a href="dreamscheme.html"><i class="bi bi-stars"></i> <span>Dream Scheme</span></a></li>
      </ul>
    </div>

    <div id="main" class="main-content">
      <button class="btn btn-outline-primary w-100 d-md-none filterWraps" data-bs-toggle="collapse"
        data-bs-target="#mobileFilters">
        <i class="bi bi-funnel"></i> Filters
      </button>

      <div id="mobileFilters" class="collapse d-md-block">
        <div class="filter-bar p-3 shadow-sm">
          <!-- Logic Toggle -->
          <div class="logic-toggle">
            <span class="filter-group-title">Filter Logic:</span>
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check" name="filterLogic" id="logicAND" autocomplete="off" checked
                onclick="updateFilterLogic('AND')">
              <label class="btn btn-outline-primary" for="logicAND">AND</label>

              <input type="radio" class="btn-check" name="filterLogic" id="logicOR" autocomplete="off"
                onclick="updateFilterLogic('OR')">
              <label class="btn btn-outline-primary" for="logicOR">OR</label>
            </div>
            <span id="logicIndicator" class="badge bg-primary">AND Logic</span>
          </div>

          <!-- Geographic Filters -->
          <div class="filter-section geographic-filter">
            <div class="filter-group-title">
              <i class="bi bi-geo-alt"></i>
              Geographic Filters
            </div>
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label>District</label>
                <select id="district" class="form-select">
                  <option value="ALL" selected>All Districts</option>
                  <option value="Chennai">Chennai</option>
                  <option value="Madurai">Madurai</option>
                  <option value="Coimbatore">Coimbatore</option>
                  <option value="Tiruchirappalli">Tiruchirappalli</option>
                  <option value="Salem">Salem</option>
                </select>
              </div>

              <div class="col-md-3">
                <label>Taluk</label>
                <select id="taluk" class="form-select">
                  <option value="ALL" selected>All Taluks</option>
                </select>
              </div>

              <div class="col-md-3">
                <label>Village</label>
                <select id="village" class="form-select">
                  <option value="ALL" selected>All Villages</option>
                </select>
              </div>

              <div class="col-md-3">
                <label>Shop/Outlet</label>
                <select id="shop" class="form-select">
                  <option value="ALL" selected>All Shops</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Demographic Filters -->
          <div class="filter-section demographic-filter">
            <div class="filter-group-title">
              <i class="bi bi-people"></i>
              Demographic Filters
            </div>
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label>Gender</label>
                <select id="gender" class="form-select">
                  <option value="ALL" selected>All Genders</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="col-md-3">
                <label>Age Range</label>
                <div class="d-flex gap-2">
                  <input type="number" id="ageMin" class="form-control" placeholder="Min" min="18" max="100" value="18">
                  <input type="number" id="ageMax" class="form-control" placeholder="Max" min="18" max="100" value="80">
                </div>
              </div>

              <div class="col-md-3">
                <label>Date Range</label>
                <div class="d-flex align-items-center gap-2">
                  <input type="date" id="dateFrom" class="form-control form-control-sm" value="2024-01-01">
                  <span class="text-muted">to</span>
                  <input type="date" id="dateTo" class="form-control form-control-sm" value="2024-03-31">
                </div>
              </div>

              <div class="col-md-3">
                <label>Status</label>
                <select id="status" class="form-select">
                  <option value="ALL" selected>All Status</option>
                  <option value="Active">Active</option>
                  <option value="Pending">Pending</option>
                  <option value="Inactive">Inactive</option>
                  <option value="Suspended">Suspended</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Scheme Filters -->
          <div class="filter-section scheme-filter">
            <div class="filter-group-title">
              <i class="bi bi-card-checklist"></i>
              Scheme Filters
            </div>
            <div class="row g-3 align-items-end">
              <div class="col-md-6">
                <label>Scheme Category</label>
                <select id="schemeCategory" class="form-select">
                  <option value="ALL" selected>All Categories</option>
                  <option value="Food Security">Food Security</option>
                  <option value="Cash Transfer">Cash Transfer</option>
                  <option value="Agriculture">Agriculture</option>
                  <option value="Employment">Employment</option>
                </select>
              </div>

              <div class="col-md-6">
                <label>Scheme</label>
                <select id="scheme" class="form-select">
                  <option value="ALL" selected>All Schemes</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="row mt-3">
            <div class="col-md-8">
              <div id="activeFiltersDisplay" class="d-flex flex-wrap gap-2"></div>
            </div>
            <div class="col-md-4 d-flex gap-2 justify-content-end">
              <button class="btn btn-primary" onclick="applyFilters()">
                <i class="bi bi-funnel me-2"></i> Apply Filters
              </button>
              <button class="btn btn-outline-danger" onclick="resetAll()">
                <i class="bi bi-arrow-counterclockwise"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="container-fluid mt-4">
        <!-- Summary Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card p-3 shadow">
              <div class="d-flex align-items-center">
                <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                  <i class="bi bi-people text-primary fs-4"></i>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Total Beneficiaries</h6>
                  <h4 id="totalBeneficiariesCount" class="mb-0">0</h4>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3 shadow">
              <div class="d-flex align-items-center">
                <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
                  <i class="bi bi-check-circle text-success fs-4"></i>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Active Beneficiaries</h6>
                  <h4 id="activeBeneficiariesCount" class="mb-0">0</h4>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3 shadow">
              <div class="d-flex align-items-center">
                <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
                  <i class="bi bi-clock text-warning fs-4"></i>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Pending Beneficiaries</h6>
                  <h4 id="pendingBeneficiariesCount" class="mb-0">0</h4>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3 shadow">
              <div class="d-flex align-items-center">
                <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
                  <i class="bi bi-shop text-info fs-4"></i>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Active Shops</h6>
                  <h4 id="activeShopsCount" class="mb-0">0</h4>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <!-- Pie Chart - Smaller size -->
          <div class="col-lg-5">
            <div class="card p-3 shadow">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="d-flex align-items-center gap-2 mb-0">
                  <i class="bi bi-pie-chart-fill text-primary"></i>
                  Geographic Distribution
                  <span id="filterSummary" class="text-muted fs-6 ms-2"></span>
                </h5>
                <div class="chart-actions">
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV('pie')">
                    <i class="bi bi-file-earmark-excel"></i> CSV
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportPDF('pie')">
                    <i class="bi bi-file-earmark-pdf"></i> PDF
                  </button>
                </div>
              </div>
              <div id="pie" style="height:350px"></div>
            </div>
          </div>

          <!-- Status-wise Breakdown - Stacked Bar Chart for All Districts -->
          <div class="col-lg-7">
            <div class="card p-3 shadow h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="d-flex align-items-center gap-2 mb-0">
                  <i class="bi bi-bar-chart-fill text-success"></i>
                  District-wise Status Breakdown
                </h5>
                <div class="chart-actions">
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV('status')">
                    <i class="bi bi-file-earmark-excel"></i> CSV
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportPDF('status')">
                    <i class="bi bi-file-earmark-pdf"></i> PDF
                  </button>
                </div>
              </div>
              <div id="statusChart" style="height:350px"></div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-lg-6">
            <div class="card p-3 shadow">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="d-flex align-items-center gap-2 mb-0">
                  <i class="bi bi-shop text-warning"></i>
                  Shop Performance
                </h5>
                <div class="chart-actions">
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV('shop')">
                    <i class="bi bi-file-earmark-excel"></i> CSV
                  </button>
                </div>
              </div>
              <div id="shopChart" style="height:350px"></div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card p-3 shadow">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="d-flex align-items-center gap-2 mb-0">
                  <i class="bi bi-calendar-week text-info"></i>
                  Monthly Enrollment
                </h5>
                <div class="chart-actions">
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV('trend')">
                    <i class="bi bi-file-earmark-excel"></i> CSV
                  </button>
                </div>
              </div>
              <div id="trendChart" style="height:350px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="assets/js/global.js"></script>
  <script src="assets/js/crypto-js.min.js"></script>
  <script src="assets/js/encrypt_decrypt.js"></script>
  <script>
    $(document).ready(function () {
      // Initialize all data from APIs
      initializeAllData();

      // Set up event listeners
      setupEventListeners();

      // Apply filters on load
      setTimeout(() => {
        applyFilters();
      }, 100);
    });

    // ================== GLOBAL VARIABLES ==================
    let filterLogic = 'AND';
    let schemeLogic = 'AND';

    // Store data from APIs
    let API_DATA = {
      // Geographic data
      districts: [],
      allTaluks: [],
      allVillages: [],
      allShops: [],
      filteredTaluks: [],
      filteredVillages: [],
      filteredShops: [],

      // Scheme data
      schemeCategories: [],
      allSchemes: [],
      filteredSchemesByCategory: {},

      // Chart data
      chartData: [],
      detailedData: [],
      filteredData: [],

      // Status data for dashboard
      statusData: [],
      shopPerformance: [],
      monthlyTrend: []
    };

    // API endpoints configuration
    const API_CONFIG = {
      baseUrl: 'https://tngis.tnega.org/state_scholarship_portal_api/sfdb_survey/api/v1/dashboard2/',
      endpoints: {
        dynamic_input: 'dynamic_input',
        get_districts: 'get_districts'
      }
    };

    // Initialize charts
    let pieChart = echarts.init(document.getElementById("pie"));
    let statusChart = echarts.init(document.getElementById("statusChart"));
    let shopChart = echarts.init(document.getElementById("shopChart"));
    let trendChart = echarts.init(document.getElementById("trendChart"));


    // Load districts
    async function loadDistricts() {
      try {
        const payload = {
          "action": "select",
          "_table_name": "pds_master_district",
          "selected_columns": ["district_id", "district_name"],
          "filter_conditions": {},
          "sort_columns": {},
          "limit_rows": 50,
          "offset_rows": 0
        };

        const response = await makeApiRequest(payload);

        if (response && response.success === 1) {
          const decryptedData = decryptData(response.data);
          let districtList = decryptedData;

          if (typeof decryptedData === 'string') {
            try {
              districtList = JSON.parse(decryptedData);
            } catch (parseError) {
              console.error("Error parsing decrypted data:", parseError);
              districtList = decryptedData;
            }
          }

          if (Array.isArray(districtList)) {
            API_DATA.districts = districtList;
            return districtList;
          } else {
            console.error("District list is not an array:", districtList);
            API_DATA.districts = [];
            return [];
          }
        } else {
          console.error("API did not return success: 1");
          API_DATA.districts = [];
          return [];
        }
      } catch (error) {
        console.error('Error loading districts:', error);
        API_DATA.districts = [];
        return [];
      }
    }

    async function loadTaluks(districtId) {
      try {
        const payload = {
          action: "select",
          _table_name: "pds_master_taluk",
          selected_columns: ["district_id", "taluk_id", "taluk_name"],
          filter_conditions: {
            and: {
              district_id: districtId
            }
          },
          sort_columns: {},
          limit_rows: 100,
          offset_rows: 0
        };

        const response = await makeApiRequest(payload);

        if (response?.success === 1) {
          const decrypted = decryptData(response.data);
          const talukList = Array.isArray(decrypted)
            ? decrypted
            : JSON.parse(decrypted);

          API_DATA.allTaluks = API_DATA.allTaluks.concat(
            talukList.filter(
              t => !API_DATA.allTaluks.some(e => e.taluk_id === t.taluk_id)
            )
          );

          API_DATA.filteredTaluks = talukList;
          return talukList;
        }

        return [];
      } catch (error) {
        console.error("Error loading taluks:", error);
        return [];
      }
    }

    // Load villages for a specific district and taluk
    async function loadVillages(districtId, talukId) {
      try {
        const payload = {
          "action": "select",
          "_table_name": "pds_village_master",
          "selected_columns": ["district_id", "taluk_id", "village_id", "village_name"],
          "filter_conditions": {
            and: {
              "district_id": districtId,
              "taluk_id": talukId
            }
          },
          "sort_columns": {},
          "limit_rows": 200,
          "offset_rows": 0
        };

        const response = await makeApiRequest(payload);

        if (response && response.success === 1) {
          const decryptedData = decryptData(response.data);
          let villageList = decryptedData;

          if (typeof decryptedData === 'string') {
            try {
              villageList = JSON.parse(decryptedData);
            } catch (parseError) {
              console.error("Error parsing decrypted data:", parseError);
              villageList = decryptedData;
            }
          }

          if (Array.isArray(villageList)) {
            // Store in allVillages for caching
            API_DATA.allVillages = API_DATA.allVillages.concat(villageList.filter(v =>
              !API_DATA.allVillages.some(existing => existing.village_id === v.village_id)
            ));

            // Filter for current district and taluk
            API_DATA.filteredVillages = villageList;
            return villageList;
          } else {
            console.error("Village list is not an array:", villageList);
            return [];
          }
        } else {
          console.error("API did not return success: 1 for villages");
          return [];
        }
      } catch (error) {
        console.error('Error loading villages:', error);
        return [];
      }
    }

    // Load shops for a specific district, taluk, and village
    async function loadShops(districtId, talukId, villageId) {
      try {
        const payload = {
          "action": "select",
          "_table_name": "pds_master",
          "selected_columns": ["id", "shop_code"],
          "filter_conditions": {
            and: {
              "district_id": districtId,
              "taluk_id": talukId,
              "village_id": villageId
            }
          },
          "sort_columns": {},
          "limit_rows": 200,
          "offset_rows": 0
        };

        const response = await makeApiRequest(payload);

        if (response && response.success === 1) {
          const decryptedData = decryptData(response.data);
          let shopList = decryptedData;

          if (typeof decryptedData === 'string') {
            try {
              shopList = JSON.parse(decryptedData);
            } catch (parseError) {
              console.error("Error parsing decrypted data:", parseError);
              shopList = decryptedData;
            }
          }

          if (Array.isArray(shopList)) {
            // Store in allShops for caching
            API_DATA.allShops = API_DATA.allShops.concat(shopList.filter(s =>
              !API_DATA.allShops.some(existing => existing.id === s.id)
            ));

            // Filter for current location
            API_DATA.filteredShops = shopList;
            return shopList;
          } else {
            console.error("Shop list is not an array:", shopList);
            return [];
          }
        } else {
          console.error("API did not return success: 1 for shops");
          return [];
        }
      } catch (error) {
        console.error('Error loading shops:', error);
        return [];
      }
    }

    // ================== DASHBOARD SPECIFIC API FUNCTIONS ==================

    // Function to get count data for pie chart
    async function loadCountDataForChart(filters) {
      try {
        // Build filter conditions
        const andConditions = {};

        // Geographic filters
        if (filters.district && filters.district !== 'ALL') {
          andConditions.district_id = filters.district;
        }
        if (filters.taluk && filters.taluk !== 'ALL') {
          andConditions.taluk_id = filters.taluk;
        }
        if (filters.village && filters.village !== 'ALL') {
          andConditions.village_id = filters.village;
        }
        if (filters.shop && filters.shop !== 'ALL') {
          const shopOption = $('#shop option:selected');
          if (shopOption.length > 0 && shopOption.text()) {
            andConditions.shopcode = shopOption.text();
          }
        }

        // Demographic filters
        if (filters.gender && filters.gender !== 'ALL') {
          andConditions.gender = filters.gender;
        }
        if (filters.status && filters.status !== 'ALL') {
          andConditions.status = filters.status;
        }

        // Build filterConditions
        let filterConditions = {};
        if (Object.keys(andConditions).length > 0) {
          filterConditions = { "and": andConditions };
        }

        // Payload for COUNT query
        const payload = {
          "action": "select",
          "_table_name": "analytics.analytics_beneficiaries", // Replace with your actual table
          "selected_columns": [
            "district_id", "district_name", "taluk_name", "village_name",
            "shopcode", "status", "gender", "age", "enrollment_date"
          ],
          "filter_conditions": filterConditions,
          "sort_columns": {
            "district_name": "asc",
            "taluk_name": "asc"
          },
          "limit_rows": 10000,
          "offset_rows": 0
        };

        console.log("Loading count data for chart...");
        const response = await makeApiRequest(payload);

        if (response && response.success === 1) {
          const decryptedData = decryptData(response.data);
          let countData = decryptedData;

          if (typeof decryptedData === 'string') {
            try {
              countData = JSON.parse(decryptedData);
            } catch (parseError) {
              console.error("Error parsing count data:", parseError);
              countData = decryptedData;
            }
          }

          if (Array.isArray(countData)) {
            console.log(`Count API returned ${countData.length} records for chart`);
            return countData;
          } else {
            console.error("Count data is not an array:", countData);
            return [];
          }
        } else {
          console.error("API did not return success: 1 for count data");
          return [];
        }
      } catch (error) {
        console.error('Error loading count data:', error);
        return [];
      }
    }

    // Function to get status breakdown data
    async function loadStatusBreakdownData(filters) {
      try {
        // Build filter conditions (same as count data)
        const andConditions = {};

        if (filters.district && filters.district !== 'ALL') {
          andConditions.district_id = filters.district;
        }
        if (filters.taluk && filters.taluk !== 'ALL') {
          andConditions.taluk_id = filters.taluk;
        }
        if (filters.village && filters.village !== 'ALL') {
          andConditions.village_id = filters.village;
        }

        let filterConditions = {};
        if (Object.keys(andConditions).length > 0) {
          filterConditions = { "and": andConditions };
        }

        // Payload for status breakdown
        const payload = {
          "action": "select",
          "_table_name": "analytics.analytics_beneficiaries",
          "selected_columns": ["district_name", "status", "COUNT(*) as count"],
          "filter_conditions": filterConditions,
          "group_by": ["district_name", "status"],
          "sort_columns": {
            "district_name": "asc"
          },
          "limit_rows": 1000,
          "offset_rows": 0
        };

        const response = await makeApiRequest(payload);

        if (response && response.success === 1) {
          const decryptedData = decryptData(response.data);
          return Array.isArray(decryptedData) ? decryptedData : [];
        }
        return [];
      } catch (error) {
        console.error('Error loading status data:', error);
        return [];
      }
    }

    // Function to get shop performance data
    async function loadShopPerformanceData(filters) {
      try {
        const andConditions = {};

        if (filters.district && filters.district !== 'ALL') {
          andConditions.district_id = filters.district;
        }

        let filterConditions = {};
        if (Object.keys(andConditions).length > 0) {
          filterConditions = { "and": andConditions };
        }

        const payload = {
          "action": "select",
          "_table_name": "analytics.analytics_beneficiaries",
          "selected_columns": ["shopcode", "COUNT(*) as count"],
          "filter_conditions": filterConditions,
          "group_by": ["shopcode"],
          "sort_columns": {
            "count": "desc"
          },
          "limit_rows": 10,
          "offset_rows": 0
        };

        const response = await makeApiRequest(payload);

        if (response && response.success === 1) {
          const decryptedData = decryptData(response.data);
          return Array.isArray(decryptedData) ? decryptedData : [];
        }
        return [];
      } catch (error) {
        console.error('Error loading shop data:', error);
        return [];
      }
    }

    // Function to get monthly trend data
    async function loadMonthlyTrendData(filters) {
      try {
        const andConditions = {};

        if (filters.dateFrom && filters.dateTo) {
          andConditions.enrollment_date = {
            "gte": filters.dateFrom,
            "lte": filters.dateTo
          };
        }

        let filterConditions = {};
        if (Object.keys(andConditions).length > 0) {
          filterConditions = { "and": andConditions };
        }

        const payload = {
          "action": "select",
          "_table_name": "analytics.analytics_beneficiaries",
          "selected_columns": [
            "DATE_TRUNC('month', enrollment_date) as month",
            "COUNT(*) as count"
          ],
          "filter_conditions": filterConditions,
          "group_by": ["month"],
          "sort_columns": {
            "month": "asc"
          },
          "limit_rows": 12,
          "offset_rows": 0
        };

        const response = await makeApiRequest(payload);

        if (response && response.success === 1) {
          const decryptedData = decryptData(response.data);
          return Array.isArray(decryptedData) ? decryptedData : [];
        }
        return [];
      } catch (error) {
        console.error('Error loading trend data:', error);
        return [];
      }
    }

    // ================== GENERIC API FUNCTION ==================

    // Generic API request function
    async function makeApiRequest(payload) {
      try {
        const encryptedPayload = encryptData(payload);
        const url = API_CONFIG.baseUrl + API_CONFIG.endpoints.dynamic_input;

        const response = await $.ajax({
          url: url,
          type: "POST",
          dataType: "json",
          data: { data: encryptedPayload },
          success: function (response) {
            return response;
          },
          error: function (xhr, status, error) {
            console.error("API Error:", {
              status: status,
              error: error,
              responseText: xhr.responseText
            });
            throw new Error(`API Error: ${status} - ${error}`);
          }
        });

        return response;
      } catch (error) {
        console.error('API Request Error:', error);
        throw error;
      }
    }

    // ================== DROPDOWN POPULATION FUNCTIONS ==================

    // Populate district dropdown
    function populateDistrictDropdown() {
      const districtSelect = $('#district');
      districtSelect.empty();

      // Always add "All Districts" option
      districtSelect.append('<option value="ALL" selected>All Districts</option>');

      if (API_DATA.districts && API_DATA.districts.length > 0) {
        console.log(`Populating dropdown with ${API_DATA.districts.length} districts`);

        // Sort districts by name
        const sortedDistricts = [...API_DATA.districts].sort((a, b) => {
          const nameA = a.district_name || a.name || '';
          const nameB = b.district_name || b.name || '';
          return nameA.localeCompare(nameB);
        });

        // Add each district to dropdown
        sortedDistricts.forEach(district => {
          const districtId = district.district_id || district.id || district.district_code;
          const districtName = district.district_name || district.name || 'Unknown District';

          districtSelect.append(`<option value="${districtId}">${districtName}</option>`);
        });

        console.log("District dropdown populated successfully");
      } else {
        console.log("No districts available, showing fallback options");
        districtSelect.append('<option value="ALL" selected>No districts available</option>');
      }
    }

    // Populate taluk dropdown
    function populateTalukDropdown(taluks) {
      const talukSelect = $('#taluk');
      const currentTalukValue = talukSelect.val();

      talukSelect.empty();
      talukSelect.append('<option value="ALL" selected>All Taluks</option>');

      if (taluks && taluks.length > 0) {
        console.log(`Populating dropdown with ${taluks.length} taluks`);

        // Sort taluks by name
        const sortedTaluks = [...taluks].sort((a, b) => {
          const nameA = a.taluk_name || a.name || '';
          const nameB = b.taluk_name || b.name || '';
          return nameA.localeCompare(nameB);
        });

        // Add each taluk to dropdown
        sortedTaluks.forEach(taluk => {
          const talukId = taluk.taluk_id || taluk.id;
          const talukName = taluk.taluk_name || taluk.name || 'Unknown Taluk';

          talukSelect.append(`<option value="${talukId}">${talukName}</option>`);
        });

        // Try to restore previous selection
        if (currentTalukValue !== 'ALL' && taluks.some(t => (t.taluk_id || t.id) == currentTalukValue)) {
          talukSelect.val(currentTalukValue);
        }

        console.log("Taluk dropdown populated successfully");
      } else {
        console.log("No taluks available for selected district");
        talukSelect.append('<option value="ALL" selected>No taluks available</option>');
      }

      // Enable taluk dropdown
      talukSelect.prop('disabled', false);
    }

    // Populate village dropdown
    function populateVillageDropdown(villages) {
      const villageSelect = $('#village');
      const currentVillageValue = villageSelect.val();

      villageSelect.empty();
      villageSelect.append('<option value="ALL" selected>All Villages</option>');

      if (villages && villages.length > 0) {
        console.log(`Populating dropdown with ${villages.length} villages`);

        // Sort villages by name
        const sortedVillages = [...villages].sort((a, b) => {
          const nameA = a.village_name || a.name || '';
          const nameB = b.village_name || b.name || '';
          return nameA.localeCompare(nameB);
        });

        // Add each village to dropdown
        sortedVillages.forEach(village => {
          const villageId = village.village_id || village.id;
          const villageName = village.village_name || village.name || 'Unknown Village';

          villageSelect.append(`<option value="${villageId}">${villageName}</option>`);
        });

        // Try to restore previous selection
        if (currentVillageValue !== 'ALL' && villages.some(v => (v.village_id || v.id) == currentVillageValue)) {
          villageSelect.val(currentVillageValue);
        }

        console.log("Village dropdown populated successfully");
      } else {
        console.log("No villages available for selected taluk");
        villageSelect.append('<option value="ALL" selected>No villages available</option>');
      }

      // Enable village dropdown
      villageSelect.prop('disabled', false);
    }

    // Populate shop dropdown
    function populateShopDropdown(shops) {
      const shopSelect = $('#shop');
      const currentShopValue = shopSelect.val();

      shopSelect.empty();
      shopSelect.append('<option value="ALL" selected>All Shops</option>');

      if (shops && shops.length > 0) {
        console.log(`Populating dropdown with ${shops.length} shops`);

        // Sort shops by code
        const sortedShops = [...shops].sort((a, b) => {
          const codeA = a.shop_code || a.code || '';
          const codeB = b.shop_code || b.code || '';
          return codeA.localeCompare(codeB);
        });

        // Add each shop to dropdown
        sortedShops.forEach(shop => {
          const shopId = shop.id || shop.shop_id;
          const shopCode = shop.shop_code || shop.code || `Shop ${shopId}`;

          shopSelect.append(`<option value="${shopId}">${shopCode}</option>`);
        });

        // Try to restore previous selection
        if (currentShopValue !== 'ALL' && shops.some(s => (s.id || s.shop_id) == currentShopValue)) {
          shopSelect.val(currentShopValue);
        }

        console.log("Shop dropdown populated successfully");
      } else {
        console.log("No shops available for selected location");
        shopSelect.append('<option value="ALL" selected>No shops available</option>');
      }

      // Shop dropdown is always enabled
      shopSelect.prop('disabled', false);
    }

    // ================== EVENT HANDLER FUNCTIONS ==================

    // Handle district change
    async function handleDistrictChange() {
      const districtId = $('#district').val();
      console.log("District changed to:", districtId);

      // Reset dependent dropdowns
      $('#taluk').html('<option value="ALL" selected>Loading taluks...</option>');
      $('#taluk').prop('disabled', true);
      $('#village').html('<option value="ALL" selected>Select taluk first</option>');
      $('#village').prop('disabled', true);
      $('#shop').html('<option value="ALL" selected>Select village first</option>');

      if (districtId !== 'ALL') {
        try {
          // Load taluks for selected district
          const taluks = await loadTaluks(districtId);
          populateTalukDropdown(taluks);

          // Clear village and shop data
          API_DATA.filteredVillages = [];
          API_DATA.filteredShops = [];
        } catch (error) {
          console.error("Error loading taluks:", error);
          $('#taluk').html('<option value="ALL" selected>Error loading taluks</option>');
        }
      } else {
        // If "All Districts" is selected, enable taluk dropdown with empty options
        $('#taluk').html('<option value="ALL" selected>All Taluks</option>');
        $('#taluk').prop('disabled', false);

        // Clear all filtered data
        API_DATA.filteredTaluks = [];
        API_DATA.filteredVillages = [];
        API_DATA.filteredShops = [];
      }
    }

    // Handle taluk change
    async function handleTalukChange() {
      const districtId = $('#district').val();
      const talukId = $('#taluk').val();

      console.log("Taluk changed to:", talukId);

      // Reset dependent dropdowns
      $('#village').html('<option value="ALL" selected>Loading villages...</option>');
      $('#village').prop('disabled', true);
      $('#shop').html('<option value="ALL" selected>Select village first</option>');

      if (districtId !== 'ALL' && talukId !== 'ALL') {
        try {
          // Load villages for selected district and taluk
          const villages = await loadVillages(districtId, talukId);
          populateVillageDropdown(villages);

          // Clear shop data
          API_DATA.filteredShops = [];
        } catch (error) {
          console.error("Error loading villages:", error);
          $('#village').html('<option value="ALL" selected>Error loading villages</option>');
        }
      } else {
        // If "All Taluks" is selected, enable village dropdown with empty options
        $('#village').html('<option value="ALL" selected>All Villages</option>');
        $('#village').prop('disabled', false);

        // Clear village and shop data
        API_DATA.filteredVillages = [];
        API_DATA.filteredShops = [];
      }
    }

    // Handle village change
    async function handleVillageChange() {
      const districtId = $('#district').val();
      const talukId = $('#taluk').val();
      const villageId = $('#village').val();

      console.log("Village changed to:", villageId);

      // Reset shop dropdown
      $('#shop').html('<option value="ALL" selected>Loading shops...</option>');

      if (districtId !== 'ALL' && talukId !== 'ALL' && villageId !== 'ALL') {
        try {
          // Load shops for selected district, taluk, and village
          const shops = await loadShops(districtId, talukId, villageId);
          populateShopDropdown(shops);
        } catch (error) {
          console.error("Error loading shops:", error);
          $('#shop').html('<option value="ALL" selected>Error loading shops</option>');
        }
      } else {
        // If "All Villages" is selected, show all shops option
        $('#shop').html('<option value="ALL" selected>All Shops</option>');
        API_DATA.filteredShops = [];
      }
    }

    // ================== INITIALIZATION FUNCTION ==================

    // Initialize all data
    async function initializeAllData() {
      try {
        // Load districts
        await loadDistricts();
        populateDistrictDropdown();

        // Load initial dropdown values from sample data for demonstration
        const sampleDistricts = ["Chennai", "Madurai", "Coimbatore", "Tiruchirappalli", "Salem"];
        sampleDistricts.forEach(district => {
          $('#district').append(`<option value="${district}">${district}</option>`);
        });

      } catch (error) {
        console.error('Initialization error:', error);

        // Fallback initialization
        populateDistrictDropdown();

        // Add sample data
        const sampleDistricts = ["Chennai", "Madurai", "Coimbatore", "Tiruchirappalli", "Salem"];
        sampleDistricts.forEach(district => {
          $('#district').append(`<option value="${district}">${district}</option>`);
        });
      }
    }

    // ================== EVENT LISTENERS SETUP ==================

    // Set up event listeners
    function setupEventListeners() {
      console.log("Setting up event listeners");

      // Geographic filters
      $('#district').on('change', handleDistrictChange);
      $('#taluk').on('change', handleTalukChange);
      $('#village').on('change', handleVillageChange);
      $('#shop').on('change', applyFilters);

      // Demographic filters
      $('#gender, #ageMin, #ageMax, #dateFrom, #dateTo, #status').on('change', applyFilters);

      // Scheme filters
      $('#schemeCategory, #scheme').on('change', applyFilters);

      console.log("Event listeners setup complete");
    }

    // Update filter logic
    function updateFilterLogic(logic) {
      filterLogic = logic;
      document.getElementById('logicIndicator').textContent = `${logic} Logic`;
      console.log(`Filter logic changed to: ${logic}`);
      applyFilters();
    }

    // ================== FILTER FUNCTIONS ==================

    // Update filter summary display
    function updateFilterSummary(filters) {
      const summaryDiv = $('#activeFiltersDisplay');
      summaryDiv.empty();

      // Add geographic filters
      if (filters.district && filters.district !== 'ALL') {
        const districtName = $('#district option:selected').text();
        summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> District: ${districtName}</span>`);
      }

      if (filters.taluk && filters.taluk !== 'ALL') {
        const talukName = $('#taluk option:selected').text();
        summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> Taluk: ${talukName}</span>`);
      }

      if (filters.village && filters.village !== 'ALL') {
        const villageName = $('#village option:selected').text();
        summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> Village: ${villageName}</span>`);
      }

      if (filters.shop && filters.shop !== 'ALL') {
        const shopName = $('#shop option:selected').text();
        summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-shop"></i> Shop: ${shopName}</span>`);
      }

      // Add demographic filters
      if (filters.gender && filters.gender !== 'ALL') {
        summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-gender-ambiguous"></i> Gender: ${filters.gender}</span>`);
      }

      if (filters.status && filters.status !== 'ALL') {
        summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-circle-fill"></i> Status: ${filters.status}</span>`);
      }

      if (filters.ageMin != 18 || filters.ageMax != 80) {
        summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-calendar3"></i> Age: ${filters.ageMin}-${filters.ageMax}</span>`);
      }

      // Add date filters
      if (filters.dateFrom && filters.dateTo) {
        summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-calendar-range"></i> Date: ${filters.dateFrom} to ${filters.dateTo}</span>`);
      }

      // Add scheme filters
      if (filters.schemeCategory && filters.schemeCategory !== 'ALL') {
        const categoryName = $('#schemeCategory option:selected').text();
        summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-card-checklist"></i> Category: ${categoryName}</span>`);
      }

      if (filters.scheme && filters.scheme !== 'ALL') {
        const schemeName = $('#scheme option:selected').text();
        summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-stars"></i> Scheme: ${schemeName}</span>`);
      }

      // Add logic badge
      summaryDiv.append(`<span class="active-filter-badge" style="background:#6c757d;"><i class="bi bi-funnel"></i> Logic: ${filterLogic}</span>`);
    }

    // Main filter function
    async function applyFilters() {
      console.log("========== APPLYING FILTERS ==========");

      // Show loading state
      $('#filterSummary').text('Loading data...');
      $('#totalBeneficiariesCount').text('0');
      $('#activeBeneficiariesCount').text('0');
      $('#pendingBeneficiariesCount').text('0');
      $('#activeShopsCount').text('0');

      // Collect all filter values
      const filters = {
        district: $('#district').val(),
        taluk: $('#taluk').val(),
        village: $('#village').val(),
        shop: $('#shop').val(),
        gender: $('#gender').val(),
        ageMin: $('#ageMin').val(),
        ageMax: $('#ageMax').val(),
        dateFrom: $('#dateFrom').val(),
        dateTo: $('#dateTo').val(),
        status: $('#status').val(),
        schemeCategory: $('#schemeCategory').val(),
        scheme: $('#scheme').val(),
        filterLogic: filterLogic
      };

      console.log("Active filters:", filters);

      // Update filter summary
      updateFilterSummary(filters);

      try {
        // Load all data in parallel
        const [countData, statusData, shopData, trendData] = await Promise.all([
          loadCountDataForChart(filters),
          loadStatusBreakdownData(filters),
          loadShopPerformanceData(filters),
          loadMonthlyTrendData(filters)
        ]);

        // Store data
        API_DATA.chartData = countData;
        API_DATA.statusData = statusData;
        API_DATA.shopPerformance = shopData;
        API_DATA.monthlyTrend = trendData;
        API_DATA.filteredData = countData;

        // Update all charts
        updateAllCharts(countData, statusData, shopData, trendData);

        console.log("========== FILTERS APPLIED SUCCESSFULLY ==========");
        console.log(`Chart data: ${countData.length} records`);
        console.log(`Status data: ${statusData.length} records`);
        console.log(`Shop data: ${shopData.length} records`);
        console.log(`Trend data: ${trendData.length} records`);

      } catch (error) {
        console.error('Error applying filters:', error);
        $('#filterSummary').text('Error loading data');

        // Clear charts
        clearAllCharts();

        // Show error message
        alert('Error loading data. Please check your filters and try again.');
      }
    }

    // Clear all charts
    function clearAllCharts() {
      if (pieChart) pieChart.clear();
      if (statusChart) statusChart.clear();
      if (shopChart) shopChart.clear();
      if (trendChart) trendChart.clear();
    }

    // ================== CHART FUNCTIONS ==================

    // Update all charts
    function updateAllCharts(countData, statusData, shopData, trendData) {
      // Update geographic distribution pie chart
      updateGeographicDistributionChart(countData);

      // Update status breakdown chart
      updateStatusBreakdownChart(statusData);

      // Update shop performance chart
      updateShopPerformanceChart(shopData);

      // Update monthly trend chart
      updateMonthlyTrendChart(trendData);

      // Update summary cards
      updateSummaryCards(countData, statusData, shopData);
    }

    // Update geographic distribution pie chart
    function updateGeographicDistributionChart(countData) {
      // Group data by district
      const districtCounts = {};
      let totalCount = 0;

      countData.forEach(item => {
        const districtName = item.district_name || 'Unknown District';
        if (!districtCounts[districtName]) {
          districtCounts[districtName] = 0;
        }
        districtCounts[districtName]++;
        totalCount++;
      });

      // Prepare chart data
      const chartData = Object.keys(districtCounts).map(district => ({
        name: district,
        value: districtCounts[district]
      }));

      // Sort by count (descending)
      chartData.sort((a, b) => b.value - a.value);

      // Take top 10 districts, group the rest as "Others"
      let displayData = [];
      if (chartData.length > 10) {
        const top10 = chartData.slice(0, 10);
        const others = chartData.slice(10);
        const othersTotal = others.reduce((sum, item) => sum + item.value, 0);

        displayData = [...top10, { name: 'Other Districts', value: othersTotal }];
      } else {
        displayData = chartData;
      }

      // Chart options
      const option = {
        title: {
          text: `Geographic Distribution (Total: ${totalCount})`,
          left: 'center',
          textStyle: {
            fontSize: 16,
            fontWeight: 'bold'
          }
        },
        tooltip: {
          trigger: 'item',
          formatter: '{b}: {c} ({d}%)'
        },
        legend: {
          type: 'scroll',
          orient: 'vertical',
          right: 10,
          top: 'middle',
          height: '80%',
          textStyle: {
            fontSize: 12
          }
        },
        series: [
          {
            name: 'District Distribution',
            type: 'pie',
            radius: ['40%', '70%'],
            center: ['35%', '50%'],
            avoidLabelOverlap: false,
            itemStyle: {
              borderRadius: 10,
              borderColor: '#fff',
              borderWidth: 2
            },
            label: {
              show: false,
              position: 'center'
            },
            emphasis: {
              label: {
                show: true,
                fontSize: '18',
                fontWeight: 'bold',
                formatter: '{b}\n{c} ({d}%)'
              }
            },
            labelLine: {
              show: false
            },
            data: displayData,
            color: [
              '#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de',
              '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc', '#60acfc',
              '#ff9f7f'
            ]
          }
        ]
      };

      pieChart.setOption(option);
      $('#filterSummary').text(`(${totalCount.toLocaleString()} beneficiaries)`);
    }

    // Update status breakdown chart
    function updateStatusBreakdownChart(statusData) {
      // Process status data
      const districts = {};
      const statuses = ['Active', 'Pending', 'Inactive', 'Suspended'];

      // Initialize districts
      statusData.forEach(item => {
        if (!districts[item.district_name]) {
          districts[item.district_name] = {
            Active: 0,
            Pending: 0,
            Inactive: 0,
            Suspended: 0
          };
        }
        districts[item.district_name][item.status] = parseInt(item.count);
      });

      const districtNames = Object.keys(districts);

      // Prepare series data
      const seriesData = statuses.map(status => ({
        name: status,
        type: 'bar',
        stack: 'total',
        data: districtNames.map(district => districts[district][status] || 0)
      }));

      const option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          formatter: function (params) {
            let tooltip = `<b>${params[0].name}</b><br/>`;
            let total = 0;

            params.forEach(param => {
              if (param.value > 0) {
                tooltip += `${param.seriesName}: ${param.value.toLocaleString()}<br/>`;
                total += param.value;
              }
            });

            tooltip += `<hr style="margin: 5px 0"/>`;
            tooltip += `<b>Total: ${total.toLocaleString()}</b>`;

            return tooltip;
          }
        },
        legend: {
          data: statuses,
          top: 'top',
          textStyle: { fontSize: 11 }
        },
        grid: { left: '3%', right: '4%', top: '15%', bottom: '10%', containLabel: true },
        xAxis: {
          type: 'category',
          data: districtNames,
          axisLabel: {
            interval: 0,
            rotate: districtNames.length > 4 ? 45 : 0,
            fontSize: 10,
            margin: districtNames.length > 4 ? 15 : 0
          }
        },
        yAxis: {
          type: 'value',
          name: 'Count',
          nameTextStyle: { fontSize: 11 }
        },
        series: seriesData,
        color: ['#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
      };

      statusChart.setOption(option);
    }

    // Update shop performance chart
    function updateShopPerformanceChart(shopData) {
      // Process shop data
      const shopNames = shopData.map(item => item.shopcode).slice(0, 10);
      const shopCounts = shopData.map(item => parseInt(item.count)).slice(0, 10);

      const option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          formatter: function (params) {
            return `<b>${params[0].name}</b><br/>Beneficiaries: ${params[0].value.toLocaleString()}`;
          }
        },
        grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
        xAxis: {
          type: 'category',
          data: shopNames,
          axisLabel: {
            interval: 0,
            rotate: 45,
            fontSize: 9,
            margin: 12
          }
        },
        yAxis: { type: 'value', name: 'Beneficiaries' },
        series: [{
          type: 'bar',
          data: shopCounts,
          itemStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: '#83bff6' },
              { offset: 0.5, color: '#188df0' },
              { offset: 1, color: '#188df0' }
            ])
          },
          label: {
            show: shopNames.length > 0,
            position: 'top',
            formatter: '{c}',
            fontSize: 9
          }
        }]
      };

      shopChart.setOption(option);
    }

    // Update monthly trend chart
    function updateMonthlyTrendChart(trendData) {
      // Process trend data
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const trendValues = Array(12).fill(0);

      trendData.forEach(item => {
        if (item.month) {
          const monthIndex = new Date(item.month).getMonth();
          trendValues[monthIndex] = parseInt(item.count);
        }
      });

      const option = {
        tooltip: {
          trigger: 'axis',
          formatter: function (params) {
            return `<b>${params[0].name}</b><br/>New Beneficiaries: ${params[0].value.toLocaleString()}`;
          }
        },
        grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
        xAxis: { type: 'category', data: months },
        yAxis: { type: 'value', name: 'Beneficiaries' },
        series: [{
          name: 'Monthly Enrollment',
          type: 'line',
          data: trendValues,
          smooth: true,
          lineStyle: { width: 3, color: '#ff6b6b' },
          itemStyle: { color: '#ff6b6b' },
          areaStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: 'rgba(255, 107, 107, 0.5)' },
              { offset: 1, color: 'rgba(255, 107, 107, 0.1)' }
            ])
          },
          markPoint: {
            data: [
              { type: 'max', name: 'Max' },
              { type: 'min', name: 'Min' }
            ]
          },
          markLine: {
            data: [{ type: 'average', name: 'Average' }]
          }
        }]
      };

      trendChart.setOption(option);
    }

    // Update summary cards
    function updateSummaryCards(countData, statusData, shopData) {
      const totalCount = countData.length;

      // Calculate active, pending counts from status data
      let activeCount = 0;
      let pendingCount = 0;

      statusData.forEach(item => {
        if (item.status === 'Active') activeCount += parseInt(item.count);
        if (item.status === 'Pending') pendingCount += parseInt(item.count);
      });

      // Count unique active shops
      const activeShops = new Set(
        shopData.filter(shop => parseInt(shop.count) > 0)
          .map(shop => shop.shopcode)
      ).size;

      // Update cards
      $('#totalBeneficiariesCount').text(totalCount.toLocaleString());
      $('#activeBeneficiariesCount').text(activeCount.toLocaleString());
      $('#pendingBeneficiariesCount').text(pendingCount.toLocaleString());
      $('#activeShopsCount').text(activeShops.toLocaleString());
    }

    // ================== RESET FUNCTION ==================

    function resetAll() {
      console.log("Resetting all filters...");

      // Reset geographic filters
      $('#district').val('ALL').trigger('change');
      $('#taluk').val('ALL').prop('disabled', false);
      $('#village').val('ALL').prop('disabled', false);
      $('#shop').val('ALL');

      // Reset demographic filters
      $('#gender').val('ALL');
      $('#status').val('ALL');
      $('#ageMin').val(18);
      $('#ageMax').val(80);

      // Reset dates
      const today = new Date();
      const oneYearAgo = new Date();
      oneYearAgo.setFullYear(today.getFullYear() - 1);
      $('#dateFrom').val(oneYearAgo.toISOString().split('T')[0]);
      $('#dateTo').val(today.toISOString().split('T')[0]);

      // Reset scheme filters
      $('#schemeCategory').val('ALL');
      $('#scheme').val('ALL');

      // Reset logic to AND
      $('#logicAND').prop('checked', true);
      filterLogic = 'AND';
      document.getElementById('logicIndicator').textContent = 'AND Logic';

      // Clear filter summary
      $('#activeFiltersDisplay').empty();

      // Apply filters to load default data
      applyFilters();

      console.log("All filters reset successfully");
    }

    // ================== EXPORT FUNCTIONS ==================

    function exportCSV(type) {
      let rows = "";

      switch (type) {
        case 'pie':
          // Get district data
          const districtCounts = {};
          API_DATA.chartData.forEach(item => {
            const districtName = item.district_name || 'Unknown District';
            districtCounts[districtName] = (districtCounts[districtName] || 0) + 1;
          });

          rows = "District,Beneficiaries,Percentage\n";
          const total = API_DATA.chartData.length;
          Object.entries(districtCounts).forEach(([district, count]) => {
            const percentage = total > 0 ? ((count / total) * 100).toFixed(2) : '0.00';
            rows += `${district},${count},${percentage}%\n`;
          });
          break;

        case 'status':
          rows = "District,Active,Pending,Inactive,Suspended,Total\n";
          const statusMap = {};

          // Process status data
          API_DATA.statusData.forEach(item => {
            if (!statusMap[item.district_name]) {
              statusMap[item.district_name] = {
                Active: 0,
                Pending: 0,
                Inactive: 0,
                Suspended: 0,
                total: 0
              };
            }
            statusMap[item.district_name][item.status] = parseInt(item.count);
            statusMap[item.district_name].total += parseInt(item.count);
          });

          Object.entries(statusMap).forEach(([district, data]) => {
            rows += `${district},${data.Active},${data.Pending},${data.Inactive},${data.Suspended},${data.total}\n`;
          });
          break;

        case 'shop':
          rows = "Shop,Beneficiaries\n";
          API_DATA.shopPerformance.forEach(shop => {
            rows += `${shop.shopcode},${shop.count}\n`;
          });
          break;

        case 'trend':
          rows = "Month,New Beneficiaries\n";
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          API_DATA.monthlyTrend.forEach((item, index) => {
            rows += `${months[index]},${item.count || 0}\n`;
          });
          break;
      }

      let blob = new Blob([rows]);
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${type}_export.csv`;
      a.click();
    }

    function exportPDF(type) {
      let el;
      switch (type) {
        case 'pie': el = document.getElementById('pie'); break;
        case 'status': el = document.getElementById('statusChart'); break;
        default: el = document.getElementById('pie');
      }

      html2canvas(el).then(c => {
        let pdf = new jspdf.jsPDF();
        pdf.addImage(c.toDataURL(), "PNG", 10, 10, 180, 120);
        pdf.save(`${type}_chart.pdf`);
      });
    }

    // ================== SIDEBAR FUNCTIONS ==================

    function toggleSidebar() {
      $("#sidebar").toggleClass("collapsed");
      $("#main").toggleClass("collapsed");
      setTimeout(() => {
        pieChart.resize();
        statusChart.resize();
        shopChart.resize();
        trendChart.resize();
      }, 300);
    }

    // Initialize sidebar for mobile
    if (window.innerWidth <= 768) {
      document.getElementById("sidebar").classList.add("collapsed");
      document.getElementById("main").classList.add("collapsed");
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener("click", function (e) {
      if (window.innerWidth <= 768) {
        let sidebar = document.getElementById("sidebar");
        let btn = document.querySelector(".bi-list");

        if (btn && !sidebar.contains(e.target) && !btn.contains(e.target)) {
          sidebar.classList.add("collapsed");
        }
      }
    });

    // Initialize charts on window resize
    window.addEventListener('resize', function () {
      pieChart.resize();
      statusChart.resize();
      shopChart.resize();
      trendChart.resize();
    });
  </script>
</body>

</html>