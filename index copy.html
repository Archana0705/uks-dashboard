<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>UKS Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f5f7fb
    }

    .card {
      border-radius: 14px;
      border: none
    }

    .filter-bar {
      position: sticky;
      top: 0;
      background: white;
      z-index: 1000
    }

    .chart-actions {
      opacity: 0;
      transition: .2s
    }

    .card:hover .chart-actions {
      opacity: 1
    }

    body {
      background: #f4f6fb;
      font-family: Inter, system-ui;
    }

    .app-header {
      background: linear-gradient(135deg, #ffffff, #f8f9ff);
      border-bottom: 1px solid #eee;
      height: 64px;
    }

    .app-title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: .3px;
    }

    .filter-bar {
      position: sticky;
      top: 64px;
      background: white;
      z-index: 9;
      border-radius: 14px;
      margin: 5px 12px;
    }

    .filter-bar label {
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }

    .form-select,
    .form-range {
      border-radius: 10px;
    }

    .card {
      border-radius: 18px;
      border: none;
      background: white;
      box-shadow: 0 8px 25px rgba(0, 0, 0, .06);
      transition: .25s;
    }

    .card:hover {
      box-shadow: 0 12px 35px rgba(0, 0, 0, .1);
    }

    .chart-actions {
      opacity: 0;
      transition: .2s;
    }

    .card:hover .chart-actions {
      opacity: 1;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      border: none;
      border-radius: 10px;
    }

    .btn-outline-secondary {
      border-radius: 10px;
    }

    .dropdown-menu {
      border-radius: 12px;
      min-width: 180px;
    }

    .dropdown-item {
      font-size: 14px;
      padding: 10px 14px;
    }

    ul.dropdown-menu.dropdown-menu-end.shadow.show {
      z-index: 9999;
    }

    h5 i {
      opacity: 0.8;
    }

    .btn-group-sm .btn {
      border-radius: 8px;
      padding: 4px 10px;
    }

    input[type="date"] {
      border-radius: 8px;
    }

    .app-wrapper {
      display: flex;
    }

    .sidebar {
      position: fixed;
      top: 64px;
      left: 0;
      width: 240px;
      height: calc(100vh - 64px);
      background: linear-gradient(180deg, #f9fafc, #f2f4f9);
      border-right: 1px solid #eee;
      transition: transform .3s ease;
      z-index: 2000;
    }

    .sidebar-header {
      height: 64px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid #eee;
    }

    .sidebar-menu li.active {
      background: linear-gradient(135deg, #5b5df0, #7b7dff);
      color: white;
      box-shadow: 0 6px 16px rgba(91, 93, 240, .35);
    }

    .sidebar-menu i {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: #eef0f7;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar-menu li a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      text-decoration: none;
      color: #444;
      font-size: 14px;
    }

    .sidebar-menu li a:hover {
      background: #f3f5ff;
      color: #4f46e5;
    }

    .submenu {
      list-style: none;
      padding-left: 30px;
    }

    .submenu li a {
      padding: 8px 16px;
      font-size: 13px;
    }

    .main-content {
      margin-left: 240px;
      width: 100%;
      transition: .3s;
      margin-top: 64px;
    }

    .main-content.collapsed {
      margin-left: 70px;
    }

    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      z-index: 2000;
    }

    .main-content {
      margin-top: 64px;
    }

    .sidebar.collapsed .sidebar-header span {
      display: none;
    }

    .sidebar.collapsed .sidebar-menu span {
      display: none;
    }

    .sidebar.collapsed .submenu {
      display: none !important;
    }

    .sidebar.collapsed .sidebar-header img {
      display: none;
    }

    .sidebar.collapsed {
      width: 0;
      overflow: hidden;
    }

    .main-content.collapsed {
      margin-left: 0;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .filter-bar .col-md-2,
      .filter-bar .col-md-3 {
        margin-bottom: 10px;
      }
    }

    @media (max-width: 992px) {
      .chart-row {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      body {
        font-size: 14px;
      }

      h5 {
        font-size: 16px;
      }

      .app-title {
        font-size: 16px;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 240px;
      }

      .sidebar.collapsed {
        transform: translateX(-100%);
      }

      .sidebar:not(.collapsed) {
        transform: translateX(0);
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, .25);
      }

      .main-content {
        margin-left: 0 !important;
      }
    }

    @media (max-width: 768px) {
      .filterWraps {
        width: auto !important;
        margin-left: 15px;
        margin-top: 10px;
      }

      .nomob {
        display: none !important;
      }

      .sidebar {
        transform: translateX(-100%);
        width: 240px;
      }

      .sidebar.open {
        transform: translateX(0);
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, .35);
      }

      .sidebar.collapsed {
        width: 240px;
        overflow: visible;
      }

      .main-content {
        margin-left: 0 !important;
      }
    }

    .select2-container--default .select2-selection--multiple {
      border-radius: 10px;
      border: 1px solid #ced4da;
      padding: 3px;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice {
      background: #4f46e5;
      color: white;
      border: none;
    }

    .filter-section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #4f46e5;
    }

    .active-filter-badge {
      background: #4f46e5;
      color: white;
      border-radius: 12px;
      padding: 3px 10px;
      font-size: 12px;
      margin-right: 5px;
      margin-bottom: 5px;
      display: inline-block;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg app-header px-4">
    <div class="d-flex align-items-center">
      <button class="btn btn-sm btn-light" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
      </button>
      <img src="assets/img/tn_logo.png" height="36" class="me-2">
      <span class="ms-2 fw-bold">UKS Analytics</span>
    </div>
    <div class="ms-auto d-flex align-items-center gap-3 nomob">
      <div class="dropdown">
        <button class="btn btn-link text-decoration-none d-flex align-items-center gap-2" data-bs-toggle="dropdown">
          <span class="text-muted">Welcome, <b>User Name</b></span>
          <i class="bi bi-chevron-down"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow">
          <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i> Profile</a></li>
          <li>
            <hr class="dropdown-divider">
          </li>
          <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="app-wrapper">
    <div id="sidebar" class="sidebar">
      <ul class="sidebar-menu">
        <li><a href="#"><i class="bi bi-speedometer2"></i> <span>Dashboard</span></a></li>
        <li>
          <a data-bs-toggle="collapse" href="#analyticsMenu">
            <i class="bi bi-graph-up"></i> <span>Analytics</span>
            <i class="bi bi-chevron-down ms-auto"></i>
          </a>
          <ul id="analyticsMenu" class="collapse submenu">
            <li><a href="#">PDS</a></li>
            <li><a href="#">DBT</a></li>
            <li><a href="#">KMUT</a></li>
          </ul>
        </li>
        <li><a href="#"><i class="bi bi-file-earmark-text"></i> <span>Reports</span></a></li>
      </ul>
    </div>

    <div id="main" class="main-content">
      <button class="btn btn-outline-primary w-100 d-md-none filterWraps" data-bs-toggle="collapse"
        data-bs-target="#mobileFilters">
        <i class="bi bi-funnel"></i> Filters
      </button>

      <div id="mobileFilters" class="collapse d-md-block">
        <div class="filter-bar p-3 shadow-sm">
          <div class="filter-section">
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label>District</label>
                <select id="district" class="form-select" multiple="multiple">
                  <option value="ALL" selected>All Districts</option>
                  <option value="Chennai">Chennai</option>
                  <option value="Madurai">Madurai</option>
                  <option value="Coimbatore">Coimbatore</option>
                  <option value="Tiruchirappalli">Tiruchirappalli</option>
                  <option value="Salem">Salem</option>
                </select>
              </div>

              <div class="col-md-3">
                <label>Taluk</label>
                <select id="taluk" class="form-select" multiple="multiple">
                  <option value="ALL" selected>All Taluks</option>
                </select>
              </div>

              <div class="col-md-3">
                <label>Village</label>
                <select id="village" class="form-select" multiple="multiple">
                  <option value="ALL" selected>All Villages</option>
                </select>
              </div>

              <div class="col-md-3">
                <label>Shop/Outlet</label>
                <select id="shop" class="form-select" multiple="multiple">
                  <option value="ALL" selected>All Shops</option>
                </select>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label>Scheme</label>
                <select id="scheme" class="form-select" multiple="multiple">
                  <option value="ALL" selected>All Schemes</option>
                  <option value="KMUT">KMUT</option>
                  <option value="DBT">DBT</option>
                  <option value="PDS">PDS</option>
                  <option value="PMKSY">PMKSY</option>
                  <option value="MGNREGA">MGNREGA</option>
                </select>
              </div>

              <div class="col-md-2">
                <label>Gender</label>
                <select id="gender" class="form-select">
                  <option value="ALL" selected>All Genders</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="col-md-2">
                <label>Age Range</label>
                <div class="d-flex gap-2">
                  <input type="number" id="ageMin" class="form-control" placeholder="Min" min="18" max="100" value="18">
                  <input type="number" id="ageMax" class="form-control" placeholder="Max" min="18" max="100" value="80">
                </div>
              </div>

              <div class="col-md-3">
                <label>Date Range</label>
                <div class="d-flex align-items-center gap-2">
                  <input type="date" id="dateFrom" class="form-control form-control-sm">
                  <span class="text-muted">to</span>
                  <input type="date" id="dateTo" class="form-control form-control-sm">
                </div>
              </div>

              <div class="col-md-2 d-flex gap-2">
                <button class="btn btn-primary w-100" onclick="applyFilters()">
                  <i class="bi bi-funnel me-2"></i> Apply
                </button>
                <button class="btn btn-outline-danger" onclick="resetAll()">
                  <i class="bi bi-arrow-counterclockwise"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <div id="activeFiltersDisplay" class="d-flex flex-wrap gap-2"></div>
          </div>
        </div>
      </div>

      <div class="container-fluid mt-4">
        <div class="row g-3">
          <div class="col-lg-8">
            <div class="card p-3 shadow">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="d-flex align-items-center gap-2 mb-0">
                  <i class="bi bi-pie-chart-fill text-primary"></i>
                  Beneficiary Distribution
                  <span id="filterSummary" class="text-muted fs-6 ms-2"></span>
                </h5>
                <div class="chart-actions">
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV('pie')">
                    <i class="bi bi-file-earmark-excel"></i> CSV
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportPDF('pie')">
                    <i class="bi bi-file-earmark-pdf"></i> PDF
                  </button>
                </div>
              </div>
              <div id="pie" style="height:450px"></div>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="card p-3 shadow h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="d-flex align-items-center gap-2 mb-0">
                  <i class="bi bi-bar-chart-fill text-success"></i>
                  District-wise Schemes Breakdown
                </h5>
                <div class="chart-actions">
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV('bar')">
                    <i class="bi bi-file-earmark-excel"></i> CSV
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportPDF('bar')">
                    <i class="bi bi-file-earmark-pdf"></i> PDF
                  </button>
                </div>
              </div>
              <div id="bar" style="height:450px"></div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-lg-6">
            <div class="card p-3 shadow">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="d-flex align-items-center gap-2 mb-0">
                  <i class="bi bi-shop text-warning"></i>
                  Shop Performance
                </h5>
                <div class="chart-actions">
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV('shop')">
                    <i class="bi bi-file-earmark-excel"></i> CSV
                  </button>
                </div>
              </div>
              <div id="shopChart" style="height:350px"></div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card p-3 shadow">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="d-flex align-items-center gap-2 mb-0">
                  <i class="bi bi-calendar-week text-info"></i>
                  Monthly Enrollment
                </h5>
                <div class="chart-actions">
                  <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV('trend')">
                    <i class="bi bi-file-earmark-excel"></i> CSV
                  </button>
                </div>
              </div>
              <div id="trendChart" style="height:350px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function () {
      // Initialize Select2 with proper "ALL" handling
      initializeSelect2();

      // Set default dates
      const today = new Date();
      const lastMonth = new Date();
      lastMonth.setMonth(today.getMonth() - 1);
      $('#dateFrom').val(lastMonth.toISOString().split('T')[0]);
      $('#dateTo').val(today.toISOString().split('T')[0]);

      // Initialize charts and data
      initializeData();

      // Apply filters on load (showing all data)
      setTimeout(() => {
        applyFilters();
      }, 100);
    });

    // Enhanced Sample Data Structure
    const SAMPLE_DATA = {
      districts: {
        Chennai: {
          taluks: {
            'Ambattur': {
              villages: {
                'Ambattur Village': {
                  shops: ['Shop A1', 'Shop A2', 'Shop A3'],
                  beneficiaries: 4200,
                  schemes: {
                    KMUT: 1500,
                    DBT: 1200,
                    PDS: 800,
                    PMKSY: 400,
                    MGNREGA: 300
                  }
                },
                'Korattur': {
                  shops: ['Shop K1', 'Shop K2'],
                  beneficiaries: 3800,
                  schemes: {
                    KMUT: 1300,
                    DBT: 1100,
                    PDS: 700,
                    PMKSY: 400,
                    MGNREGA: 300
                  }
                }
              },
              totalBeneficiaries: 8000
            },
            'T. Nagar': {
              villages: {
                'T. Nagar Main': {
                  shops: ['Shop T1', 'Shop T2', 'Shop T3', 'Shop T4'],
                  beneficiaries: 4500,
                  schemes: {
                    KMUT: 1700,
                    DBT: 1200,
                    PDS: 900,
                    PMKSY: 400,
                    MGNREGA: 300
                  }
                }
              },
              totalBeneficiaries: 4500
            }
          },
          totalBeneficiaries: 12500,
          monthlyTrend: [850, 920, 980, 1050, 1120, 1180, 1250, 1300, 1350, 1400, 1450, 1500]
        },
        Madurai: {
          taluks: {
            'Thirumangalam': {
              villages: {
                'Thirumangalam Town': {
                  shops: ['Shop TM1', 'Shop TM2'],
                  beneficiaries: 3200,
                  schemes: {
                    KMUT: 1100,
                    DBT: 900,
                    PDS: 700,
                    PMKSY: 300,
                    MGNREGA: 200
                  }
                },
                'Kalligudi': {
                  shops: ['Shop KAL1'],
                  beneficiaries: 2800,
                  schemes: {
                    KMUT: 900,
                    DBT: 800,
                    PDS: 600,
                    PMKSY: 300,
                    MGNREGA: 200
                  }
                }
              },
              totalBeneficiaries: 6000
            },
            'Melur': {
              villages: {
                'Melur Town': {
                  shops: ['Shop M1', 'Shop M2', 'Shop M3'],
                  beneficiaries: 3800,
                  schemes: {
                    KMUT: 1200,
                    DBT: 1000,
                    PDS: 800,
                    PMKSY: 400,
                    MGNREGA: 400
                  }
                }
              },
              totalBeneficiaries: 3800
            }
          },
          totalBeneficiaries: 9800,
          monthlyTrend: [650, 720, 780, 820, 880, 920, 950, 980, 1000, 1050, 1080, 1120]
        },
        Coimbatore: {
          taluks: {
            'Coimbatore North': {
              villages: {
                'Gandhipuram': {
                  shops: ['Shop G1', 'Shop G2'],
                  beneficiaries: 4000,
                  schemes: {
                    KMUT: 1400,
                    DBT: 1200,
                    PDS: 800,
                    PMKSY: 300,
                    MGNREGA: 300
                  }
                },
                'R.S. Puram': {
                  shops: ['Shop RS1', 'Shop RS2', 'Shop RS3'],
                  beneficiaries: 4500,
                  schemes: {
                    KMUT: 1500,
                    DBT: 1300,
                    PDS: 900,
                    PMKSY: 400,
                    MGNREGA: 400
                  }
                }
              },
              totalBeneficiaries: 8500
            },
            'Sulur': {
              villages: {
                'Sulur Town': {
                  shops: ['Shop S1'],
                  beneficiaries: 2700,
                  schemes: {
                    KMUT: 900,
                    DBT: 800,
                    PDS: 600,
                    PMKSY: 200,
                    MGNREGA: 200
                  }
                }
              },
              totalBeneficiaries: 2700
            }
          },
          totalBeneficiaries: 11200,
          monthlyTrend: [750, 820, 880, 920, 980, 1020, 1050, 1080, 1120, 1150, 1180, 1220]
        },
        Tiruchirappalli: {
          taluks: {
            'Srirangam': {
              villages: {
                'Srirangam Town': {
                  shops: ['Shop SR1', 'Shop SR2'],
                  beneficiaries: 3500,
                  schemes: {
                    KMUT: 1200,
                    DBT: 1000,
                    PDS: 800,
                    PMKSY: 300,
                    MGNREGA: 200
                  }
                }
              },
              totalBeneficiaries: 3500
            }
          },
          totalBeneficiaries: 8900,
          monthlyTrend: [600, 650, 700, 750, 800, 850, 900, 950, 1000, 1050, 1100, 1150]
        },
        Salem: {
          taluks: {
            'Salem City': {
              villages: {
                'Salem Main': {
                  shops: ['Shop SL1', 'Shop SL2', 'Shop SL3'],
                  beneficiaries: 5200,
                  schemes: {
                    KMUT: 1800,
                    DBT: 1600,
                    PDS: 1000,
                    PMKSY: 500,
                    MGNREGA: 300
                  }
                }
              },
              totalBeneficiaries: 5200
            }
          },
          totalBeneficiaries: 10500,
          monthlyTrend: [700, 750, 800, 850, 900, 950, 1000, 1050, 1100, 1150, 1200, 1250]
        }
      },
      months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
    };

    // Initialize charts
    let pieChart = echarts.init(document.getElementById("pie"));
    let barChart = echarts.init(document.getElementById("bar"));
    let shopChart = echarts.init(document.getElementById("shopChart"));
    let trendChart = echarts.init(document.getElementById("trendChart"));

    // Track all available shops for dropdown
    let ALL_SHOPS = [];

    function initializeSelect2() {
      $('.form-select[multiple]').select2({
        placeholder: "Select options",
        allowClear: true,
        width: '100%',
        closeOnSelect: false
      });

      // Handle "ALL" option selection logic
      $('.form-select[multiple]').on('select2:select', function (e) {
        const selectedValue = e.params.data.id;
        const $select = $(this);
        const currentValues = $select.val() || [];

        if (selectedValue === 'ALL') {
          // If "ALL" is selected, clear other selections and select only "ALL"
          $select.val(['ALL']).trigger('change');
        } else {
          // If any other option is selected, remove "ALL" from selection
          const newValues = currentValues.filter(val => val !== 'ALL');
          $select.val(newValues).trigger('change');
        }
      });

      $('.form-select[multiple]').on('select2:unselect', function (e) {
        const unselectedValue = e.params.data.id;
        const $select = $(this);
        const currentValues = $select.val() || [];

        if (currentValues.length === 0) {
          // If nothing is selected, automatically select "ALL"
          $select.val(['ALL']).trigger('change');
        }
      });
    }

    function initializeData() {
      // Collect all shops from the data structure
      ALL_SHOPS = [];
      Object.values(SAMPLE_DATA.districts).forEach(district => {
        Object.values(district.taluks || {}).forEach(taluk => {
          Object.values(taluk.villages || {}).forEach(village => {
            village.shops.forEach(shop => {
              if (!ALL_SHOPS.includes(shop)) {
                ALL_SHOPS.push(shop);
              }
            });
          });
        });
      });

      // Populate shops dropdown
      $('#shop').empty();
      $('#shop').append('<option value="ALL" selected>All Shops</option>');
      ALL_SHOPS.forEach(shop => {
        $('#shop').append(`<option value="${shop}">${shop}</option>`);
      });
      $('#shop').trigger('change');
    }

    // Cascading dropdowns with proper handling
    $('#district').on('change', function () {
      const selectedDistricts = $(this).val() || ['ALL'];

      // Populate taluks based on selected districts
      let talukOptions = ['ALL'];
      if (selectedDistricts.includes('ALL')) {
        // Show all taluks from all districts
        Object.values(SAMPLE_DATA.districts).forEach(district => {
          if (district.taluks) {
            Object.keys(district.taluks).forEach(taluk => {
              if (!talukOptions.includes(taluk)) {
                talukOptions.push(taluk);
              }
            });
          }
        });
      } else {
        selectedDistricts.forEach(districtName => {
          const district = SAMPLE_DATA.districts[districtName];
          if (district && district.taluks) {
            Object.keys(district.taluks).forEach(taluk => {
              if (!talukOptions.includes(taluk)) {
                talukOptions.push(taluk);
              }
            });
          }
        });
      }

      // Update taluk dropdown
      $('#taluk').empty();
      talukOptions.forEach(taluk => {
        $('#taluk').append(`<option value="${taluk}">${taluk}</option>`);
      });

      // Keep "ALL" selected if it was in the original selection
      if (selectedDistricts.includes('ALL')) {
        $('#taluk').val(['ALL']).trigger('change');
      } else {
        $('#taluk').val(['ALL']).trigger('change'); // Reset to ALL when district changes
      }
    });

    $('#taluk').on('change', function () {
      const selectedTaluks = $(this).val() || ['ALL'];
      const selectedDistricts = $('#district').val() || ['ALL'];

      // Populate villages based on selected taluks and districts
      let villageOptions = ['ALL'];

      if (selectedDistricts.includes('ALL') && selectedTaluks.includes('ALL')) {
        // Show all villages from all districts and taluks
        Object.values(SAMPLE_DATA.districts).forEach(district => {
          Object.values(district.taluks || {}).forEach(taluk => {
            Object.keys(taluk.villages || {}).forEach(village => {
              if (!villageOptions.includes(village)) {
                villageOptions.push(village);
              }
            });
          });
        });
      } else if (selectedDistricts.includes('ALL')) {
        // Show villages from selected taluks across all districts
        Object.values(SAMPLE_DATA.districts).forEach(district => {
          selectedTaluks.forEach(talukName => {
            const taluk = district.taluks[talukName];
            if (taluk && taluk.villages) {
              Object.keys(taluk.villages).forEach(village => {
                if (!villageOptions.includes(village)) {
                  villageOptions.push(village);
                }
              });
            }
          });
        });
      } else if (selectedTaluks.includes('ALL')) {
        // Show villages from all taluks in selected districts
        selectedDistricts.forEach(districtName => {
          const district = SAMPLE_DATA.districts[districtName];
          if (district && district.taluks) {
            Object.values(district.taluks).forEach(taluk => {
              Object.keys(taluk.villages || {}).forEach(village => {
                if (!villageOptions.includes(village)) {
                  villageOptions.push(village);
                }
              });
            });
          }
        });
      } else {
        // Show villages from specific taluks in specific districts
        selectedDistricts.forEach(districtName => {
          const district = SAMPLE_DATA.districts[districtName];
          if (district && district.taluks) {
            selectedTaluks.forEach(talukName => {
              const taluk = district.taluks[talukName];
              if (taluk && taluk.villages) {
                Object.keys(taluk.villages).forEach(village => {
                  if (!villageOptions.includes(village)) {
                    villageOptions.push(village);
                  }
                });
              }
            });
          }
        });
      }

      // Update village dropdown
      $('#village').empty();
      villageOptions.forEach(village => {
        $('#village').append(`<option value="${village}">${village}</option>`);
      });

      // Keep "ALL" selected if it was in the original selection
      if (selectedTaluks.includes('ALL')) {
        $('#village').val(['ALL']).trigger('change');
      } else {
        $('#village').val(['ALL']).trigger('change'); // Reset to ALL when taluk changes
      }
    });

    // Update active filters display
    function updateActiveFiltersDisplay() {
      const activeFilters = [];

      // District
      const districts = $('#district').val() || ['ALL'];
      if (!districts.includes('ALL') && districts.length > 0) {
        activeFilters.push(`District: ${districts.join(', ')}`);
      }

      // Taluk
      const taluks = $('#taluk').val() || ['ALL'];
      if (!taluks.includes('ALL') && taluks.length > 0) {
        activeFilters.push(`Taluk: ${taluks.join(', ')}`);
      }

      // Village
      const villages = $('#village').val() || ['ALL'];
      if (!villages.includes('ALL') && villages.length > 0) {
        activeFilters.push(`Village: ${villages.join(', ')}`);
      }

      // Shop
      const shops = $('#shop').val() || ['ALL'];
      if (!shops.includes('ALL') && shops.length > 0) {
        activeFilters.push(`Shop: ${shops.join(', ')}`);
      }

      // Scheme
      const schemes = $('#scheme').val() || ['ALL'];
      if (!schemes.includes('ALL') && schemes.length > 0) {
        activeFilters.push(`Scheme: ${schemes.join(', ')}`);
      }

      // Gender
      const gender = $('#gender').val();
      if (gender !== 'ALL') {
        activeFilters.push(`Gender: ${gender}`);
      }

      // Age Range
      const ageMin = $('#ageMin').val();
      const ageMax = $('#ageMax').val();
      if (ageMin != 18 || ageMax != 80) {
        activeFilters.push(`Age: ${ageMin}-${ageMax}`);
      }

      // Date Range
      const dateFrom = $('#dateFrom').val();
      const dateTo = $('#dateTo').val();
      if (dateFrom && dateTo) {
        activeFilters.push(`Date: ${new Date(dateFrom).toLocaleDateString()} to ${new Date(dateTo).toLocaleDateString()}`);
      }

      // Display active filters
      const display = $('#activeFiltersDisplay');
      if (activeFilters.length > 0) {
        let html = '<strong>Active Filters:</strong> ';
        html += activeFilters.map(filter =>
          `<span class="active-filter-badge">${filter}</span>`
        ).join(' ');
        display.html(html);
      } else {
        display.html('<span class="text-muted">No filters applied</span>');
      }
    }

    // Main filter function with AND logic
    function filterData() {
      const selectedDistricts = $('#district').val() || ['ALL'];
      const selectedTaluks = $('#taluk').val() || ['ALL'];
      const selectedVillages = $('#village').val() || ['ALL'];
      const selectedShops = $('#shop').val() || ['ALL'];
      const selectedSchemes = $('#scheme').val() || ['ALL'];
      const selectedGender = $('#gender').val();
      const ageMin = parseInt($('#ageMin').val());
      const ageMax = parseInt($('#ageMax').val());
      const dateFrom = $('#dateFrom').val();
      const dateTo = $('#dateTo').val();

      let districtTotals = {};
      let districtSchemeTotals = {}; // Changed to store scheme totals by district
      let shopTotals = {};
      let totalBeneficiaries = 0;
      let monthlyTrendData = Array(12).fill(0);

      // Create filter summary for display
      let filterSummary = '';
      if (!selectedDistricts.includes('ALL')) {
        filterSummary += `District: ${selectedDistricts.join(', ')}`;
      }
      if (!selectedTaluks.includes('ALL')) {
        filterSummary += filterSummary ? ' | ' : '';
        filterSummary += `Taluk: ${selectedTaluks.join(', ')}`;
      }
      if (!selectedVillages.includes('ALL')) {
        filterSummary += filterSummary ? ' | ' : '';
        filterSummary += `Village: ${selectedVillages.join(', ')}`;
      }
      $('#filterSummary').text(filterSummary ? `(${filterSummary})` : '');

      // Date filter factor (simplified)
      let dateFactor = 1.0;
      if (dateFrom && dateTo) {
        dateFactor = 0.8; // 80% of data falls within date range
      }

      // Calculate age factor
      let ageFactor = 1.0;
      if (ageMin > 18 || ageMax < 80) {
        const midAge = (ageMin + ageMax) / 2;
        if (midAge < 40) ageFactor = 0.7;
        else if (midAge < 60) ageFactor = 0.8;
        else ageFactor = 0.5;
      }

      // Calculate gender factor
      let genderFactor = 1.0;
      if (selectedGender === 'Male') genderFactor = 0.55;
      else if (selectedGender === 'Female') genderFactor = 0.45;
      else if (selectedGender === 'Other') genderFactor = 0.05;

      // Filter data with AND logic
      Object.entries(SAMPLE_DATA.districts).forEach(([districtName, district]) => {
        // District filter (AND condition)
        if (!selectedDistricts.includes('ALL') && !selectedDistricts.includes(districtName)) {
          return;
        }

        let districtTotal = 0;
        let districtHasData = false;

        // Initialize district scheme totals
        if (!districtSchemeTotals[districtName]) {
          districtSchemeTotals[districtName] = {};
        }

        Object.entries(district.taluks || {}).forEach(([talukName, taluk]) => {
          // Taluk filter (AND condition)
          if (!selectedTaluks.includes('ALL') && !selectedTaluks.includes(talukName)) {
            return;
          }

          Object.entries(taluk.villages || {}).forEach(([villageName, village]) => {
            // Village filter (AND condition)
            if (!selectedVillages.includes('ALL') && !selectedVillages.includes(villageName)) {
              return;
            }

            // Shop filter (AND condition)
            let shopMatch = selectedShops.includes('ALL') ||
              village.shops.some(shop => selectedShops.includes(shop));

            if (!shopMatch) {
              return;
            }

            // Process schemes with AND condition
            Object.entries(village.schemes).forEach(([schemeName, schemeCount]) => {
              // Scheme filter (AND condition)
              if (!selectedSchemes.includes('ALL') && !selectedSchemes.includes(schemeName)) {
                return;
              }

              // ALL CONDITIONS MET - Calculate filtered count
              let filteredCount = Math.round(schemeCount * genderFactor * ageFactor * dateFactor);

              if (filteredCount > 0) {
                // Add to district scheme totals
                districtSchemeTotals[districtName][schemeName] =
                  (districtSchemeTotals[districtName][schemeName] || 0) + filteredCount;

                districtTotal += filteredCount;
                districtHasData = true;

                // Update shop totals
                village.shops.forEach(shop => {
                  if (selectedShops.includes('ALL') || selectedShops.includes(shop)) {
                    const shopCount = Math.round((schemeCount / village.shops.length) * genderFactor * ageFactor * dateFactor);
                    shopTotals[shop] = (shopTotals[shop] || 0) + shopCount;
                  }
                });
              }
            });
          });
        });

        if (districtHasData) {
          districtTotals[districtName] = districtTotal;
          totalBeneficiaries += districtTotal;

          // Add to monthly trend
          district.monthlyTrend.forEach((count, index) => {
            monthlyTrendData[index] += Math.round(count * (districtTotal / district.totalBeneficiaries) * dateFactor);
          });
        } else {
          // Remove district from scheme totals if no data
          delete districtSchemeTotals[districtName];
        }
      });

      return {
        districtTotals,
        districtSchemeTotals, // Changed from schemeTotals
        shopTotals,
        totalBeneficiaries,
        monthlyTrendData
      };
    }

    function applyFilters() {
      updateActiveFiltersDisplay();

      const {
        districtTotals,
        districtSchemeTotals, // Changed from schemeTotals
        shopTotals,
        totalBeneficiaries,
        monthlyTrendData
      } = filterData();

      // Update Pie Chart - Show District Distribution with AND condition results
      const pieData = Object.entries(districtTotals).map(([district, count]) => ({
        name: district,
        value: count
      })).sort((a, b) => b.value - a.value);

      pieChart.setOption({
        tooltip: {
          trigger: 'item',
          formatter: function (params) {
            const percentage = totalBeneficiaries > 0 ? ((params.value / totalBeneficiaries) * 100).toFixed(1) : '0.0';
            return `<b>${params.name}</b><br/>Beneficiaries: ${params.value.toLocaleString()}<br/>Percentage: ${percentage}%`;
          }
        },
        legend: {
          orient: 'vertical',
          left: 'left',
          top: 'center',
          textStyle: { fontSize: 12 }
        },
        series: [{
          name: 'Beneficiary Distribution',
          type: 'pie',
          radius: ['30%', '70%'],
          avoidLabelOverlap: false,
          itemStyle: {
            borderRadius: 10,
            borderColor: '#fff',
            borderWidth: 2
          },
          label: {
            show: true,
            formatter: function (params) {
              const count = params.value.toLocaleString();
              const percentage = totalBeneficiaries > 0 ? ((params.value / totalBeneficiaries) * 100).toFixed(1) : '0.0';
              return `${params.name}\n${count} (${percentage}%)`;
            },
            fontSize: 11,
            fontWeight: 'normal',
            color: '#333',
            lineHeight: 16
          },
          labelLine: { length: 10, length2: 20, smooth: true },
          emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } },
          data: pieData
        }],
        color: ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4']
      });

      // Update Bar Chart - Show District-wise Scheme Breakdown (Stacked Bar Chart)
      const districts = Object.keys(districtSchemeTotals);
      const allSchemes = new Set();

      // Collect all unique schemes from all districts
      Object.values(districtSchemeTotals).forEach(schemeData => {
        Object.keys(schemeData).forEach(scheme => {
          allSchemes.add(scheme);
        });
      });

      const schemes = Array.from(allSchemes);

      // Prepare series data for each scheme
      const seriesData = schemes.map(scheme => {
        return {
          name: scheme,
          type: 'bar',
          stack: 'total',
          emphasis: { focus: 'series' },
          data: districts.map(district => {
            return districtSchemeTotals[district][scheme] || 0;
          })
        };
      });

      barChart.setOption({
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          formatter: function (params) {
            let tooltip = `<b>${params[0].name}</b><br/>`;
            let total = 0;

            params.forEach(param => {
              if (param.value > 0) {
                tooltip += `${param.seriesName}: ${param.value.toLocaleString()}<br/>`;
                total += param.value;
              }
            });

            tooltip += `<hr style="margin: 5px 0"/>`;
            tooltip += `<b>Total: ${total.toLocaleString()}</b>`;

            return tooltip;
          }
        },
        legend: {
          data: schemes,
          top: 'top',
          textStyle: { fontSize: 11 }
        },
        grid: { left: '3%', right: '4%', top: '15%', bottom: '10%', containLabel: true },
        xAxis: {
          type: 'category',
          data: districts,
          axisLabel: {
            interval: 0,
            rotate: districts.length > 3 ? 45 : 0,
            fontSize: 11,
            margin: districts.length > 3 ? 15 : 0
          }
        },
        yAxis: {
          type: 'value',
          name: 'Beneficiaries',
          nameTextStyle: { fontSize: 12 }
        },
        series: seriesData,
        color: ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4']
      });

      // Update Shop Performance Chart
      const shopData = Object.entries(shopTotals)
        .map(([shop, total]) => ({ name: shop, value: total }))
        .sort((a, b) => b.value - a.value)
        .slice(0, 10);

      shopChart.setOption({
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          formatter: function (params) {
            return `<b>${params[0].name}</b><br/>Beneficiaries: ${params[0].value.toLocaleString()}`;
          }
        },
        grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
        xAxis: {
          type: 'category',
          data: shopData.map(item => item.name),
          axisLabel: {
            interval: 0,
            rotate: 45,
            fontSize: 10,
            margin: 15
          }
        },
        yAxis: { type: 'value', name: 'Beneficiaries' },
        series: [{
          type: 'bar',
          data: shopData.map(item => item.value),
          itemStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: '#83bff6' },
              { offset: 0.5, color: '#188df0' },
              { offset: 1, color: '#188df0' }
            ])
          },
          label: {
            show: true,
            position: 'top',
            formatter: '{c}',
            fontSize: 10
          }
        }]
      });

      // Update Monthly Trend Chart
      trendChart.setOption({
        tooltip: {
          trigger: 'axis',
          formatter: function (params) {
            return `<b>${params[0].name}</b><br/>New Beneficiaries: ${params[0].value.toLocaleString()}`;
          }
        },
        grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
        xAxis: { type: 'category', data: SAMPLE_DATA.months },
        yAxis: { type: 'value', name: 'Beneficiaries' },
        series: [{
          name: 'Monthly Enrollment',
          type: 'line',
          data: monthlyTrendData,
          smooth: true,
          lineStyle: { width: 3, color: '#ff6b6b' },
          itemStyle: { color: '#ff6b6b' },
          areaStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: 'rgba(255, 107, 107, 0.5)' },
              { offset: 1, color: 'rgba(255, 107, 107, 0.1)' }
            ])
          },
          markPoint: {
            data: [
              { type: 'max', name: 'Max' },
              { type: 'min', name: 'Min' }
            ]
          },
          markLine: {
            data: [{ type: 'average', name: 'Average' }]
          }
        }]
      });
    }

    function resetAll() {
      // Reset all dropdowns to "ALL" option (selected)
      $('#district').val(['ALL']).trigger('change');
      $('#taluk').val(['ALL']).trigger('change');
      $('#village').val(['ALL']).trigger('change');
      $('#shop').val(['ALL']).trigger('change');
      $('#scheme').val(['ALL']).trigger('change');
      $('#gender').val('ALL');
      $('#ageMin').val(18);
      $('#ageMax').val(80);

      // Reset dates to default
      const today = new Date();
      const lastMonth = new Date();
      lastMonth.setMonth(today.getMonth() - 1);
      $('#dateFrom').val(lastMonth.toISOString().split('T')[0]);
      $('#dateTo').val(today.toISOString().split('T')[0]);

      // Apply filters after reset
      setTimeout(() => {
        applyFilters();
      }, 100);
    }

    // Export Functions
    function exportCSV(type) {
      let rows = "";

      if (type === 'pie') {
        rows = "District,Beneficiaries,Percentage\n";
        const option = pieChart.getOption();
        const total = option.series[0].data.reduce((sum, item) => sum + item.value, 0);
        option.series[0].data.forEach(item => {
          const percentage = total > 0 ? ((item.value / total) * 100).toFixed(2) : '0.00';
          rows += `${item.name},${item.value},${percentage}%\n`;
        });
      } else if (type === 'bar') {
        // Export for district-wise scheme breakdown
        const option = barChart.getOption();
        const districts = option.xAxis[0].data;
        const schemes = option.legend[0].data;

        // Create header
        rows = "District," + schemes.join(",") + ",Total\n";

        // Create data rows
        districts.forEach((district, districtIndex) => {
          let row = district;
          let districtTotal = 0;

          schemes.forEach((scheme, schemeIndex) => {
            const value = option.series[schemeIndex].data[districtIndex] || 0;
            row += `,${value}`;
            districtTotal += value;
          });

          row += `,${districtTotal}\n`;
          rows += row;
        });
      } else if (type === 'shop') {
        rows = "Shop,Beneficiaries\n";
        const option = shopChart.getOption();
        option.series[0].data.forEach((value, index) => {
          rows += `${option.xAxis[0].data[index]},${value}\n`;
        });
      } else if (type === 'trend') {
        rows = "Month,New Beneficiaries\n";
        const option = trendChart.getOption();
        option.series[0].data.forEach((value, index) => {
          rows += `${option.xAxis[0].data[index]},${value}\n`;
        });
      }

      let blob = new Blob([rows]);
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${type}_export.csv`;
      a.click();
    }

    function exportPDF(type) {
      let el;
      switch (type) {
        case 'pie': el = document.getElementById('pie'); break;
        case 'bar': el = document.getElementById('bar'); break;
        default: el = document.getElementById('pie');
      }

      html2canvas(el).then(c => {
        let pdf = new jspdf.jsPDF();
        pdf.addImage(c.toDataURL(), "PNG", 10, 10, 180, 120);
        pdf.save(`${type}_chart.pdf`);
      });
    }

    // Initialize charts on window resize
    window.addEventListener('resize', function () {
      pieChart.resize();
      barChart.resize();
      shopChart.resize();
      trendChart.resize();
    });

    // Sidebar functions
    function toggleSidebar() {
      $("#sidebar").toggleClass("collapsed");
      $("#main").toggleClass("collapsed");
      setTimeout(() => {
        pieChart.resize();
        barChart.resize();
        shopChart.resize();
        trendChart.resize();
      }, 300);
    }

    if (window.innerWidth <= 768) {
      document.getElementById("sidebar").classList.add("collapsed");
      document.getElementById("main").classList.add("collapsed");
    }

    document.addEventListener("click", function (e) {
      if (window.innerWidth <= 768) {
        let sidebar = document.getElementById("sidebar");
        let btn = document.querySelector(".bi-list");

        if (!sidebar.contains(e.target) && !btn.contains(e.target)) {
          sidebar.classList.add("collapsed");
        }
      }
    });
  </script>
</body>

</html>