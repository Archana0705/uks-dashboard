<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>UKS Analytics - Dream Scheme</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background: #f5f7fb;
            font-family: Inter, system-ui;
        }

        .app-header {
            background: linear-gradient(135deg, #ffffff, #f8f9ff);
            border-bottom: 1px solid #eee;
            height: 64px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2000;
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: .3px;
        }

        .filter-bar {
            position: sticky;
            top: 64px;
            background: white;
            z-index: 9;
            border-radius: 14px;
            margin: 5px 12px;
            padding: 10px !important;
        }

        .filter-bar label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
            margin-bottom: 4px !important;
        }

        .form-select,
        .form-range,
        .form-control {
            border-radius: 10px;
            padding: 6px 12px !important;
            font-size: 14px !important;
        }

        .card {
            border-radius: 18px;
            border: none;
            background: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .06);
            transition: .25s;
        }

        .card:hover {
            box-shadow: 0 12px 35px rgba(0, 0, 0, .1);
        }

        .chart-actions {
            opacity: 0;
            transition: .2s;
        }

        .card:hover .chart-actions {
            opacity: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            border: none;
            border-radius: 10px;
            padding: 8px 16px !important;
            font-size: 14px;
        }

        .btn-outline-secondary {
            border-radius: 10px;
            padding: 6px 12px !important;
        }

        .app-wrapper {
            display: flex;
        }

        .sidebar {
            position: fixed;
            top: 64px;
            left: 0;
            width: 240px;
            height: calc(100vh - 64px);
            background: linear-gradient(180deg, #f9fafc, #f2f4f9);
            border-right: 1px solid #eee;
            transition: transform .3s ease;
            z-index: 2000;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li.active {
            background: linear-gradient(135deg, #5b5df0, #7b7dff);
            color: white;
            box-shadow: 0 6px 16px rgba(91, 93, 240, .35);
        }

        .sidebar-menu li a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            text-decoration: none;
            color: #444;
            font-size: 14px;
        }

        .sidebar-menu li a:hover {
            background: #f3f5ff;
            color: #4f46e5;
        }

        .main-content {
            margin-left: 240px;
            width: 100%;
            transition: .3s;
            margin-top: 64px;
        }

        .main-content.collapsed {
            margin-left: 0;
        }

        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }

        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px !important;
            margin-bottom: 10px !important;
            border-left: 4px solid;
        }

        .geographic-filter {
            border-left-color: #4f46e5;
        }

        .demographic-filter {
            border-left-color: #10b981;
        }

        .scheme-filter {
            border-left-color: #f59e0b;
        }

        .active-filter-badge {
            background: #4f46e5;
            color: white;
            border-radius: 12px;
            padding: 3px 10px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }

        .logic-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px !important;
        }

        .logic-toggle .btn-group {
            width: 120px;
        }

        .filter-group-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px !important;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .scheme-description-card {
            background: linear-gradient(135deg, #f8f9ff, #ffffff);
            border: 1px solid #e6e8ff;
            transition: transform 0.2s;
            border-radius: 10px;
        }

        .scheme-description-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .scheme-logic-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px !important;
        }

        /* Reduced spacing classes */
        .row.g-2 {
            --bs-gutter-x: 0.5rem;
            --bs-gutter-y: 0.5rem;
        }

        .row.g-3 {
            --bs-gutter-x: 1rem;
            --bs-gutter-y: 1rem;
        }

        .mb-1 {
            margin-bottom: 0.25rem !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .mt-1 {
            margin-top: 0.25rem !important;
        }

        .mt-2 {
            margin-top: 0.5rem !important;
        }

        .mt-3 {
            margin-top: 1rem !important;
        }

        .py-1 {
            padding-top: 0.25rem !important;
            padding-bottom: 0.25rem !important;
        }

        .py-2 {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }

        .py-3 {
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 240px;
            }

            .sidebar.open {
                transform: translateX(0);
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, .25);
            }

            .main-content {
                margin-left: 0 !important;
            }

            .filterWraps {
                width: auto !important;
                margin-left: 15px;
                margin-top: 10px;
            }

            .nomob {
                display: none !important;
            }

            .filter-bar {
                margin: 5px 8px !important;
                padding: 8px !important;
            }

            .filter-section {
                padding: 10px !important;
            }
        }

        @media (max-width: 992px) {
            .chart-row {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            h5 {
                font-size: 16px;
            }

            .app-title {
                font-size: 16px;
            }

            .filter-bar {
                margin: 5px 4px !important;
                padding: 6px !important;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg app-header px-4">
        <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-light" onclick="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <img src="assets/img/tn_logo.png" height="36" class="me-2">
            <span class="ms-2 fw-bold">UKS Analytics</span>
        </div>
        <div class="ms-auto d-flex align-items-center gap-3 nomob">
            <div class="dropdown">
                <button class="btn btn-link text-decoration-none d-flex align-items-center gap-2"
                    data-bs-toggle="dropdown">
                    <span class="text-muted">Welcome, <b>User Name</b></span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i> Profile</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-box-arrow-right me-2"></i>
                            Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="app-wrapper">
        <div id="sidebar" class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="index.html"><i class="bi bi-speedometer2"></i> <span>Dashboard</span></a></li>
                <li><a href="#"><i class="bi bi-people"></i> <span>Beneficiary</span></a></li>
                <li><a href="#"><i class="bi bi-card-checklist"></i> <span>Beneficial Scheme</span></a></li>
                <li class="active"><a href="dreamscheme.html"><i class="bi bi-stars"></i> <span>Dream Scheme</span></a>
                </li>
            </ul>
        </div>

        <div id="main" class="main-content">
            <button class="btn btn-outline-primary w-100 d-md-none filterWraps" data-bs-toggle="collapse"
                data-bs-target="#mobileFilters">
                <i class="bi bi-funnel"></i> Filters
            </button>

            <div id="mobileFilters" class="collapse d-md-block">
                <div class="filter-bar shadow-sm">
                    <!-- Logic Toggle -->
                    <div class="logic-toggle">
                        <!-- <span class="filter-group-title">Overall Filter Logic:</span> -->
                    </div>

                    <!-- Geographic Filters -->
                    <div class="filter-section geographic-filter">
                        <div class="filter-group-title">
                            <i class="bi bi-geo-alt"></i>
                            Geographic Filters
                        </div>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3">
                                <label>District</label>
                                <select id="district" class="form-select">
                                    <option value="ALL" selected>Loading districts...</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label>Taluk</label>
                                <select id="taluk" class="form-select">
                                    <option value="ALL" selected>Select Taluk</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label>Village</label>
                                <select id="village" class="form-select">
                                    <option value="ALL" selected>Select Village</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label>Shop/Outlet</label>
                                <select id="shop" class="form-select">
                                    <option value="ALL" selected>All Shops</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Demographic Filters -->
                    <!-- <div class="filter-section demographic-filter">
                        <div class="filter-group-title">
                            <i class="bi bi-people"></i>
                            Demographic Filters
                        </div>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3">
                                <label>Gender</label>
                                <select id="gender" class="form-select">
                                    <option value="ALL" selected>All Genders</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label>Age Range</label>
                                <div class="d-flex gap-2">
                                    <input type="number" id="ageMin" class="form-control" placeholder="Min" min="18"
                                        max="100" value="18">
                                    <input type="number" id="ageMax" class="form-control" placeholder="Max" min="18"
                                        max="100" value="80">
                                </div>
                            </div>

                            <div class="col-md-3">
                                <label>Date Range</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="date" id="dateFrom" class="form-control form-control-sm"
                                        value="2024-01-01">
                                    <span class="text-muted">to</span>
                                    <input type="date" id="dateTo" class="form-control form-control-sm"
                                        value="2024-12-31">
                                </div>
                            </div>
                        </div>
                    </div> -->

                    <!-- Scheme Filters - Top 3 -->
                    <div class="filter-section scheme-filter">
                        <div class="filter-group-title">
                            <i class="bi bi-card-checklist"></i>
                            Scheme Filters
                        </div>

                        <!-- Scheme Logic Toggle -->
                        <div class="scheme-logic-toggle">
                            <span class="filter-group-title" style="margin-bottom: 0;">Scheme Logic:</span>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="schemeLogic" id="schemeLogicAND"
                                    autocomplete="off" checked onclick="updateSchemeLogic('AND')">
                                <label class="btn btn-outline-warning" for="schemeLogicAND">AND</label>

                                <input type="radio" class="btn-check" name="schemeLogic" id="schemeLogicOR"
                                    autocomplete="off" onclick="updateSchemeLogic('OR')">
                                <label class="btn btn-outline-warning" for="schemeLogicOR">OR</label>
                            </div>
                            <span id="schemeLogicIndicator" class="badge bg-warning">AND Logic</span>
                        </div>

                        <div class="row g-2 align-items-end mt-2">
                            <!-- Scheme Category 1 -->
                            <div class="col-md-4">
                                <label>Scheme Category 1</label>
                                <select id="schemeCategory1" class="form-select scheme-category-select">
                                    <option value="ALL" selected>Select Category</option>
                                    <option value="Food Security">Food Security</option>
                                    <option value="Cash Transfer">Cash Transfer</option>
                                    <option value="Agriculture">Agriculture</option>
                                    <option value="Employment">Employment</option>
                                </select>
                            </div>

                            <!-- Scheme Category 2 -->
                            <div class="col-md-4">
                                <label>Scheme Category 2</label>
                                <select id="schemeCategory2" class="form-select scheme-category-select">
                                    <option value="ALL" selected>Select Category</option>
                                    <option value="Food Security">Food Security</option>
                                    <option value="Cash Transfer">Cash Transfer</option>
                                    <option value="Agriculture">Agriculture</option>
                                    <option value="Employment">Employment</option>
                                </select>
                            </div>

                            <!-- Scheme Category 3 -->
                            <div class="col-md-4">
                                <label>Scheme Category 3</label>
                                <select id="schemeCategory3" class="form-select scheme-category-select">
                                    <option value="ALL" selected>Select Category</option>
                                    <option value="Food Security">Food Security</option>
                                    <option value="Cash Transfer">Cash Transfer</option>
                                    <option value="Agriculture">Agriculture</option>
                                    <option value="Employment">Employment</option>
                                </select>
                            </div>
                        </div>

                        <!-- Scheme Lists Row -->
                        <div class="row g-2 align-items-end mt-2">
                            <!-- Scheme List 1 -->
                            <div class="col-md-4">
                                <label>Scheme 1</label>
                                <select id="schemeList1" class="form-select scheme-list-select">
                                    <option value="ALL" selected>All Schemes</option>
                                </select>
                            </div>

                            <!-- Scheme List 2 -->
                            <div class="col-md-4">
                                <label>Scheme 2</label>
                                <select id="schemeList2" class="form-select scheme-list-select">
                                    <option value="ALL" selected>All Schemes</option>
                                </select>
                            </div>

                            <!-- Scheme List 3 -->
                            <div class="col-md-4">
                                <label>Scheme 3</label>
                                <select id="schemeList3" class="form-select scheme-list-select">
                                    <option value="ALL" selected>All Schemes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-2">
                        <div class="col-md-8">
                            <div id="activeFiltersDisplay" class="d-flex flex-wrap gap-2"></div>
                        </div>
                        <div class="col-md-4 d-flex gap-2 justify-content-end">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="bi bi-funnel me-2"></i> Apply Filters
                            </button>
                            <button class="btn btn-outline-danger" onclick="resetAll()">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid mt-3">
                <div class="row">
                    <!-- Left Column - Charts -->
                    <div class="col-lg-8">
                        <!-- Summary Cards -->
                        <div class="row g-2 mb-3">
                            <div class="col-md-3">
                                <div class="card p-2 shadow">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-people text-primary fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-1">Total Families</h6>
                                            <h4 id="totalFamiliesCount" class="mb-0">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="col-md-3">
                                <div class="card p-2 shadow">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-success bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-check-circle text-success fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-1">Active Families</h6>
                                            <h4 id="activeFamiliesCount" class="mb-0">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div> -->
                            <div class="col-md-3">
                                <div class="card p-2 shadow">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-warning bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-clock text-warning fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-1">Total Districts</h6>
                                            <h4 id="totalDistrictsCount" class="mb-0">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card p-2 shadow">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-info bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-shop text-info fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-1">Total Villages</h6>
                                            <h4 id="totalVillagesCount" class="mb-0">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Geographic Distribution Chart -->
                        <div class="row g-2">
                            <div class="col-lg-12">
                                <div class="card p-2 shadow">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="d-flex align-items-center gap-2 mb-0">
                                            <i class="bi bi-geo-alt-fill text-primary"></i>
                                            Geographic Distribution
                                            <span id="filterSummary" class="text-muted fs-6 ms-2"></span>
                                        </h5>
                                        <div class="chart-actions">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV()">
                                                <i class="bi bi-file-earmark-excel"></i> CSV
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="exportPDF()">
                                                <i class="bi bi-file-earmark-pdf"></i> PDF
                                            </button>
                                        </div>
                                    </div>
                                    <div id="pie" style="height:500px"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Scheme Descriptions -->
                    <div class="col-lg-4">
                        <div class="card p-2 shadow h-100" style="position: sticky; top: 100px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="d-flex align-items-center gap-2 mb-0">
                                    <i class="bi bi-stars text-warning"></i>
                                    Dream Scheme Descriptions
                                </h5>
                            </div>

                            <div id="schemeDescriptions">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-info-circle fs-1 mb-2 d-block"></i>
                                    <p>Select dream schemes to view descriptions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/js/global.js"></script>
    <script src="assets/js/crypto-js.min.js"></script>
    <script src="assets/js/encrypt_decrypt.js"></script>

    <!-- <script>
        $(document).ready(function () {
            console.log("Page loaded. Initializing...");

            // Initialize all data from APIs
            initializeAllData();

            // Set up event listeners
            setupEventListeners();
        });

        // ================== GLOBAL VARIABLES ==================

        // Global variables for filter logic
        let filterLogic = 'AND';
        let schemeLogic = 'AND';

        // Store data from APIs
        let API_DATA = {
            // Geographic data
            districts: [],
            allTaluks: [],
            allVillages: [],
            allShops: [],
            filteredTaluks: [],
            filteredVillages: [],
            filteredShops: [],

            // Scheme data
            schemeCategories: [],
            allSchemes: [],
            filteredSchemesByCategory: {},

            // Chart data
            filteredData: [],
            currentChartData: null
        };

        // API endpoints configuration
        const API_CONFIG = {
            baseUrl: 'https://tngis.tnega.org/state_scholarship_portal_api/sfdb_survey/api/v1/dashboard2/',
            endpoints: {
                dynamic_input: 'dynamic_input',
                get_districts: 'get_districts'
            }
        };

        // Initialize charts
        let pieChart = echarts.init(document.getElementById("pie"));

        // ================== GEOGRAPHIC API FUNCTIONS ==================

        // Load districts
        async function loadDistricts() {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_master_district",
                    "selected_columns": ["district_id", "district_name"],
                    "filter_conditions": {},
                    "sort_columns": {},
                    "limit_rows": 50,
                    "offset_rows": 0
                };

                console.log("Loading districts...");
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let districtList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            districtList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            districtList = decryptedData;
                        }
                    }

                    if (Array.isArray(districtList)) {
                        API_DATA.districts = districtList;
                        console.log(`Loaded ${districtList.length} districts`);
                        return districtList;
                    } else {
                        console.error("District list is not an array:", districtList);
                        API_DATA.districts = [];
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1");
                    API_DATA.districts = [];
                    return [];
                }
            } catch (error) {
                console.error('Error loading districts:', error);
                API_DATA.districts = [];
                return [];
            }
        }

        // Load taluks for a specific district
        async function loadTaluks(districtId) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_master_taluk",
                    "selected_columns": ["district_id", "taluk_id", "taluk_name"],
                    "filter_conditions": {
                        "district_id": districtId
                    },
                    "sort_columns": {},
                    "limit_rows": 100,
                    "offset_rows": 0
                };

                console.log(`Loading taluks for district ${districtId}...`);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let talukList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            talukList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            talukList = decryptedData;
                        }
                    }

                    if (Array.isArray(talukList)) {
                        // Store in allTaluks for caching
                        API_DATA.allTaluks = API_DATA.allTaluks.concat(talukList.filter(t =>
                            !API_DATA.allTaluks.some(existing => existing.taluk_id === t.taluk_id)
                        ));

                        // Filter for current district
                        API_DATA.filteredTaluks = talukList;
                        console.log(`Loaded ${talukList.length} taluks for district ${districtId}`);
                        return talukList;
                    } else {
                        console.error("Taluk list is not an array:", talukList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for taluks");
                    return [];
                }
            } catch (error) {
                console.error('Error loading taluks:', error);
                return [];
            }
        }

        // Load villages for a specific district and taluk
        async function loadVillages(districtId, talukId) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_village_master",
                    "selected_columns": ["district_id", "taluk_id", "village_id", "village_name"],
                    "filter_conditions": {
                        "district_id": districtId,
                        "taluk_id": talukId
                    },
                    "sort_columns": {},
                    "limit_rows": 200,
                    "offset_rows": 0
                };

                console.log(`Loading villages for district ${districtId}, taluk ${talukId}...`);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let villageList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            villageList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            villageList = decryptedData;
                        }
                    }

                    if (Array.isArray(villageList)) {
                        // Store in allVillages for caching
                        API_DATA.allVillages = API_DATA.allVillages.concat(villageList.filter(v =>
                            !API_DATA.allVillages.some(existing => existing.village_id === v.village_id)
                        ));

                        // Filter for current district and taluk
                        API_DATA.filteredVillages = villageList;
                        console.log(`Loaded ${villageList.length} villages`);
                        return villageList;
                    } else {
                        console.error("Village list is not an array:", villageList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for villages");
                    return [];
                }
            } catch (error) {
                console.error('Error loading villages:', error);
                return [];
            }
        }

        // Load shops for a specific district, taluk, and village
        async function loadShops(districtId, talukId, villageId) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_master",
                    "selected_columns": ["id", "shop_code"],
                    "filter_conditions": {
                        "district_id": districtId,
                        "taluk_id": talukId,
                        "village_id": villageId
                    },
                    "sort_columns": {},
                    "limit_rows": 200,
                    "offset_rows": 0
                };

                console.log(`Loading shops for district ${districtId}, taluk ${talukId}, village ${villageId}...`);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let shopList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            shopList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            shopList = decryptedData;
                        }
                    }

                    if (Array.isArray(shopList)) {
                        // Store in allShops for caching
                        API_DATA.allShops = API_DATA.allShops.concat(shopList.filter(s =>
                            !API_DATA.allShops.some(existing => existing.id === s.id)
                        ));

                        // Filter for current location
                        API_DATA.filteredShops = shopList;
                        console.log(`Loaded ${shopList.length} shops`);
                        return shopList;
                    } else {
                        console.error("Shop list is not an array:", shopList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for shops");
                    return [];
                }
            } catch (error) {
                console.error('Error loading shops:', error);
                return [];
            }
        }

        // ================== SCHEME API FUNCTIONS ==================

        // Load scheme categories
        async function loadSchemeCategories() {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "scheme_type_master",
                    "selected_columns": ["id", "scheme_type", "scheme_category"],
                    "filter_conditions": {},
                    "sort_columns": {
                        "scheme_category": "asc"
                    },
                    "limit_rows": 100,
                    "offset_rows": 0
                };

                console.log("Loading scheme categories...", payload);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let categoryList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            categoryList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            categoryList = decryptedData;
                        }
                    }

                    if (Array.isArray(categoryList)) {
                        API_DATA.schemeCategories = categoryList;
                        console.log(`Loaded ${categoryList.length} scheme categories`);
                        return categoryList;
                    } else {
                        console.error("Category list is not an array:", categoryList);
                        API_DATA.schemeCategories = [];
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for scheme categories");
                    API_DATA.schemeCategories = [];
                    return [];
                }
            } catch (error) {
                console.error('Error loading scheme categories:', error);
                API_DATA.schemeCategories = [];
                return [];
            }
        }

        // Load schemes for a specific category
        async function loadSchemes(categoryType) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "schemes",
                    "selected_columns": ["scheme_id", "scheme_name", "schemetype"],
                    "filter_conditions": {
                        "schemetype": categoryType
                    },
                    "sort_columns": {
                        "scheme_name": "asc"
                    },
                    "limit_rows": 200,
                    "offset_rows": 0
                };

                console.log(`Loading schemes for category type ${categoryType}...`, payload);

                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let schemeList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            schemeList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            schemeList = decryptedData;
                        }
                    }

                    if (Array.isArray(schemeList)) {
                        // Store in allSchemes for caching
                        API_DATA.allSchemes = API_DATA.allSchemes.concat(schemeList.filter(s =>
                            !API_DATA.allSchemes.some(existing => existing.scheme_id === s.scheme_id)
                        ));

                        // Cache schemes by category
                        if (!API_DATA.filteredSchemesByCategory[categoryType]) {
                            API_DATA.filteredSchemesByCategory[categoryType] = schemeList;
                        }

                        console.log(`Loaded ${schemeList.length} schemes for category ${categoryType}`);
                        return schemeList;
                    } else {
                        console.error("Scheme list is not an array:", schemeList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for schemes");
                    return [];
                }
            } catch (error) {
                console.error('Error loading schemes:', error);
                return [];
            }
        }

        // Load all schemes (for "ALL" category)
        async function loadAllSchemes() {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "schemes",
                    "selected_columns": ["scheme_id", "scheme_name", "schemetype"],
                    "filter_conditions": {},
                    "sort_columns": {
                        "scheme_name": "asc"
                    },
                    "limit_rows": 500,
                    "offset_rows": 0
                };

                console.log("Loading all schemes...");
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let schemeList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            schemeList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            schemeList = decryptedData;
                        }
                    }

                    if (Array.isArray(schemeList)) {
                        API_DATA.allSchemes = schemeList;
                        console.log(`Loaded ${schemeList.length} schemes`);
                        return schemeList;
                    } else {
                        console.error("Scheme list is not an array:", schemeList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for all schemes");
                    return [];
                }
            } catch (error) {
                console.error('Error loading all schemes:', error);
                return [];
            }
        }

        // ================== MAIN FILTER API FUNCTION WITH PROPER AND/OR LOGIC ==================

        // Load filtered data from analytics_suggestionform_smple
        async function loadFilteredData(filters) {
            try {
                // Build filter conditions - Start with geographic filters
                let filterConditions = {};

                // Geographic filters - only add if not 'ALL'
                if (filters.district && filters.district !== 'ALL') {
                    filterConditions.district_id = filters.district;
                }
                if (filters.taluk && filters.taluk !== 'ALL') {
                    filterConditions.taluk_id = filters.taluk;
                }
                if (filters.village && filters.village !== 'ALL') {
                    filterConditions.village_id = filters.village;
                }
                if (filters.shop && filters.shop !== 'ALL') {
                    const shopOption = $('#shop option:selected');
                    if (shopOption.length > 0 && shopOption.text()) {
                        filterConditions.shopcode = shopOption.text();
                    }
                }

                // Gender filter (if applicable)
                if (filters.gender && filters.gender !== 'ALL') {
                    // Add if your table has gender column
                    // filterConditions.gender = filters.gender;
                }

                // Collect scheme filters (type_id values)
                const schemeFilters = [];
                for (let i = 1; i <= 3; i++) {
                    const schemeId = filters[`schemeList${i}`];
                    if (schemeId && schemeId !== 'ALL') {
                        schemeFilters.push(schemeId);
                    }
                }

                console.log("Scheme filters found:", schemeFilters);
                console.log("Scheme logic:", schemeLogic);

                // FIXED: Proper AND/OR logic handling for multiple schemes
                if (schemeFilters.length > 0) {
                    if (schemeLogic === 'OR') {
                        // OR logic: match ANY of the selected schemes
                        // Create OR conditions array
                        const orConditions = schemeFilters.map(id => ({ type_id: id }));

                        if (Object.keys(filterConditions).length === 0) {
                            // If no other filters, use $or directly
                            filterConditions.$or = orConditions;
                        } else {
                            // If we have other filters, we need to combine with AND
                            // Create a new filter that combines geographic filters with OR scheme filters
                            const combinedFilter = {
                                $and: [
                                    filterConditions, // Geographic filters
                                    { $or: orConditions } // OR scheme filters
                                ]
                            };
                            filterConditions = combinedFilter;
                        }
                    } else {
                        // AND logic: match ALL selected schemes
                        // For AND logic across multiple schemes, we need multiple queries or complex logic
                        // Since the API might not support true AND across multiple type_id,
                        // we'll fetch data for each scheme and then intersect the results

                        // For now, we'll use the first scheme for the initial query
                        // Then we'll filter results to ensure all selected schemes are present
                        filterConditions.type_id = schemeFilters[0];
                    }
                }

                console.log("Final filter conditions for API:", filterConditions);

                // First API call with initial filters
                const payload = {
                    "action": "select",
                    "_table_name": "analytics.analytics_suggestionform_smple",
                    "selected_columns": [
                        "id", "taluk_id", "ufcno", "type_id", "schemetype_id",
                        "suggestion_remarks", "active", "created_by", "created_ts",
                        "updated_by", "updated_ts", "shopcode", "subscheme_id",
                        "type", "scheme_name", "district_id", "district_name",
                        "taluk_name", "village_id", "village_name"
                    ],
                    "filter_conditions": filterConditions,
                    "sort_columns": {
                        "district_name": "asc",
                        "taluk_name": "asc"
                    },
                    "limit_rows": 1000,
                    "offset_rows": 0
                };

                console.log("Loading filtered data with payload:", payload);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let filteredList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            filteredList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing filtered data:", parseError);
                            filteredList = decryptedData;
                        }
                    }

                    if (Array.isArray(filteredList)) {
                        // FIXED: Apply AND logic filtering if needed
                        if (schemeLogic === 'AND' && schemeFilters.length > 1) {
                            console.log(`Applying AND logic for ${schemeFilters.length} schemes`);

                            // For AND logic, we need to ensure all selected schemes are present
                            // Since we can't do this in a single API query, we'll do it client-side
                            // by checking if the same ufcno (family) has all selected schemes

                            // Group by ufcno (family identifier)
                            const familiesByUfcno = {};

                            filteredList.forEach(item => {
                                const ufcno = item.ufcno;
                                if (!ufcno) return;

                                if (!familiesByUfcno[ufcno]) {
                                    familiesByUfcno[ufcno] = {
                                        familyData: item,
                                        schemeIds: new Set()
                                    };
                                }

                                // Add the scheme ID for this family
                                familiesByUfcno[ufcno].schemeIds.add(item.type_id);
                            });

                            // Filter families that have ALL selected schemes
                            const andFilteredList = [];
                            Object.values(familiesByUfcno).forEach(family => {
                                const hasAllSchemes = schemeFilters.every(schemeId =>
                                    family.schemeIds.has(parseInt(schemeId))
                                );

                                if (hasAllSchemes) {
                                    andFilteredList.push(family.familyData);
                                }
                            });

                            console.log(`AND logic: ${filteredList.length} records -> ${andFilteredList.length} records after filtering`);
                            filteredList = andFilteredList;
                        }

                        API_DATA.filteredData = filteredList;
                        console.log(`Loaded ${filteredList.length} filtered records`);
                        return filteredList;
                    } else {
                        console.error("Filtered list is not an array:", filteredList);
                        API_DATA.filteredData = [];
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for filtered data");
                    API_DATA.filteredData = [];
                    return [];
                }
            } catch (error) {
                console.error('Error loading filtered data:', error);
                API_DATA.filteredData = [];
                return [];
            }
        }

        // ================== SCHEME DESCRIPTION API FUNCTION ==================

        // Load scheme descriptions
        async function loadSchemeDescriptions(schemeId) {
            try {
                // Build filter conditions
                let filterConditions = {};

                // Always filter by scheme ID
                filterConditions.type_id = schemeId;

                // Apply current geographic filters if set
                const district = $('#district').val();
                const taluk = $('#taluk').val();
                const village = $('#village').val();
                const shop = $('#shop').val();

                if (district && district !== 'ALL') {
                    filterConditions.district_id = district;
                }
                if (taluk && taluk !== 'ALL') {
                    filterConditions.taluk_id = taluk;
                }
                if (village && village !== 'ALL') {
                    filterConditions.village_id = village;
                }
                if (shop && shop !== 'ALL') {
                    const shopOption = $('#shop option:selected');
                    if (shopOption.length > 0 && shopOption.text()) {
                        filterConditions.shopcode = shopOption.text();
                    }
                }

                const payload = {
                    "action": "select",
                    "_table_name": "analytics.analytics_suggestionform_smple",
                    "selected_columns": [
                        "district_name", "taluk_name", "village_name",
                        "suggestion_remarks", "created_ts", "shopcode",
                        "scheme_name", "type", "active"
                    ],
                    "filter_conditions": filterConditions,
                    "sort_columns": {
                        "created_ts": "desc"
                    },
                    "limit_rows": 50,
                    "offset_rows": 0
                };

                console.log("Loading scheme descriptions with payload:", payload);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let descriptions = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            descriptions = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing description data:", parseError);
                            descriptions = decryptedData;
                        }
                    }

                    if (Array.isArray(descriptions)) {
                        console.log(`Loaded ${descriptions.length} descriptions for scheme ${schemeId}`);
                        return descriptions;
                    } else {
                        console.error("Description list is not an array:", descriptions);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for scheme descriptions");
                    return [];
                }
            } catch (error) {
                console.error('Error loading scheme descriptions:', error);
                return [];
            }
        }

        // ================== GENERIC API FUNCTION ==================

        // Generic API request function
        async function makeApiRequest(payload) {
            try {
                const encryptedPayload = encryptData(payload);
                const url = API_CONFIG.baseUrl + API_CONFIG.endpoints.dynamic_input;

                const response = await $.ajax({
                    url: url,
                    type: "POST",
                    dataType: "json",
                    data: { data: encryptedPayload },
                    success: function (response) {
                        console.log("API Success Response:", response);
                        return response;
                    },
                    error: function (xhr, status, error) {
                        console.error("API Error:", {
                            status: status,
                            error: error,
                            responseText: xhr.responseText
                        });
                        throw new Error(`API Error: ${status} - ${error}`);
                    }
                });

                return response;
            } catch (error) {
                console.error('API Request Error:', error);
                throw error;
            }
        }

        // ================== DROPDOWN POPULATION FUNCTIONS ==================

        // Populate district dropdown
        function populateDistrictDropdown() {
            const districtSelect = $('#district');
            districtSelect.empty();

            // Always add "All Districts" option
            districtSelect.append('<option value="ALL" selected>All Districts</option>');

            if (API_DATA.districts && API_DATA.districts.length > 0) {
                console.log(`Populating dropdown with ${API_DATA.districts.length} districts`);

                // Sort districts by name
                const sortedDistricts = [...API_DATA.districts].sort((a, b) => {
                    const nameA = a.district_name || a.name || '';
                    const nameB = b.district_name || b.name || '';
                    return nameA.localeCompare(nameB);
                });

                // Add each district to dropdown
                sortedDistricts.forEach(district => {
                    const districtId = district.district_id || district.id || district.district_code;
                    const districtName = district.district_name || district.name || 'Unknown District';

                    districtSelect.append(`<option value="${districtId}">${districtName}</option>`);
                });

                console.log("District dropdown populated successfully");
            } else {
                console.log("No districts available, showing fallback options");
                districtSelect.append('<option value="ALL" selected>No districts available</option>');
            }
        }

        // Populate taluk dropdown
        function populateTalukDropdown(taluks) {
            const talukSelect = $('#taluk');
            const currentTalukValue = talukSelect.val();

            talukSelect.empty();
            talukSelect.append('<option value="ALL" selected>All Taluks</option>');

            if (taluks && taluks.length > 0) {
                console.log(`Populating dropdown with ${taluks.length} taluks`);

                // Sort taluks by name
                const sortedTaluks = [...taluks].sort((a, b) => {
                    const nameA = a.taluk_name || a.name || '';
                    const nameB = b.taluk_name || b.name || '';
                    return nameA.localeCompare(nameB);
                });

                // Add each taluk to dropdown
                sortedTaluks.forEach(taluk => {
                    const talukId = taluk.taluk_id || taluk.id;
                    const talukName = taluk.taluk_name || taluk.name || 'Unknown Taluk';

                    talukSelect.append(`<option value="${talukId}">${talukName}</option>`);
                });

                // Try to restore previous selection
                if (currentTalukValue !== 'ALL' && taluks.some(t => (t.taluk_id || t.id) == currentTalukValue)) {
                    talukSelect.val(currentTalukValue);
                }

                console.log("Taluk dropdown populated successfully");
            } else {
                console.log("No taluks available for selected district");
                talukSelect.append('<option value="ALL" selected>No taluks available</option>');
            }

            // Enable taluk dropdown
            talukSelect.prop('disabled', false);
        }

        // Populate village dropdown
        function populateVillageDropdown(villages) {
            const villageSelect = $('#village');
            const currentVillageValue = villageSelect.val();

            villageSelect.empty();
            villageSelect.append('<option value="ALL" selected>All Villages</option>');

            if (villages && villages.length > 0) {
                console.log(`Populating dropdown with ${villages.length} villages`);

                // Sort villages by name
                const sortedVillages = [...villages].sort((a, b) => {
                    const nameA = a.village_name || a.name || '';
                    const nameB = b.village_name || b.name || '';
                    return nameA.localeCompare(nameB);
                });

                // Add each village to dropdown
                sortedVillages.forEach(village => {
                    const villageId = village.village_id || village.id;
                    const villageName = village.village_name || village.name || 'Unknown Village';

                    villageSelect.append(`<option value="${villageId}">${villageName}</option>`);
                });

                // Try to restore previous selection
                if (currentVillageValue !== 'ALL' && villages.some(v => (v.village_id || v.id) == currentVillageValue)) {
                    villageSelect.val(currentVillageValue);
                }

                console.log("Village dropdown populated successfully");
            } else {
                console.log("No villages available for selected taluk");
                villageSelect.append('<option value="ALL" selected>No villages available</option>');
            }

            // Enable village dropdown
            villageSelect.prop('disabled', false);
        }

        // Populate shop dropdown
        function populateShopDropdown(shops) {
            const shopSelect = $('#shop');
            const currentShopValue = shopSelect.val();

            shopSelect.empty();
            shopSelect.append('<option value="ALL" selected>All Shops</option>');

            if (shops && shops.length > 0) {
                console.log(`Populating dropdown with ${shops.length} shops`);

                // Sort shops by code
                const sortedShops = [...shops].sort((a, b) => {
                    const codeA = a.shop_code || a.code || '';
                    const codeB = b.shop_code || b.code || '';
                    return codeA.localeCompare(codeB);
                });

                // Add each shop to dropdown
                sortedShops.forEach(shop => {
                    const shopId = shop.id || shop.shop_id;
                    const shopCode = shop.shop_code || shop.code || `Shop ${shopId}`;

                    shopSelect.append(`<option value="${shopId}">${shopCode}</option>`);
                });

                // Try to restore previous selection
                if (currentShopValue !== 'ALL' && shops.some(s => (s.id || s.shop_id) == currentShopValue)) {
                    shopSelect.val(currentShopValue);
                }

                console.log("Shop dropdown populated successfully");
            } else {
                console.log("No shops available for selected location");
                shopSelect.append('<option value="ALL" selected>No shops available</option>');
            }

            // Shop dropdown is always enabled
            shopSelect.prop('disabled', false);
        }

        // Populate scheme category dropdowns
        function populateSchemeCategoryDropdowns() {
            // Update all three category dropdowns
            for (let i = 1; i <= 3; i++) {
                const categorySelect = $(`#schemeCategory${i}`);
                const currentValue = categorySelect.val();

                categorySelect.empty();
                categorySelect.append('<option value="ALL" selected>Select Category</option>');

                if (API_DATA.schemeCategories && API_DATA.schemeCategories.length > 0) {
                    console.log(`Populating scheme category dropdown ${i}`);

                    // Get unique categories
                    const uniqueCategories = [];
                    const seenTypes = new Set();

                    API_DATA.schemeCategories.forEach(item => {
                        if (item.scheme_type && item.scheme_type.trim() !== '' && !seenTypes.has(item.scheme_type)) {
                            seenTypes.add(item.scheme_type);
                            uniqueCategories.push({
                                id: item.id,
                                type: item.scheme_type,
                                category: item.scheme_category
                            });
                        }
                    });

                    // Sort by type name
                    uniqueCategories.sort((a, b) => a.type.localeCompare(b.type));

                    // Add categories to dropdown
                    uniqueCategories.forEach(item => {
                        // Use scheme_type for both value and display text
                        const value = item.category;
                        const display = item.type;
                        categorySelect.append(`<option value="${value}">${display}</option>`);
                    });

                    // Try to restore previous selection
                    if (currentValue && currentValue !== 'ALL') {
                        // Check if the value exists in the dropdown
                        const exists = uniqueCategories.some(item => item.type === currentValue);
                        if (exists) {
                            categorySelect.val(currentValue);
                        }
                    }

                    console.log(`Scheme category dropdown ${i} populated with ${uniqueCategories.length} categories`);
                } else {
                    console.log("No scheme categories available");
                    categorySelect.append('<option value="ALL" selected>No categories available</option>');
                }
            }
        }

        // Populate scheme dropdown for a specific position
        function populateSchemeDropdown(position, category) {
            const schemeSelect = $(`#schemeList${position}`);
            const currentValue = schemeSelect.val();

            schemeSelect.empty();
            schemeSelect.append('<option value="ALL" selected>All Schemes</option>');

            let schemes = [];

            if (category === 'ALL') {
                // Show all schemes
                schemes = API_DATA.allSchemes;
            } else {
                // Filter schemes by category - use schemetype field
                schemes = API_DATA.allSchemes.filter(scheme =>
                    scheme.schemetype === category
                );
            }

            if (schemes && schemes.length > 0) {
                console.log(`Populating scheme dropdown ${position} with ${schemes.length} schemes for category ${category}`);

                // Sort schemes by name
                const sortedSchemes = [...schemes].sort((a, b) => {
                    const nameA = a.scheme_name || a.name || '';
                    const nameB = b.scheme_name || b.name || '';
                    return nameA.localeCompare(nameB);
                });

                // Add schemes to dropdown
                sortedSchemes.forEach(scheme => {
                    const schemeId = scheme.scheme_id || scheme.id;
                    const schemeName = scheme.scheme_name || scheme.name || 'Unknown Scheme';

                    schemeSelect.append(`<option value="${schemeId}">${schemeName}</option>`);
                });

                // Try to restore previous selection
                if (currentValue && currentValue !== 'ALL' && schemes.some(s => (s.scheme_id || s.id) == currentValue)) {
                    schemeSelect.val(currentValue);
                }

                console.log(`Scheme dropdown ${position} populated successfully`);
            } else {
                console.log(`No schemes available for category ${category}`);
                schemeSelect.append('<option value="ALL" selected>No schemes available</option>');
            }
        }

        // ================== EVENT HANDLER FUNCTIONS ==================

        // Handle district change
        async function handleDistrictChange() {
            const districtId = $('#district').val();
            console.log("District changed to:", districtId);

            // Reset dependent dropdowns
            $('#taluk').html('<option value="ALL" selected>Loading taluks...</option>');
            $('#taluk').prop('disabled', true);
            $('#village').html('<option value="ALL" selected>Select taluk first</option>');
            $('#village').prop('disabled', true);
            $('#shop').html('<option value="ALL" selected>Select village first</option>');

            if (districtId !== 'ALL') {
                try {
                    // Load taluks for selected district
                    const taluks = await loadTaluks(districtId);
                    populateTalukDropdown(taluks);

                    // Clear village and shop data
                    API_DATA.filteredVillages = [];
                    API_DATA.filteredShops = [];
                } catch (error) {
                    console.error("Error loading taluks:", error);
                    $('#taluk').html('<option value="ALL" selected>Error loading taluks</option>');
                }
            } else {
                // If "All Districts" is selected, enable taluk dropdown with empty options
                $('#taluk').html('<option value="ALL" selected>All Taluks</option>');
                $('#taluk').prop('disabled', false);

                // Clear all filtered data
                API_DATA.filteredTaluks = [];
                API_DATA.filteredVillages = [];
                API_DATA.filteredShops = [];
            }
        }

        // Handle taluk change
        async function handleTalukChange() {
            const districtId = $('#district').val();
            const talukId = $('#taluk').val();

            console.log("Taluk changed to:", talukId);

            // Reset dependent dropdowns
            $('#village').html('<option value="ALL" selected>Loading villages...</option>');
            $('#village').prop('disabled', true);
            $('#shop').html('<option value="ALL" selected>Select village first</option>');

            if (districtId !== 'ALL' && talukId !== 'ALL') {
                try {
                    // Load villages for selected district and taluk
                    const villages = await loadVillages(districtId, talukId);
                    populateVillageDropdown(villages);

                    // Clear shop data
                    API_DATA.filteredShops = [];
                } catch (error) {
                    console.error("Error loading villages:", error);
                    $('#village').html('<option value="ALL" selected>Error loading villages</option>');
                }
            } else {
                // If "All Taluks" is selected, enable village dropdown with empty options
                $('#village').html('<option value="ALL" selected>All Villages</option>');
                $('#village').prop('disabled', false);

                // Clear village and shop data
                API_DATA.filteredVillages = [];
                API_DATA.filteredShops = [];
            }
        }

        // Handle village change
        async function handleVillageChange() {
            const districtId = $('#district').val();
            const talukId = $('#taluk').val();
            const villageId = $('#village').val();

            console.log("Village changed to:", villageId);

            // Reset shop dropdown
            $('#shop').html('<option value="ALL" selected>Loading shops...</option>');

            if (districtId !== 'ALL' && talukId !== 'ALL' && villageId !== 'ALL') {
                try {
                    // Load shops for selected district, taluk, and village
                    const shops = await loadShops(districtId, talukId, villageId);
                    populateShopDropdown(shops);
                } catch (error) {
                    console.error("Error loading shops:", error);
                    $('#shop').html('<option value="ALL" selected>Error loading shops</option>');
                }
            } else {
                // If "All Villages" is selected, show all shops option
                $('#shop').html('<option value="ALL" selected>All Shops</option>');
                API_DATA.filteredShops = [];
            }
        }

        // Handle scheme category change
        async function handleSchemeCategoryChange(position) {
            const categorySelect = $(`#schemeCategory${position}`);
            const category = categorySelect.val();

            console.log(`Scheme category ${position} changed to:`, category);

            // Update scheme dropdown
            const schemeSelect = $(`#schemeList${position}`);
            schemeSelect.html('<option value="ALL" selected>Loading schemes...</option>');

            if (category !== 'ALL') {
                try {
                    // Check if we have schemes cached for this category
                    if (!API_DATA.filteredSchemesByCategory[category] || API_DATA.filteredSchemesByCategory[category].length === 0) {
                        // Load schemes for this category
                        console.log(`Loading schemes for category: ${category}`);
                        const schemes = await loadSchemes(category);
                        console.log(`Loaded ${schemes.length} schemes for category: ${category}`);
                    }

                    // Populate scheme dropdown
                    populateSchemeDropdown(position, category);

                    // Update scheme descriptions if scheme is selected
                    updateSchemeDescriptions();

                } catch (error) {
                    console.error(`Error loading schemes for category ${category}:`, error);
                    schemeSelect.html('<option value="ALL" selected>Error loading schemes</option>');
                }
            } else {
                // If "ALL" is selected, populate with all schemes
                if (API_DATA.allSchemes.length === 0) {
                    await loadAllSchemes();
                }
                populateSchemeDropdown(position, 'ALL');
                updateSchemeDescriptions();
            }

            // Apply filters
            applyFilters();
        }

        // ================== INITIALIZATION FUNCTION ==================

        // Initialize all data
        async function initializeAllData() {
            try {
                console.log("Initializing all data...");

                // Load districts
                await loadDistricts();
                populateDistrictDropdown();

                // Load scheme categories
                await loadSchemeCategories();
                populateSchemeCategoryDropdowns();

                // Load all schemes initially
                await loadAllSchemes();

                // Initialize scheme dropdowns with "ALL" option
                for (let i = 1; i <= 3; i++) {
                    populateSchemeDropdown(i, 'ALL');
                }

                console.log("All data initialized successfully");

            } catch (error) {
                console.error('Initialization error:', error);

                // Fallback initialization
                populateDistrictDropdown();
                populateSchemeCategoryDropdowns();

                for (let i = 1; i <= 3; i++) {
                    $(`#schemeList${i}`).html('<option value="ALL" selected>All Schemes</option>');
                }
            }
        }

        // ================== EVENT LISTENERS SETUP ==================

        // Set up event listeners
        function setupEventListeners() {
            console.log("Setting up enhanced event listeners");

            // Geographic filters
            $('#district').on('change', handleDistrictChange);
            $('#taluk').on('change', handleTalukChange);
            $('#village').on('change', handleVillageChange);
            $('#shop').on('change', applyFilters);

            // Demographic filters
            $('#gender, #ageMin, #ageMax, #dateFrom, #dateTo').on('change', applyFilters);

            // Scheme category filters
            for (let i = 1; i <= 3; i++) {
                $(`#schemeCategory${i}`).on('change', function () {
                    handleSchemeCategoryChange(i);
                });
            }

            // Scheme list filters
            for (let i = 1; i <= 3; i++) {
                $(`#schemeList${i}`).on('change', function () {
                    updateSchemeDescriptions();
                    applyFilters();
                });
            }

            console.log("Event listeners setup complete");
        }

        // ================== SCHEME DESCRIPTIONS ==================

        // Update scheme descriptions with real data
        async function updateSchemeDescriptions() {
            const descriptionsContainer = $('#schemeDescriptions');
            descriptionsContainer.empty();

            // Check if any schemes are selected
            let selectedSchemes = [];

            for (let i = 1; i <= 3; i++) {
                const schemeSelect = $(`#schemeList${i}`);
                const categorySelect = $(`#schemeCategory${i}`);
                const selectedSchemeId = schemeSelect.val();
                const selectedCategory = categorySelect.val();

                if (selectedSchemeId !== 'ALL' && selectedCategory !== 'ALL') {
                    // Find the scheme details
                    const scheme = API_DATA.allSchemes.find(s =>
                        (s.scheme_id || s.id) == selectedSchemeId
                    );

                    if (scheme) {
                        selectedSchemes.push({
                            schemeId: selectedSchemeId,
                            schemeName: scheme.scheme_name || scheme.name || 'Unknown Scheme',
                            category: scheme.schemetype || selectedCategory,
                            position: i
                        });
                    }
                }
            }

            if (selectedSchemes.length === 0) {
                // No schemes selected
                descriptionsContainer.html(`
                <div class="text-center text-muted py-4">
                    <i class="bi bi-stars fs-1 mb-2 d-block"></i>
                    <p>Select dream schemes to view descriptions</p>
                    <small class="text-muted">Select scheme categories and specific schemes to see details</small>
                </div>
            `);
                return;
            }

            // Show loading state
            descriptionsContainer.html(`
            <div class="text-center py-3">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading scheme descriptions...</p>
            </div>
        `);

            // Load descriptions for all selected schemes
            const descriptionPromises = selectedSchemes.map(async (scheme) => {
                try {
                    const descriptions = await loadSchemeDescriptions(scheme.schemeId);
                    return {
                        scheme: scheme,
                        descriptions: descriptions
                    };
                } catch (error) {
                    console.error(`Error loading descriptions for scheme ${scheme.schemeId}:`, error);
                    return {
                        scheme: scheme,
                        descriptions: [],
                        error: true
                    };
                }
            });

            try {
                const allDescriptions = await Promise.all(descriptionPromises);
                displaySchemeDescriptions(allDescriptions);
            } catch (error) {
                console.error('Error loading all scheme descriptions:', error);
                descriptionsContainer.html(`
                <div class="text-center text-danger py-4">
                    <i class="bi bi-exclamation-triangle fs-1 mb-2 d-block"></i>
                    <p>Error loading scheme descriptions</p>
                    <small class="text-muted">Please try again</small>
                </div>
            `);
            }
        }

        // Display scheme descriptions
        function displaySchemeDescriptions(allDescriptions) {
            const descriptionsContainer = $('#schemeDescriptions');
            descriptionsContainer.empty();

            if (allDescriptions.length === 0) {
                descriptionsContainer.html(`
                <div class="text-center text-muted py-4">
                    <i class="bi bi-stars fs-1 mb-2 d-block"></i>
                    <p>No descriptions found for selected schemes</p>
                    <small class="text-muted">Try selecting different schemes or adjust filters</small>
                </div>
            `);
                return;
            }

            // Create HTML for each scheme's descriptions
            allDescriptions.forEach((item, index) => {
                const cardHtml = createSchemeDescriptionCard(item.scheme, item.descriptions);
                if (index === 0) {
                    descriptionsContainer.append(cardHtml);
                } else {
                    descriptionsContainer.append('<hr class="my-3">' + cardHtml);
                }
            });
        }

        // Create HTML card for scheme descriptions
        function createSchemeDescriptionCard(schemeInfo, descriptions) {
            const hasDescriptions = descriptions && descriptions.length > 0;

            let descriptionContent = '';

            if (hasDescriptions) {
                // Group descriptions by district
                const descriptionsByDistrict = {};

                descriptions.forEach(desc => {
                    const district = desc.district_name || 'Unknown District';
                    if (!descriptionsByDistrict[district]) {
                        descriptionsByDistrict[district] = [];
                    }
                    descriptionsByDistrict[district].push(desc);
                });

                // Create collapsible sections for each district
                const districtSections = Object.keys(descriptionsByDistrict).map(district => {
                    const districtDesc = descriptionsByDistrict[district];
                    const uniqueCount = new Set(districtDesc.map(d => d.suggestion_remarks)).size;

                    return `
                    <div class="accordion-item mb-1">
                        <h2 class="accordion-header" id="heading-${schemeInfo.schemeId}-${district.replace(/\s+/g, '-')}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-${schemeInfo.schemeId}-${district.replace(/\s+/g, '-')}" 
                                    aria-expanded="false" aria-controls="collapse-${schemeInfo.schemeId}-${district.replace(/\s+/g, '-')}">
                                <i class="bi bi-geo-alt me-2"></i>
                                ${district}
                                <span class="badge bg-primary ms-2">${districtDesc.length} entries</span>
                                <span class="badge bg-info ms-1">${uniqueCount} unique remarks</span>
                            </button>
                        </h2>
                        <div id="collapse-${schemeInfo.schemeId}-${district.replace(/\s+/g, '-')}" 
                             class="accordion-collapse collapse" 
                             aria-labelledby="heading-${schemeInfo.schemeId}-${district.replace(/\s+/g, '-')}">
                            <div class="accordion-body p-0">
                                <div class="list-group list-group-flush">
                                    ${districtDesc.slice(0, 10).map((desc, idx) => `
                                        <div class="list-group-item p-2 border-bottom">
                                            <div class="d-flex justify-content-between align-items-start mb-1">
                                                <div>
                                                    <small class="text-muted">
                                                        <i class="bi bi-calendar me-1"></i>
                                                        ${desc.created_ts ? new Date(desc.created_ts).toLocaleDateString() : 'N/A'}
                                                    </small>
                                                    ${desc.taluk_name ? `<small class="text-muted ms-2"><i class="bi bi-geo me-1"></i>${desc.taluk_name}</small>` : ''}
                                                    ${desc.village_name ? `<small class="text-muted ms-2"><i class="bi bi-geo-alt me-1"></i>${desc.village_name}</small>` : ''}
                                                </div>
                                                <span class="badge ${desc.active === 1 ? 'bg-success' : 'bg-secondary'}">
                                                    ${desc.active === 1 ? 'Active' : 'Inactive'}
                                                </span>
                                            </div>
                                            <div class="mt-1">
                                                <p class="mb-1 fw-semibold">Description:</p>
                                                <div class="bg-light p-1 rounded">
                                                    ${desc.suggestion_remarks || '<em class="text-muted">No remarks provided</em>'}
                                                </div>
                                            </div>
                                            ${desc.shopcode ? `
                                                <div class="mt-1">
                                                    <small class="text-muted">
                                                        <i class="bi bi-shop me-1"></i>
                                                        Shop: ${desc.shopcode}
                                                    </small>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                    ${districtDesc.length > 10 ? `
                                        <div class="list-group-item p-2 text-center">
                                            <small class="text-muted">
                                                ...and ${districtDesc.length - 10} more entries
                                            </small>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

                descriptionContent = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="mb-1 fw-bold">${descriptions.length} Description${descriptions.length !== 1 ? 's' : ''} Found</h6>
                            <small class="text-muted">Across ${Object.keys(descriptionsByDistrict).length} districts</small>
                        </div>
                        <span class="badge bg-warning">${schemeInfo.category}</span>
                    </div>
                    <div class="accordion" id="accordion-${schemeInfo.schemeId}">
                        ${districtSections}
                    </div>
                </div>
            `;
            } else {
                descriptionContent = `
                <div class="text-center py-3">
                    <i class="bi bi-chat-dots fs-4 text-muted mb-2 d-block"></i>
                    <p class="text-muted mb-0">No descriptions found for this scheme</p>
                    <small class="text-muted">Try adjusting filters or select a different scheme</small>
                </div>
            `;
            }

            return `
            <div class="scheme-description-card p-2 mb-2">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h5 class="fw-bold mb-1">${schemeInfo.schemeName}</h5>
                        <small class="text-muted">Dream Scheme ${schemeInfo.position}</small>
                    </div>
                    <div class="d-flex gap-1">
                        <span class="badge bg-warning">${schemeInfo.category}</span>
                        <span class="badge bg-info">ID: ${schemeInfo.schemeId}</span>
                    </div>
                </div>
                
                ${descriptionContent}
                
                <div class="mt-2 pt-2 border-top">
                    <div class="row g-1">
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="bi bi-database me-1"></i>
                                Total entries: ${hasDescriptions ? descriptions.length : 0}
                            </small>
                        </div>
                        <div class="col-6 text-end">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                Updated just now
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }

        // ================== CHART FUNCTIONS ==================

        // Update geographic distribution pie chart
        function updateGeographicDistributionChart(filteredData) {
            if (!pieChart) {
                pieChart = echarts.init(document.getElementById("pie"));
            }

            // Group data by district
            const districtCounts = {};
            let totalCount = 0;

            filteredData.forEach(item => {
                const districtName = item.district_name || 'Unknown District';
                if (!districtCounts[districtName]) {
                    districtCounts[districtName] = 0;
                }
                districtCounts[districtName]++;
                totalCount++;
            });

            // Prepare chart data
            const chartData = Object.keys(districtCounts).map(district => ({
                name: district,
                value: districtCounts[district]
            }));

            // Sort by count (descending)
            chartData.sort((a, b) => b.value - a.value);

            // Take top 10 districts, group the rest as "Others"
            let displayData = [];
            if (chartData.length > 10) {
                const top10 = chartData.slice(0, 10);
                const others = chartData.slice(10);
                const othersTotal = others.reduce((sum, item) => sum + item.value, 0);

                displayData = [...top10, { name: 'Other Districts', value: othersTotal }];
            } else {
                displayData = chartData;
            }

            // Update summary cards
            updateSummaryCards(filteredData);

            // Chart options
            const option = {
                title: {
                    text: `Geographic Distribution (Total: ${totalCount})`,
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                legend: {
                    type: 'scroll',
                    orient: 'vertical',
                    right: 10,
                    top: 'middle',
                    height: '80%',
                    textStyle: {
                        fontSize: 12
                    }
                },
                series: [
                    {
                        name: 'District Distribution',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['35%', '50%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '18',
                                fontWeight: 'bold',
                                formatter: '{b}\n{c} ({d}%)'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: displayData,
                        color: [
                            '#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de',
                            '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc', '#60acfc',
                            '#ff9f7f'
                        ]
                    }
                ]
            };

            pieChart.setOption(option);

            // Update filter summary text
            $('#filterSummary').text(`(${totalCount} records across ${Object.keys(districtCounts).length} districts)`);
        }

        // Update summary cards
        function updateSummaryCards(filteredData) {
            const totalCount = filteredData.length;

            // Count unique districts
            const uniqueDistricts = new Set();
            const uniqueVillages = new Set();

            filteredData.forEach(item => {
                if (item.district_name) uniqueDistricts.add(item.district_name);
                if (item.village_name) uniqueVillages.add(item.village_name);
            });

            // Update summary cards
            $('#totalFamiliesCount').text(totalCount.toLocaleString());
            $('#activeFamiliesCount').text(totalCount.toLocaleString()); // Assuming all are active
            $('#totalDistrictsCount').text(uniqueDistricts.size.toLocaleString());
            $('#totalVillagesCount').text(uniqueVillages.size.toLocaleString());
        }

        // ================== FILTER FUNCTIONS ==================

        // Update scheme filter logic
        function updateSchemeLogic(logic) {
            schemeLogic = logic;
            document.getElementById('schemeLogicIndicator').textContent = `${logic} Logic`;
            applyFilters();
        }

        // Main filter function
        async function applyFilters() {
            console.log("Applying filters...");

            // Show loading state
            $('#filterSummary').text('Loading data...');
            $('#totalFamiliesCount').text('0');
            $('#activeFamiliesCount').text('0');
            $('#totalDistrictsCount').text('0');
            $('#totalVillagesCount').text('0');

            // Collect all filter values
            const filters = {
                district: $('#district').val(),
                taluk: $('#taluk').val(),
                village: $('#village').val(),
                shop: $('#shop').val(),
                gender: $('#gender').val(),
                ageMin: $('#ageMin').val(),
                ageMax: $('#ageMax').val(),
                dateFrom: $('#dateFrom').val(),
                dateTo: $('#dateTo').val(),
                filterLogic: filterLogic,
                schemeLogic: schemeLogic
            };

            // Collect scheme filters
            for (let i = 1; i <= 3; i++) {
                filters[`schemeCategory${i}`] = $(`#schemeCategory${i}`).val();
                filters[`schemeList${i}`] = $(`#schemeList${i}`).val();
            }

            console.log("Active filters:", filters);

            // Update filter summary
            updateFilterSummary(filters);

            try {
                // Call the filter API
                const filteredData = await loadFilteredData(filters);

                // Update the chart with filtered data
                updateGeographicDistributionChart(filteredData);

                // Also update scheme descriptions
                updateSchemeDescriptions();

            } catch (error) {
                console.error('Error applying filters:', error);
                $('#filterSummary').text('Error loading data');

                // Clear chart
                if (pieChart) {
                    pieChart.clear();
                }
            }
        }

        // Update filter summary display
        function updateFilterSummary(filters) {
            const summaryDiv = $('#activeFiltersDisplay');
            summaryDiv.empty();

            // Add geographic filters
            if (filters.district !== 'ALL') {
                const districtName = $('#district option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> District: ${districtName}</span>`);
            }

            if (filters.taluk !== 'ALL') {
                const talukName = $('#taluk option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> Taluk: ${talukName}</span>`);
            }

            if (filters.village !== 'ALL') {
                const villageName = $('#village option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> Village: ${villageName}</span>`);
            }

            if (filters.shop !== 'ALL') {
                const shopName = $('#shop option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-shop"></i> Shop: ${shopName}</span>`);
            }

            // Add demographic filters
            if (filters.gender !== 'ALL') {
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-gender-ambiguous"></i> Gender: ${filters.gender}</span>`);
            }

            if (filters.ageMin !== '18' || filters.ageMax !== '80') {
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-calendar3"></i> Age: ${filters.ageMin}-${filters.ageMax}</span>`);
            }

            // Add scheme filters
            for (let i = 1; i <= 3; i++) {
                const category = filters[`schemeCategory${i}`];
                const schemeId = filters[`schemeList${i}`];

                if (category !== 'ALL' && schemeId !== 'ALL') {
                    const schemeName = $(`#schemeList${i} option:selected`).text();
                    const categoryName = $(`#schemeCategory${i} option:selected`).text();
                    summaryDiv.append(`<span class="active-filter-badge" style="background:#f59e0b;"><i class="bi bi-card-checklist"></i> ${categoryName}: ${schemeName}</span>`);
                }
            }

            // Add logic badges
            summaryDiv.append(`<span class="active-filter-badge" style="background:#f59e0b;"><i class="bi bi-card-checklist"></i> Scheme Logic: ${schemeLogic}</span>`);
        }

        // Reset all filters
        function resetAll() {
            console.log("Resetting filters...");

            // Reset geographic filters
            $('#district').val('ALL').trigger('change');
            $('#taluk').val('ALL').prop('disabled', false);
            $('#village').val('ALL').prop('disabled', false);
            $('#shop').val('ALL');

            // Reset demographic filters
            $('#gender').val('ALL');
            $('#ageMin').val(18);
            $('#ageMax').val(80);

            // Reset dates
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            $('#dateFrom').val(oneYearAgo.toISOString().split('T')[0]);
            $('#dateTo').val(today.toISOString().split('T')[0]);

            // Reset scheme filters
            for (let i = 1; i <= 3; i++) {
                $(`#schemeCategory${i}`).val('ALL');
                $(`#schemeList${i}`).val('ALL');
            }

            // Reset logic to AND
            $('#schemeLogicAND').prop('checked', true);
            schemeLogic = 'AND';
            document.getElementById('schemeLogicIndicator').textContent = 'AND Logic';

            // Reset scheme descriptions
            updateSchemeDescriptions();

            // Clear filter summary
            $('#activeFiltersDisplay').empty();

            // Clear chart and summary
            if (pieChart) {
                pieChart.clear();
            }
            $('#filterSummary').text('');
            $('#totalFamiliesCount').text('0');
            $('#activeFamiliesCount').text('0');
            $('#totalDistrictsCount').text('0');
            $('#totalVillagesCount').text('0');

            // Apply filters to load default data
            applyFilters();
        }

        // ================== EXPORT FUNCTIONS ==================

        // Export CSV
        function exportCSV() {
            if (API_DATA.filteredData.length === 0) {
                alert('No data to export. Please apply filters first.');
                return;
            }

            try {
                // Prepare CSV headers
                const headers = [
                    'District', 'Taluk', 'Village', 'Shop Code', 'Scheme Name',
                    'Type', 'Suggestion Remarks', 'Created Date', 'Status'
                ];

                // Prepare CSV rows
                const rows = API_DATA.filteredData.map(item => [
                    item.district_name || '',
                    item.taluk_name || '',
                    item.village_name || '',
                    item.shopcode || '',
                    item.scheme_name || '',
                    item.type || '',
                    item.suggestion_remarks || '',
                    item.created_ts ? new Date(item.created_ts).toLocaleDateString() : '',
                    item.active === 1 ? 'Active' : 'Inactive'
                ]);

                // Create CSV content
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', `dream_scheme_data_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert(`Exported ${API_DATA.filteredData.length} records to CSV`);
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting data. Please try again.');
            }
        }

        // Export PDF
        function exportPDF() {
            if (API_DATA.filteredData.length === 0) {
                alert('No data to export. Please apply filters first.');
                return;
            }

            try {
                // Use html2canvas to capture the chart
                html2canvas(document.getElementById('pie'), {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');

                    // Create PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('landscape');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();

                    // Add title
                    pdf.setFontSize(16);
                    pdf.text('Dream Scheme Analytics Report', pageWidth / 2, 15, { align: 'center' });

                    // Add date
                    pdf.setFontSize(10);
                    pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, 22, { align: 'center' });

                    // Add summary statistics
                    pdf.setFontSize(12);
                    pdf.text(`Total Records: ${API_DATA.filteredData.length}`, 20, 35);

                    // Count unique districts
                    const uniqueDistricts = new Set(API_DATA.filteredData.map(item => item.district_name).filter(Boolean));
                    pdf.text(`Districts: ${uniqueDistricts.size}`, 20, 42);

                    // Add chart image
                    const imgWidth = pageWidth - 40;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 20, 50, imgWidth, imgHeight);

                    // Add filter summary
                    const filterText = $('#activeFiltersDisplay').text().substring(0, 100) + '...';
                    pdf.setFontSize(10);
                    pdf.text(`Filters Applied: ${filterText}`, 20, imgHeight + 60);

                    // Save PDF
                    pdf.save(`dream_scheme_report_${new Date().toISOString().split('T')[0]}.pdf`);

                    alert('PDF exported successfully!');
                });
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Error exporting PDF. Please try again.');
            }
        }

        // ================== SIDEBAR FUNCTIONS ==================

        // Sidebar functions
        function toggleSidebar() {
            $("#sidebar").toggleClass("collapsed");
            $("#main").toggleClass("collapsed");
            setTimeout(() => {
                if (pieChart) {
                    pieChart.resize();
                }
            }, 300);
        }

        // Initialize sidebar for mobile
        if (window.innerWidth <= 768) {
            document.getElementById("sidebar").classList.add("collapsed");
            document.getElementById("main").classList.add("collapsed");
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener("click", function (e) {
            if (window.innerWidth <= 768) {
                let sidebar = document.getElementById("sidebar");
                let btn = document.querySelector(".bi-list");

                if (btn && !sidebar.contains(e.target) && !btn.contains(e.target)) {
                    sidebar.classList.add("collapsed");
                }
            }
        });

        // Initialize charts on window resize
        window.addEventListener('resize', function () {
            if (pieChart) {
                pieChart.resize();
            }
        });

        // Load initial data when page loads
        $(window).on('load', function () {
            // Apply filters to load initial data after a short delay
            setTimeout(() => {
                applyFilters();
            }, 1000);
        });
    </script> -->
    <script>
        $(document).ready(function () {
            console.log("Page loaded. Initializing...");

            // Initialize all data from APIs
            initializeAllData();

            // Set up event listeners
            setupEventListeners();
        });

        // ================== GLOBAL VARIABLES ==================

        // Global variables for filter logic
        let filterLogic = 'AND';
        let schemeLogic = 'AND';

        // Store data from APIs
        let API_DATA = {
            // Geographic data
            districts: [],
            allTaluks: [],
            allVillages: [],
            allShops: [],
            filteredTaluks: [],
            filteredVillages: [],
            filteredShops: [],

            // Scheme data
            schemeCategories: [],
            allSchemes: [],
            filteredSchemesByCategory: {},

            // Chart data
            filteredData: [],
            currentChartData: null
        };

        // API endpoints configuration
        const API_CONFIG = {
            baseUrl: 'https://tngis.tnega.org/state_scholarship_portal_api/sfdb_survey/api/v1/dashboard2/',
            endpoints: {
                dynamic_input: 'dynamic_input',
                get_districts: 'get_districts'
            }
        };

        // Initialize charts
        let pieChart = echarts.init(document.getElementById("pie"));

        // ================== GEOGRAPHIC API FUNCTIONS ==================

        // Load districts
        async function loadDistricts() {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_master_district",
                    "selected_columns": ["district_id", "district_name"],
                    "filter_conditions": {},
                    "sort_columns": {},
                    "limit_rows": 50,
                    "offset_rows": 0
                };

                console.log("Loading districts...");
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let districtList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            districtList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            districtList = decryptedData;
                        }
                    }

                    if (Array.isArray(districtList)) {
                        API_DATA.districts = districtList;
                        console.log(`Loaded ${districtList.length} districts`);
                        return districtList;
                    } else {
                        console.error("District list is not an array:", districtList);
                        API_DATA.districts = [];
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1");
                    API_DATA.districts = [];
                    return [];
                }
            } catch (error) {
                console.error('Error loading districts:', error);
                API_DATA.districts = [];
                return [];
            }
        }

        // Load taluks for a specific district
        async function loadTaluks(districtId) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_master_taluk",
                    "selected_columns": ["district_id", "taluk_id", "taluk_name"],
                    "filter_conditions": {
                        "district_id": districtId
                    },
                    "sort_columns": {},
                    "limit_rows": 100,
                    "offset_rows": 0
                };

                console.log(`Loading taluks for district ${districtId}...`);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let talukList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            talukList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            talukList = decryptedData;
                        }
                    }

                    if (Array.isArray(talukList)) {
                        // Store in allTaluks for caching
                        API_DATA.allTaluks = API_DATA.allTaluks.concat(talukList.filter(t =>
                            !API_DATA.allTaluks.some(existing => existing.taluk_id === t.taluk_id)
                        ));

                        // Filter for current district
                        API_DATA.filteredTaluks = talukList;
                        console.log(`Loaded ${talukList.length} taluks for district ${districtId}`);
                        return talukList;
                    } else {
                        console.error("Taluk list is not an array:", talukList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for taluks");
                    return [];
                }
            } catch (error) {
                console.error('Error loading taluks:', error);
                return [];
            }
        }

        // Load villages for a specific district and taluk
        async function loadVillages(districtId, talukId) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_village_master",
                    "selected_columns": ["district_id", "taluk_id", "village_id", "village_name"],
                    "filter_conditions": {
                        "district_id": districtId,
                        "taluk_id": talukId
                    },
                    "sort_columns": {},
                    "limit_rows": 200,
                    "offset_rows": 0
                };

                console.log(`Loading villages for district ${districtId}, taluk ${talukId}...`);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let villageList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            villageList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            villageList = decryptedData;
                        }
                    }

                    if (Array.isArray(villageList)) {
                        // Store in allVillages for caching
                        API_DATA.allVillages = API_DATA.allVillages.concat(villageList.filter(v =>
                            !API_DATA.allVillages.some(existing => existing.village_id === v.village_id)
                        ));

                        // Filter for current district and taluk
                        API_DATA.filteredVillages = villageList;
                        console.log(`Loaded ${villageList.length} villages`);
                        return villageList;
                    } else {
                        console.error("Village list is not an array:", villageList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for villages");
                    return [];
                }
            } catch (error) {
                console.error('Error loading villages:', error);
                return [];
            }
        }

        // Load shops for a specific district, taluk, and village
        async function loadShops(districtId, talukId, villageId) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_master",
                    "selected_columns": ["id", "shop_code"],
                    "filter_conditions": {
                        "district_id": districtId,
                        "taluk_id": talukId,
                        "village_id": villageId
                    },
                    "sort_columns": {},
                    "limit_rows": 200,
                    "offset_rows": 0
                };

                console.log(`Loading shops for district ${districtId}, taluk ${talukId}, village ${villageId}...`);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let shopList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            shopList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            shopList = decryptedData;
                        }
                    }

                    if (Array.isArray(shopList)) {
                        // Store in allShops for caching
                        API_DATA.allShops = API_DATA.allShops.concat(shopList.filter(s =>
                            !API_DATA.allShops.some(existing => existing.id === s.id)
                        ));

                        // Filter for current location
                        API_DATA.filteredShops = shopList;
                        console.log(`Loaded ${shopList.length} shops`);
                        return shopList;
                    } else {
                        console.error("Shop list is not an array:", shopList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for shops");
                    return [];
                }
            } catch (error) {
                console.error('Error loading shops:', error);
                return [];
            }
        }

        // ================== SCHEME API FUNCTIONS ==================

        // Load scheme categories
        async function loadSchemeCategories() {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "scheme_type_master",
                    "selected_columns": ["id", "scheme_type", "scheme_category"],
                    "filter_conditions": {},
                    "sort_columns": {
                        "scheme_category": "asc"
                    },
                    "limit_rows": 100,
                    "offset_rows": 0
                };

                console.log("Loading scheme categories...", payload);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let categoryList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            categoryList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            categoryList = decryptedData;
                        }
                    }

                    if (Array.isArray(categoryList)) {
                        API_DATA.schemeCategories = categoryList;
                        console.log(`Loaded ${categoryList.length} scheme categories`);
                        return categoryList;
                    } else {
                        console.error("Category list is not an array:", categoryList);
                        API_DATA.schemeCategories = [];
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for scheme categories");
                    API_DATA.schemeCategories = [];
                    return [];
                }
            } catch (error) {
                console.error('Error loading scheme categories:', error);
                API_DATA.schemeCategories = [];
                return [];
            }
        }

        // Load schemes for a specific category
        async function loadSchemes(categoryType) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "schemes",
                    "selected_columns": ["scheme_id", "scheme_name", "schemetype"],
                    "filter_conditions": {
                        "schemetype": categoryType
                    },
                    "sort_columns": {
                        "scheme_name": "asc"
                    },
                    "limit_rows": 200,
                    "offset_rows": 0
                };

                console.log(`Loading schemes for category type ${categoryType}...`, payload);

                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let schemeList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            schemeList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            schemeList = decryptedData;
                        }
                    }

                    if (Array.isArray(schemeList)) {
                        // Store in allSchemes for caching
                        API_DATA.allSchemes = API_DATA.allSchemes.concat(schemeList.filter(s =>
                            !API_DATA.allSchemes.some(existing => existing.scheme_id === s.scheme_id)
                        ));

                        // Cache schemes by category
                        if (!API_DATA.filteredSchemesByCategory[categoryType]) {
                            API_DATA.filteredSchemesByCategory[categoryType] = schemeList;
                        }

                        console.log(`Loaded ${schemeList.length} schemes for category ${categoryType}`);
                        return schemeList;
                    } else {
                        console.error("Scheme list is not an array:", schemeList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for schemes");
                    return [];
                }
            } catch (error) {
                console.error('Error loading schemes:', error);
                return [];
            }
        }

        // Load all schemes (for "ALL" category)
        async function loadAllSchemes() {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "schemes",
                    "selected_columns": ["scheme_id", "scheme_name", "schemetype"],
                    "filter_conditions": {},
                    "sort_columns": {
                        "scheme_name": "asc"
                    },
                    "limit_rows": 500,
                    "offset_rows": 0
                };

                console.log("Loading all schemes...");
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let schemeList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            schemeList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            schemeList = decryptedData;
                        }
                    }

                    if (Array.isArray(schemeList)) {
                        API_DATA.allSchemes = schemeList;
                        console.log(`Loaded ${schemeList.length} schemes`);
                        return schemeList;
                    } else {
                        console.error("Scheme list is not an array:", schemeList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for all schemes");
                    return [];
                }
            } catch (error) {
                console.error('Error loading all schemes:', error);
                return [];
            }
        }

        // ================== MAIN FILTER API FUNCTION WITH ENHANCED ARRAY HANDLING ==================

        // Load filtered data from analytics_suggestionform_smple
        async function loadFilteredData(filters) {
            try {
                // Build filter conditions - Start with geographic filters
                let filterConditions = {};

                // Geographic filters - only add if not 'ALL'
                if (filters.district && filters.district !== 'ALL') {
                    filterConditions.district_id = filters.district;
                }
                if (filters.taluk && filters.taluk !== 'ALL') {
                    filterConditions.taluk_id = filters.taluk;
                }
                if (filters.village && filters.village !== 'ALL') {
                    filterConditions.village_id = filters.village;
                }
                if (filters.shop && filters.shop !== 'ALL') {
                    const shopOption = $('#shop option:selected');
                    if (shopOption.length > 0 && shopOption.text()) {
                        filterConditions.shopcode = shopOption.text();
                    }
                }

                // Collect scheme filters (type_id values)
                const schemeFilters = [];
                for (let i = 1; i <= 3; i++) {
                    const schemeId = filters[`schemeList${i}`];
                    if (schemeId && schemeId !== 'ALL') {
                        schemeFilters.push(schemeId);
                    }
                }

                console.log("Scheme filters found:", schemeFilters);
                console.log("Scheme logic:", schemeLogic);
                console.log("Total filters:", Object.keys(filterConditions).length);

                // CORRECTED: Proper array handling for multiple schemes
                if (schemeFilters.length > 0) {
                    if (schemeLogic === 'OR') {
                        // OR logic: match ANY of the selected schemes
                        // API expects array format directly for OR logic
                        if (schemeFilters.length === 1) {
                            // Single scheme - simple equality
                            filterConditions.type_id = schemeFilters[0];
                        } else {
                            // Multiple schemes - send as array
                            // The API handles array as OR condition
                            filterConditions.type_id = schemeFilters;
                        }
                        console.log("Using OR logic with schemes array:", filterConditions.type_id);
                    } else {
                        // AND logic: match ALL selected schemes
                        if (schemeFilters.length === 1) {
                            // Single scheme - simple equality
                            filterConditions.type_id = schemeFilters[0];
                        } else {
                            // For AND logic with multiple schemes:
                            // First, use array format to get records with ANY of the schemes
                            // Then filter client-side for AND condition
                            filterConditions.type_id = schemeFilters;
                            console.log("Using AND logic initial filter with array:", filterConditions.type_id);
                        }
                    }
                }

                console.log("Final filter conditions for API:", JSON.stringify(filterConditions, null, 2));

                const payload = {
                    "action": "select",
                    "_table_name": "analytics.analytics_suggestionform_smple",
                    "selected_columns": [
                        "id", "taluk_id", "ufcno", "type_id", "schemetype_id",
                        "suggestion_remarks", "active", "created_by", "created_ts",
                        "updated_by", "updated_ts", "shopcode", "subscheme_id",
                        "type", "scheme_name", "district_id", "district_name",
                        "taluk_name", "village_id", "village_name"
                    ],
                    "filter_conditions": filterConditions,
                    "sort_columns": {
                        "district_name": "asc",
                        "taluk_name": "asc"
                    },
                    "limit_rows": 3000, // Increased for AND logic filtering
                    "offset_rows": 0
                };

                console.log("Loading filtered data with payload:", JSON.stringify(payload, null, 2));
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let filteredList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            filteredList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing filtered data:", parseError);
                            filteredList = decryptedData;
                        }
                    }

                    if (Array.isArray(filteredList)) {
                        console.log(`Initial API returned ${filteredList.length} records`);

                        // Apply AND logic filtering if needed
                        if (schemeLogic === 'AND' && schemeFilters.length > 1) {
                            console.log(`Applying AND logic filtering for ${schemeFilters.length} schemes`);

                            // Create a map to track families and their schemes
                            const familySchemesMap = new Map();

                            // First pass: organize data by ufcno (family identifier)
                            filteredList.forEach(item => {
                                const ufcno = item.ufcno;
                                if (!ufcno) return;

                                if (!familySchemesMap.has(ufcno)) {
                                    familySchemesMap.set(ufcno, {
                                        records: [],
                                        schemeIds: new Set()
                                    });
                                }

                                const familyData = familySchemesMap.get(ufcno);
                                familyData.records.push(item);
                                familyData.schemeIds.add(String(item.type_id)); // Convert to string for comparison
                            });

                            console.log(`Found ${familySchemesMap.size} unique families`);

                            // Second pass: filter families that have ALL selected schemes
                            const andFilteredList = [];
                            const schemeFilterStrings = schemeFilters.map(id => String(id));

                            familySchemesMap.forEach((familyData, ufcno) => {
                                const hasAllSchemes = schemeFilterStrings.every(schemeId =>
                                    familyData.schemeIds.has(schemeId)
                                );

                                if (hasAllSchemes) {
                                    // Add all records for this family
                                    andFilteredList.push(...familyData.records);
                                }
                            });

                            console.log(`AND logic: ${filteredList.length} initial records -> ${andFilteredList.length} records after filtering`);
                            console.log(`Found ${andFilteredList.length / schemeFilters.length} families with ALL selected schemes`);
                            filteredList = andFilteredList;
                        }

                        API_DATA.filteredData = filteredList;
                        console.log(`Final filtered records: ${filteredList.length}`);
                        return filteredList;
                    } else {
                        console.error("Filtered list is not an array:", filteredList);
                        API_DATA.filteredData = [];
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for filtered data");
                    console.error("API Response:", response);
                    API_DATA.filteredData = [];
                    return [];
                }
            } catch (error) {
                console.error('Error loading filtered data:', error);
                API_DATA.filteredData = [];
                return [];
            }
        }
        // ================== SCHEME DESCRIPTION API FUNCTION WITH ARRAY SUPPORT ==================

        // Load scheme descriptions for multiple schemes
        async function loadSchemeDescriptions(schemeIds) {
            try {
                // Build filter conditions
                let filterConditions = {};

                // Check if schemeIds is an array or single value
                if (Array.isArray(schemeIds) && schemeIds.length > 0) {
                    if (schemeIds.length === 1) {
                        filterConditions.type_id = schemeIds[0];
                    } else {
                        // Send as array directly (API expects array format)
                        filterConditions.type_id = schemeIds;
                    }
                } else if (schemeIds) {
                    // Single scheme ID
                    filterConditions.type_id = schemeIds;
                } else {
                    console.error("No scheme IDs provided");
                    return [];
                }

                // Apply current geographic filters if set
                const district = $('#district').val();
                const taluk = $('#taluk').val();
                const village = $('#village').val();
                const shop = $('#shop').val();

                if (district && district !== 'ALL') {
                    filterConditions.district_id = district;
                }
                if (taluk && taluk !== 'ALL') {
                    filterConditions.taluk_id = taluk;
                }
                if (village && village !== 'ALL') {
                    filterConditions.village_id = village;
                }
                if (shop && shop !== 'ALL') {
                    const shopOption = $('#shop option:selected');
                    if (shopOption.length > 0 && shopOption.text()) {
                        filterConditions.shopcode = shopOption.text();
                    }
                }

                const payload = {
                    "action": "select",
                    "_table_name": "analytics.analytics_suggestionform_smple",
                    "selected_columns": [
                        "district_name", "taluk_name", "village_name",
                        "suggestion_remarks", "created_ts", "shopcode",
                        "scheme_name", "type", "active", "type_id"
                    ],
                    "filter_conditions": filterConditions,
                    "sort_columns": {
                        "created_ts": "desc"
                    },
                    "limit_rows": 150, // Increased for multiple schemes
                    "offset_rows": 0
                };

                console.log("Loading scheme descriptions with payload:", JSON.stringify(payload, null, 2));
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let descriptions = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            descriptions = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing description data:", parseError);
                            descriptions = decryptedData;
                        }
                    }

                    if (Array.isArray(descriptions)) {
                        console.log(`Loaded ${descriptions.length} descriptions for scheme(s) ${schemeIds}`);
                        return descriptions;
                    } else {
                        console.error("Description list is not an array:", descriptions);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for scheme descriptions");
                    console.error("API Response:", response);
                    return [];
                }
            } catch (error) {
                console.error('Error loading scheme descriptions:', error);
                return [];
            }
        }
        // ================== GENERIC API FUNCTION ==================

        async function testApiArrayFormat() {
            try {
                // Test payload with array type_id
                const testPayload = {
                    "action": "select",
                    "_table_name": "analytics.analytics_suggestionform_smple",
                    "selected_columns": ["id", "type_id", "scheme_name"],
                    "filter_conditions": {
                        "type_id": ["625", "604"] // Array format
                    },
                    "sort_columns": {},
                    "limit_rows": 10,
                    "offset_rows": 0
                };

                console.log("Testing API with array format:", JSON.stringify(testPayload, null, 2));
                const response = await makeApiRequest(testPayload);

                if (response && response.success === 1) {
                    console.log(" API accepts array format successfully!");
                    const decryptedData = decryptData(response.data);
                    console.log("Test response data:", decryptedData);
                    return true;
                } else {
                    console.log(" API rejected array format");
                    console.log("Response:", response);
                    return false;
                }
            } catch (error) {
                console.error("Error testing API array format:", error);
                return false;
            }
        }
        // Generic API request function
        async function makeApiRequest(payload) {
            try {
                const encryptedPayload = encryptData(payload);
                const url = API_CONFIG.baseUrl + API_CONFIG.endpoints.dynamic_input;

                const response = await $.ajax({
                    url: url,
                    type: "POST",
                    dataType: "json",
                    data: { data: encryptedPayload },
                    success: function (response) {
                        console.log("API Success Response received");
                        return response;
                    },
                    error: function (xhr, status, error) {
                        console.error("API Error:", {
                            status: status,
                            error: error,
                            responseText: xhr.responseText
                        });
                        throw new Error(`API Error: ${status} - ${error}`);
                    }
                });

                return response;
            } catch (error) {
                console.error('API Request Error:', error);
                throw error;
            }
        }

        // ================== DROPDOWN POPULATION FUNCTIONS ==================

        // Populate district dropdown
        function populateDistrictDropdown() {
            const districtSelect = $('#district');
            districtSelect.empty();

            // Always add "All Districts" option
            districtSelect.append('<option value="ALL" selected>All Districts</option>');

            if (API_DATA.districts && API_DATA.districts.length > 0) {
                console.log(`Populating dropdown with ${API_DATA.districts.length} districts`);

                // Sort districts by name
                const sortedDistricts = [...API_DATA.districts].sort((a, b) => {
                    const nameA = a.district_name || a.name || '';
                    const nameB = b.district_name || b.name || '';
                    return nameA.localeCompare(nameB);
                });

                // Add each district to dropdown
                sortedDistricts.forEach(district => {
                    const districtId = district.district_id || district.id || district.district_code;
                    const districtName = district.district_name || district.name || 'Unknown District';

                    districtSelect.append(`<option value="${districtId}">${districtName}</option>`);
                });

                console.log("District dropdown populated successfully");
            } else {
                console.log("No districts available, showing fallback options");
                districtSelect.append('<option value="ALL" selected>No districts available</option>');
            }
        }

        // Populate taluk dropdown
        function populateTalukDropdown(taluks) {
            const talukSelect = $('#taluk');
            const currentTalukValue = talukSelect.val();

            talukSelect.empty();
            talukSelect.append('<option value="ALL" selected>All Taluks</option>');

            if (taluks && taluks.length > 0) {
                console.log(`Populating dropdown with ${taluks.length} taluks`);

                // Sort taluks by name
                const sortedTaluks = [...taluks].sort((a, b) => {
                    const nameA = a.taluk_name || a.name || '';
                    const nameB = b.taluk_name || b.name || '';
                    return nameA.localeCompare(nameB);
                });

                // Add each taluk to dropdown
                sortedTaluks.forEach(taluk => {
                    const talukId = taluk.taluk_id || taluk.id;
                    const talukName = taluk.taluk_name || taluk.name || 'Unknown Taluk';

                    talukSelect.append(`<option value="${talukId}">${talukName}</option>`);
                });

                // Try to restore previous selection
                if (currentTalukValue !== 'ALL' && taluks.some(t => (t.taluk_id || t.id) == currentTalukValue)) {
                    talukSelect.val(currentTalukValue);
                }

                console.log("Taluk dropdown populated successfully");
            } else {
                console.log("No taluks available for selected district");
                talukSelect.append('<option value="ALL" selected>No taluks available</option>');
            }

            // Enable taluk dropdown
            talukSelect.prop('disabled', false);
        }

        // Populate village dropdown
        function populateVillageDropdown(villages) {
            const villageSelect = $('#village');
            const currentVillageValue = villageSelect.val();

            villageSelect.empty();
            villageSelect.append('<option value="ALL" selected>All Villages</option>');

            if (villages && villages.length > 0) {
                console.log(`Populating dropdown with ${villages.length} villages`);

                // Sort villages by name
                const sortedVillages = [...villages].sort((a, b) => {
                    const nameA = a.village_name || a.name || '';
                    const nameB = b.village_name || b.name || '';
                    return nameA.localeCompare(nameB);
                });

                // Add each village to dropdown
                sortedVillages.forEach(village => {
                    const villageId = village.village_id || village.id;
                    const villageName = village.village_name || village.name || 'Unknown Village';

                    villageSelect.append(`<option value="${villageId}">${villageName}</option>`);
                });

                // Try to restore previous selection
                if (currentVillageValue !== 'ALL' && villages.some(v => (v.village_id || v.id) == currentVillageValue)) {
                    villageSelect.val(currentVillageValue);
                }

                console.log("Village dropdown populated successfully");
            } else {
                console.log("No villages available for selected taluk");
                villageSelect.append('<option value="ALL" selected>No villages available</option>');
            }

            // Enable village dropdown
            villageSelect.prop('disabled', false);
        }

        // Populate shop dropdown
        function populateShopDropdown(shops) {
            const shopSelect = $('#shop');
            const currentShopValue = shopSelect.val();

            shopSelect.empty();
            shopSelect.append('<option value="ALL" selected>All Shops</option>');

            if (shops && shops.length > 0) {
                console.log(`Populating dropdown with ${shops.length} shops`);

                // Sort shops by code
                const sortedShops = [...shops].sort((a, b) => {
                    const codeA = a.shop_code || a.code || '';
                    const codeB = b.shop_code || b.code || '';
                    return codeA.localeCompare(codeB);
                });

                // Add each shop to dropdown
                sortedShops.forEach(shop => {
                    const shopId = shop.id || shop.shop_id;
                    const shopCode = shop.shop_code || shop.code || `Shop ${shopId}`;

                    shopSelect.append(`<option value="${shopId}">${shopCode}</option>`);
                });

                // Try to restore previous selection
                if (currentShopValue !== 'ALL' && shops.some(s => (s.id || s.shop_id) == currentShopValue)) {
                    shopSelect.val(currentShopValue);
                }

                console.log("Shop dropdown populated successfully");
            } else {
                console.log("No shops available for selected location");
                shopSelect.append('<option value="ALL" selected>No shops available</option>');
            }

            // Shop dropdown is always enabled
            shopSelect.prop('disabled', false);
        }

        // Populate scheme category dropdowns
        function populateSchemeCategoryDropdowns() {
            // Update all three category dropdowns
            for (let i = 1; i <= 3; i++) {
                const categorySelect = $(`#schemeCategory${i}`);
                const currentValue = categorySelect.val();

                categorySelect.empty();
                categorySelect.append('<option value="ALL" selected>Select Category</option>');

                if (API_DATA.schemeCategories && API_DATA.schemeCategories.length > 0) {
                    console.log(`Populating scheme category dropdown ${i}`);

                    // Get unique categories
                    const uniqueCategories = [];
                    const seenTypes = new Set();

                    API_DATA.schemeCategories.forEach(item => {
                        if (item.scheme_type && item.scheme_type.trim() !== '' && !seenTypes.has(item.scheme_type)) {
                            seenTypes.add(item.scheme_type);
                            uniqueCategories.push({
                                id: item.id,
                                type: item.scheme_type,
                                category: item.scheme_category
                            });
                        }
                    });

                    // Sort by type name
                    uniqueCategories.sort((a, b) => a.type.localeCompare(b.type));

                    // Add categories to dropdown
                    uniqueCategories.forEach(item => {
                        // Use scheme_type for both value and display text
                        const value = item.category;
                        const display = item.type;
                        categorySelect.append(`<option value="${value}">${display}</option>`);
                    });

                    // Try to restore previous selection
                    if (currentValue && currentValue !== 'ALL') {
                        // Check if the value exists in the dropdown
                        const exists = uniqueCategories.some(item => item.type === currentValue);
                        if (exists) {
                            categorySelect.val(currentValue);
                        }
                    }

                    console.log(`Scheme category dropdown ${i} populated with ${uniqueCategories.length} categories`);
                } else {
                    console.log("No scheme categories available");
                    categorySelect.append('<option value="ALL" selected>No categories available</option>');
                }
            }
        }

        // Populate scheme dropdown for a specific position
        function populateSchemeDropdown(position, category) {
            const schemeSelect = $(`#schemeList${position}`);
            const currentValue = schemeSelect.val();

            schemeSelect.empty();
            schemeSelect.append('<option value="ALL" selected>All Schemes</option>');

            let schemes = [];

            if (category === 'ALL') {
                // Show all schemes
                schemes = API_DATA.allSchemes;
            } else {
                // Filter schemes by category - use schemetype field
                schemes = API_DATA.allSchemes.filter(scheme =>
                    scheme.schemetype === category
                );
            }

            if (schemes && schemes.length > 0) {
                console.log(`Populating scheme dropdown ${position} with ${schemes.length} schemes for category ${category}`);

                // Sort schemes by name
                const sortedSchemes = [...schemes].sort((a, b) => {
                    const nameA = a.scheme_name || a.name || '';
                    const nameB = b.scheme_name || b.name || '';
                    return nameA.localeCompare(nameB);
                });

                // Add schemes to dropdown
                sortedSchemes.forEach(scheme => {
                    const schemeId = scheme.scheme_id || scheme.id;
                    const schemeName = scheme.scheme_name || scheme.name || 'Unknown Scheme';

                    schemeSelect.append(`<option value="${schemeId}">${schemeName}</option>`);
                });

                // Try to restore previous selection
                if (currentValue && currentValue !== 'ALL' && schemes.some(s => (s.scheme_id || s.id) == currentValue)) {
                    schemeSelect.val(currentValue);
                }

                console.log(`Scheme dropdown ${position} populated successfully`);
            } else {
                console.log(`No schemes available for category ${category}`);
                schemeSelect.append('<option value="ALL" selected>No schemes available</option>');
            }
        }

        // ================== EVENT HANDLER FUNCTIONS ==================

        // Handle district change
        async function handleDistrictChange() {
            const districtId = $('#district').val();
            console.log("District changed to:", districtId);

            // Reset dependent dropdowns
            $('#taluk').html('<option value="ALL" selected>Loading taluks...</option>');
            $('#taluk').prop('disabled', true);
            $('#village').html('<option value="ALL" selected>Select taluk first</option>');
            $('#village').prop('disabled', true);
            $('#shop').html('<option value="ALL" selected>Select village first</option>');

            if (districtId !== 'ALL') {
                try {
                    // Load taluks for selected district
                    const taluks = await loadTaluks(districtId);
                    populateTalukDropdown(taluks);

                    // Clear village and shop data
                    API_DATA.filteredVillages = [];
                    API_DATA.filteredShops = [];
                } catch (error) {
                    console.error("Error loading taluks:", error);
                    $('#taluk').html('<option value="ALL" selected>Error loading taluks</option>');
                }
            } else {
                // If "All Districts" is selected, enable taluk dropdown with empty options
                $('#taluk').html('<option value="ALL" selected>All Taluks</option>');
                $('#taluk').prop('disabled', false);

                // Clear all filtered data
                API_DATA.filteredTaluks = [];
                API_DATA.filteredVillages = [];
                API_DATA.filteredShops = [];
            }
        }

        // Handle taluk change
        async function handleTalukChange() {
            const districtId = $('#district').val();
            const talukId = $('#taluk').val();

            console.log("Taluk changed to:", talukId);

            // Reset dependent dropdowns
            $('#village').html('<option value="ALL" selected>Loading villages...</option>');
            $('#village').prop('disabled', true);
            $('#shop').html('<option value="ALL" selected>Select village first</option>');

            if (districtId !== 'ALL' && talukId !== 'ALL') {
                try {
                    // Load villages for selected district and taluk
                    const villages = await loadVillages(districtId, talukId);
                    populateVillageDropdown(villages);

                    // Clear shop data
                    API_DATA.filteredShops = [];
                } catch (error) {
                    console.error("Error loading villages:", error);
                    $('#village').html('<option value="ALL" selected>Error loading villages</option>');
                }
            } else {
                // If "All Taluks" is selected, enable village dropdown with empty options
                $('#village').html('<option value="ALL" selected>All Villages</option>');
                $('#village').prop('disabled', false);

                // Clear village and shop data
                API_DATA.filteredVillages = [];
                API_DATA.filteredShops = [];
            }
        }

        // Handle village change
        async function handleVillageChange() {
            const districtId = $('#district').val();
            const talukId = $('#taluk').val();
            const villageId = $('#village').val();

            console.log("Village changed to:", villageId);

            // Reset shop dropdown
            $('#shop').html('<option value="ALL" selected>Loading shops...</option>');

            if (districtId !== 'ALL' && talukId !== 'ALL' && villageId !== 'ALL') {
                try {
                    // Load shops for selected district, taluk, and village
                    const shops = await loadShops(districtId, talukId, villageId);
                    populateShopDropdown(shops);
                } catch (error) {
                    console.error("Error loading shops:", error);
                    $('#shop').html('<option value="ALL" selected>Error loading shops</option>');
                }
            } else {
                // If "All Villages" is selected, show all shops option
                $('#shop').html('<option value="ALL" selected>All Shops</option>');
                API_DATA.filteredShops = [];
            }
        }

        // Handle scheme category change
        async function handleSchemeCategoryChange(position) {
            const categorySelect = $(`#schemeCategory${position}`);
            const category = categorySelect.val();

            console.log(`Scheme category ${position} changed to:`, category);

            // Update scheme dropdown
            const schemeSelect = $(`#schemeList${position}`);
            schemeSelect.html('<option value="ALL" selected>Loading schemes...</option>');

            if (category !== 'ALL') {
                try {
                    // Check if we have schemes cached for this category
                    if (!API_DATA.filteredSchemesByCategory[category] || API_DATA.filteredSchemesByCategory[category].length === 0) {
                        // Load schemes for this category
                        console.log(`Loading schemes for category: ${category}`);
                        const schemes = await loadSchemes(category);
                        console.log(`Loaded ${schemes.length} schemes for category: ${category}`);
                    }

                    // Populate scheme dropdown
                    populateSchemeDropdown(position, category);

                    // Update scheme descriptions if scheme is selected
                    updateSchemeDescriptions();

                } catch (error) {
                    console.error(`Error loading schemes for category ${category}:`, error);
                    schemeSelect.html('<option value="ALL" selected>Error loading schemes</option>');
                }
            } else {
                // If "ALL" is selected, populate with all schemes
                if (API_DATA.allSchemes.length === 0) {
                    await loadAllSchemes();
                }
                populateSchemeDropdown(position, 'ALL');
                updateSchemeDescriptions();
            }

            // Apply filters
            applyFilters();
        }

        // ================== INITIALIZATION FUNCTION ==================

        // Initialize all data
        async function initializeAllData() {
            try {
                console.log("Initializing all data...");

                // Load districts
                await loadDistricts();
                populateDistrictDropdown();

                // Load scheme categories
                await loadSchemeCategories();
                populateSchemeCategoryDropdowns();

                // Load all schemes initially
                await loadAllSchemes();

                // Initialize scheme dropdowns with "ALL" option
                for (let i = 1; i <= 3; i++) {
                    populateSchemeDropdown(i, 'ALL');
                }

                // Test API array format
                console.log("Testing API array format compatibility...");
                const apiTestResult = await testApiArrayFormat();

                if (apiTestResult) {
                    console.log(" API array format test PASSED");
                    // Show success message
                    $('#activeFiltersDisplay').html(`
                    <span class="active-filter-badge" style="background:#28a745;">
                        <i class="bi bi-check-circle"></i> API Array Format: Supported
                    </span>
                `);
                } else {
                    console.log(" API array format test FAILED - Using fallback method");
                    // Show warning message
                    $('#activeFiltersDisplay').html(`
                    <span class="active-filter-badge" style="background:#ffc107;">
                        <i class="bi bi-exclamation-triangle"></i> API Array Format: Testing required
                    </span>
                `);
                }

                console.log("All data initialized successfully");

            } catch (error) {
                console.error('Initialization error:', error);

                // Fallback initialization
                populateDistrictDropdown();
                populateSchemeCategoryDropdowns();

                for (let i = 1; i <= 3; i++) {
                    $(`#schemeList${i}`).html('<option value="ALL" selected>All Schemes</option>');
                }
            }
        }
        // ================== EVENT LISTENERS SETUP ==================
        function debugFilters() {
            console.log("=== FILTER DEBUG INFO ===");

            // Collect all filter values
            const filters = {
                district: $('#district').val(),
                taluk: $('#taluk').val(),
                village: $('#village').val(),
                shop: $('#shop').val(),
                gender: $('#gender').val(),
                schemeLogic: schemeLogic
            };

            // Collect scheme filters
            const schemeFilters = [];
            for (let i = 1; i <= 3; i++) {
                const category = $(`#schemeCategory${i}`).val();
                const schemeId = $(`#schemeList${i}`).val();
                if (schemeId !== 'ALL' && category !== 'ALL') {
                    schemeFilters.push({
                        position: i,
                        category: category,
                        schemeId: schemeId,
                        schemeName: $(`#schemeList${i} option:selected`).text()
                    });
                }
            }

            console.log("Geographic Filters:", filters);
            console.log("Scheme Filters:", schemeFilters);
            console.log("Scheme Logic:", schemeLogic);

            // Build expected API payload
            let expectedFilterConditions = {};

            // Add geographic filters
            if (filters.district !== 'ALL') expectedFilterConditions.district_id = filters.district;
            if (filters.taluk !== 'ALL') expectedFilterConditions.taluk_id = filters.taluk;
            if (filters.village !== 'ALL') expectedFilterConditions.village_id = filters.village;

            // Add scheme filters as array
            if (schemeFilters.length > 0) {
                const schemeIds = schemeFilters.map(s => s.schemeId);
                expectedFilterConditions.type_id = schemeIds;
            }

            console.log("Expected API Filter Conditions:", JSON.stringify(expectedFilterConditions, null, 2));

            alert(`Debug Info:\n\nScheme Filters: ${schemeFilters.length}\nScheme Logic: ${schemeLogic}\n\nCheck console for details.`);
        }

        function addDebugButton() {
            const debugBtn = $('<button>')
                .addClass('btn btn-sm btn-outline-info ms-2')
                .html('<i class="bi bi-bug"></i> Debug')
                .click(debugFilters);

            $('.justify-content-end').append(debugBtn);
        }

        // Set up event listeners
        function setupEventListeners() {
            console.log("Setting up enhanced event listeners");

            // Geographic filters
            $('#district').on('change', handleDistrictChange);
            $('#taluk').on('change', handleTalukChange);
            $('#village').on('change', handleVillageChange);
            $('#shop').on('change', applyFilters);

            // Demographic filters
            $('#gender, #ageMin, #ageMax, #dateFrom, #dateTo').on('change', applyFilters);

            // Scheme category filters
            for (let i = 1; i <= 3; i++) {
                $(`#schemeCategory${i}`).on('change', function () {
                    handleSchemeCategoryChange(i);
                });
            }

            // Scheme list filters
            for (let i = 1; i <= 3; i++) {
                $(`#schemeList${i}`).on('change', function () {
                    updateSchemeDescriptions();
                    applyFilters();
                });
            }

            // Add debug button
            addDebugButton();

            console.log("Event listeners setup complete");
        }
        // ================== SCHEME DESCRIPTIONS ==================

        // Update scheme descriptions with real data
        async function updateSchemeDescriptions() {
            const descriptionsContainer = $('#schemeDescriptions');
            descriptionsContainer.empty();

            // Check if any schemes are selected
            let selectedSchemes = [];
            let schemeIds = [];

            for (let i = 1; i <= 3; i++) {
                const schemeSelect = $(`#schemeList${i}`);
                const categorySelect = $(`#schemeCategory${i}`);
                const selectedSchemeId = schemeSelect.val();
                const selectedCategory = categorySelect.val();

                if (selectedSchemeId !== 'ALL' && selectedCategory !== 'ALL') {
                    // Find the scheme details
                    const scheme = API_DATA.allSchemes.find(s =>
                        (s.scheme_id || s.id) == selectedSchemeId
                    );

                    if (scheme) {
                        selectedSchemes.push({
                            schemeId: selectedSchemeId,
                            schemeName: scheme.scheme_name || scheme.name || 'Unknown Scheme',
                            category: scheme.schemetype || selectedCategory,
                            position: i
                        });
                        schemeIds.push(selectedSchemeId);
                    }
                }
            }

            if (selectedSchemes.length === 0) {
                // No schemes selected
                descriptionsContainer.html(`
                <div class="text-center text-muted py-4">
                    <i class="bi bi-stars fs-1 mb-2 d-block"></i>
                    <p>Select dream schemes to view descriptions</p>
                    <small class="text-muted">Select scheme categories and specific schemes to see details</small>
                </div>
            `);
                return;
            }

            // Show loading state
            descriptionsContainer.html(`
            <div class="text-center py-3">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading scheme descriptions...</p>
            </div>
        `);

            try {
                // Load descriptions for all selected schemes in one API call
                const allDescriptions = await loadSchemeDescriptions(schemeIds);

                // Group descriptions by scheme ID for display
                const descriptionsByScheme = {};
                selectedSchemes.forEach(scheme => {
                    descriptionsByScheme[scheme.schemeId] = {
                        scheme: scheme,
                        descriptions: []
                    };
                });

                // Sort descriptions into their respective schemes
                if (Array.isArray(allDescriptions)) {
                    allDescriptions.forEach(desc => {
                        const schemeId = String(desc.type_id);
                        if (descriptionsByScheme[schemeId]) {
                            descriptionsByScheme[schemeId].descriptions.push(desc);
                        }
                    });
                }

                // Prepare data for display
                const schemeDescriptionData = Object.values(descriptionsByScheme);

                displaySchemeDescriptions(schemeDescriptionData);

            } catch (error) {
                console.error('Error loading scheme descriptions:', error);
                descriptionsContainer.html(`
                <div class="text-center text-danger py-4">
                    <i class="bi bi-exclamation-triangle fs-1 mb-2 d-block"></i>
                    <p>Error loading scheme descriptions</p>
                    <small class="text-muted">Please try again</small>
                </div>
            `);
            }
        }

        // Display scheme descriptions
        function displaySchemeDescriptions(allDescriptions) {
            const descriptionsContainer = $('#schemeDescriptions');
            descriptionsContainer.empty();

            if (allDescriptions.length === 0) {
                descriptionsContainer.html(`
                <div class="text-center text-muted py-4">
                    <i class="bi bi-stars fs-1 mb-2 d-block"></i>
                    <p>No descriptions found for selected schemes</p>
                    <small class="text-muted">Try selecting different schemes or adjust filters</small>
                </div>
            `);
                return;
            }

            // Create HTML for each scheme's descriptions
            allDescriptions.forEach((item, index) => {
                const cardHtml = createSchemeDescriptionCard(item.scheme, item.descriptions);
                if (index === 0) {
                    descriptionsContainer.append(cardHtml);
                } else {
                    descriptionsContainer.append('<hr class="my-3">' + cardHtml);
                }
            });
        }

        // Create HTML card for scheme descriptions
        function createSchemeDescriptionCard(schemeInfo, descriptions) {
            const hasDescriptions = descriptions && descriptions.length > 0;

            let descriptionContent = '';

            if (hasDescriptions) {
                // Group descriptions by district
                const descriptionsByDistrict = {};

                descriptions.forEach(desc => {
                    const district = desc.district_name || 'Unknown District';
                    if (!descriptionsByDistrict[district]) {
                        descriptionsByDistrict[district] = [];
                    }
                    descriptionsByDistrict[district].push(desc);
                });

                // Create collapsible sections for each district
                const districtSections = Object.keys(descriptionsByDistrict).map(district => {
                    const districtDesc = descriptionsByDistrict[district];
                    const uniqueCount = new Set(districtDesc.map(d => d.suggestion_remarks)).size;

                    return `
                    <div class="accordion-item mb-1">
                        <h2 class="accordion-header" id="heading-${schemeInfo.schemeId}-${district.replace(/\s+/g, '-')}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-${schemeInfo.schemeId}-${district.replace(/\s+/g, '-')}" 
                                    aria-expanded="false" aria-controls="collapse-${schemeInfo.schemeId}-${district.replace(/\s+/g, '-')}">
                                <i class="bi bi-geo-alt me-2"></i>
                                ${district}
                                <span class="badge bg-primary ms-2">${districtDesc.length} entries</span>
                                <span class="badge bg-info ms-1">${uniqueCount} unique remarks</span>
                            </button>
                        </h2>
                        <div id="collapse-${schemeInfo.schemeId}-${district.replace(/\s+/g, '-')}" 
                             class="accordion-collapse collapse" 
                             aria-labelledby="heading-${schemeInfo.schemeId}-${district.replace(/\s+/g, '-')}">
                            <div class="accordion-body p-0">
                                <div class="list-group list-group-flush">
                                    ${districtDesc.slice(0, 10).map((desc, idx) => `
                                        <div class="list-group-item p-2 border-bottom">
                                            <div class="d-flex justify-content-between align-items-start mb-1">
                                                <div>
                                                    <small class="text-muted">
                                                        <i class="bi bi-calendar me-1"></i>
                                                        ${desc.created_ts ? new Date(desc.created_ts).toLocaleDateString() : 'N/A'}
                                                    </small>
                                                    ${desc.taluk_name ? `<small class="text-muted ms-2"><i class="bi bi-geo me-1"></i>${desc.taluk_name}</small>` : ''}
                                                    ${desc.village_name ? `<small class="text-muted ms-2"><i class="bi bi-geo-alt me-1"></i>${desc.village_name}</small>` : ''}
                                                </div>
                                                <span class="badge ${desc.active === 1 ? 'bg-success' : 'bg-secondary'}">
                                                    ${desc.active === 1 ? 'Active' : 'Inactive'}
                                                </span>
                                            </div>
                                            <div class="mt-1">
                                                <p class="mb-1 fw-semibold">Description:</p>
                                                <div class="bg-light p-1 rounded">
                                                    ${desc.suggestion_remarks || '<em class="text-muted">No remarks provided</em>'}
                                                </div>
                                            </div>
                                            ${desc.shopcode ? `
                                                <div class="mt-1">
                                                    <small class="text-muted">
                                                        <i class="bi bi-shop me-1"></i>
                                                        Shop: ${desc.shopcode}
                                                    </small>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                    ${districtDesc.length > 10 ? `
                                        <div class="list-group-item p-2 text-center">
                                            <small class="text-muted">
                                                ...and ${districtDesc.length - 10} more entries
                                            </small>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

                descriptionContent = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="mb-1 fw-bold">${descriptions.length} Description${descriptions.length !== 1 ? 's' : ''} Found</h6>
                            <small class="text-muted">Across ${Object.keys(descriptionsByDistrict).length} districts</small>
                        </div>
                        <span class="badge bg-warning">${schemeInfo.category}</span>
                    </div>
                    <div class="accordion" id="accordion-${schemeInfo.schemeId}">
                        ${districtSections}
                    </div>
                </div>
            `;
            } else {
                descriptionContent = `
                <div class="text-center py-3">
                    <i class="bi bi-chat-dots fs-4 text-muted mb-2 d-block"></i>
                    <p class="text-muted mb-0">No descriptions found for this scheme</p>
                    <small class="text-muted">Try adjusting filters or select a different scheme</small>
                </div>
            `;
            }

            return `
            <div class="scheme-description-card p-2 mb-2">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h5 class="fw-bold mb-1">${schemeInfo.schemeName}</h5>
                        <small class="text-muted">Dream Scheme ${schemeInfo.position}</small>
                    </div>
                    <div class="d-flex gap-1">
                        <span class="badge bg-warning">${schemeInfo.category}</span>
                        <span class="badge bg-info">ID: ${schemeInfo.schemeId}</span>
                    </div>
                </div>
                
                ${descriptionContent}
                
                <div class="mt-2 pt-2 border-top">
                    <div class="row g-1">
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="bi bi-database me-1"></i>
                                Total entries: ${hasDescriptions ? descriptions.length : 0}
                            </small>
                        </div>
                        <div class="col-6 text-end">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                Updated just now
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }

        // ================== CHART FUNCTIONS ==================

        // Update geographic distribution pie chart
        function updateGeographicDistributionChart(filteredData) {
            if (!pieChart) {
                pieChart = echarts.init(document.getElementById("pie"));
            }

            // Group data by district
            const districtCounts = {};
            let totalCount = 0;

            filteredData.forEach(item => {
                const districtName = item.district_name || 'Unknown District';
                if (!districtCounts[districtName]) {
                    districtCounts[districtName] = 0;
                }
                districtCounts[districtName]++;
                totalCount++;
            });

            // Prepare chart data
            const chartData = Object.keys(districtCounts).map(district => ({
                name: district,
                value: districtCounts[district]
            }));

            // Sort by count (descending)
            chartData.sort((a, b) => b.value - a.value);

            // Take top 10 districts, group the rest as "Others"
            let displayData = [];
            if (chartData.length > 10) {
                const top10 = chartData.slice(0, 10);
                const others = chartData.slice(10);
                const othersTotal = others.reduce((sum, item) => sum + item.value, 0);

                displayData = [...top10, { name: 'Other Districts', value: othersTotal }];
            } else {
                displayData = chartData;
            }

            // Update summary cards
            updateSummaryCards(filteredData);

            // Chart options
            const option = {
                title: {
                    text: `Geographic Distribution (Total: ${totalCount})`,
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                legend: {
                    type: 'scroll',
                    orient: 'vertical',
                    right: 10,
                    top: 'middle',
                    height: '80%',
                    textStyle: {
                        fontSize: 12
                    }
                },
                series: [
                    {
                        name: 'District Distribution',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['35%', '50%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '18',
                                fontWeight: 'bold',
                                formatter: '{b}\n{c} ({d}%)'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: displayData,
                        color: [
                            '#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de',
                            '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc', '#60acfc',
                            '#ff9f7f'
                        ]
                    }
                ]
            };

            pieChart.setOption(option);

            // Update filter summary text
            const districtCount = Object.keys(districtCounts).length;
            $('#filterSummary').text(`(${totalCount} records across ${districtCount} district${districtCount !== 1 ? 's' : ''})`);
        }

        // Update summary cards
        function updateSummaryCards(filteredData) {
            const totalCount = filteredData.length;

            // Count unique districts
            const uniqueDistricts = new Set();
            const uniqueVillages = new Set();

            filteredData.forEach(item => {
                if (item.district_name) uniqueDistricts.add(item.district_name);
                if (item.village_name) uniqueVillages.add(item.village_name);
            });

            // Update summary cards
            $('#totalFamiliesCount').text(totalCount.toLocaleString());
            $('#activeFamiliesCount').text(totalCount.toLocaleString()); // Assuming all are active
            $('#totalDistrictsCount').text(uniqueDistricts.size.toLocaleString());
            $('#totalVillagesCount').text(uniqueVillages.size.toLocaleString());
        }

        // ================== FILTER FUNCTIONS ==================

        // Update scheme filter logic
        function updateSchemeLogic(logic) {
            schemeLogic = logic;
            document.getElementById('schemeLogicIndicator').textContent = `${logic} Logic`;
            console.log(`Scheme logic changed to: ${logic}`);
            applyFilters();
        }

        // Main filter function
        async function applyFilters() {
            console.log("========== APPLYING FILTERS ==========");

            // Show loading state
            $('#filterSummary').text('Loading data...');
            $('#totalFamiliesCount').text('0');
            $('#activeFamiliesCount').text('0');
            $('#totalDistrictsCount').text('0');
            $('#totalVillagesCount').text('0');

            // Collect all filter values
            const filters = {
                district: $('#district').val(),
                taluk: $('#taluk').val(),
                village: $('#village').val(),
                shop: $('#shop').val(),
                gender: $('#gender').val(),
                ageMin: $('#ageMin').val(),
                ageMax: $('#ageMax').val(),
                dateFrom: $('#dateFrom').val(),
                dateTo: $('#dateTo').val(),
                filterLogic: filterLogic,
                schemeLogic: schemeLogic
            };

            // Collect scheme filters
            for (let i = 1; i <= 3; i++) {
                filters[`schemeCategory${i}`] = $(`#schemeCategory${i}`).val();
                filters[`schemeList${i}`] = $(`#schemeList${i}`).val();
            }

            console.log("Active filters:", filters);

            // Update filter summary
            updateFilterSummary(filters);

            try {
                // Call the filter API
                const filteredData = await loadFilteredData(filters);

                // Update the chart with filtered data
                updateGeographicDistributionChart(filteredData);

                // Also update scheme descriptions
                updateSchemeDescriptions();

                console.log("========== FILTERS APPLIED SUCCESSFULLY ==========");

            } catch (error) {
                console.error('Error applying filters:', error);
                $('#filterSummary').text('Error loading data');

                // Clear chart
                if (pieChart) {
                    pieChart.clear();
                }

                // Show error message
                alert('Error loading data. Please check your filters and try again.');
            }
        }

        // Update filter summary display
        function updateFilterSummary(filters) {
            const summaryDiv = $('#activeFiltersDisplay');
            summaryDiv.empty();

            // Add geographic filters
            if (filters.district !== 'ALL') {
                const districtName = $('#district option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> District: ${districtName}</span>`);
            }

            if (filters.taluk !== 'ALL') {
                const talukName = $('#taluk option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> Taluk: ${talukName}</span>`);
            }

            if (filters.village !== 'ALL') {
                const villageName = $('#village option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> Village: ${villageName}</span>`);
            }

            if (filters.shop !== 'ALL') {
                const shopName = $('#shop option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-shop"></i> Shop: ${shopName}</span>`);
            }

            // Add demographic filters
            // if (filters.gender !== 'ALL') {
            //     summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-gender-ambiguous"></i> Gender: ${filters.gender}</span>`);
            // }

            // if (filters.ageMin !== '18' || filters.ageMax !== '80') {
            //     summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-calendar3"></i> Age: ${filters.ageMin}-${filters.ageMax}</span>`);
            // }

            // Add scheme filters
            const selectedSchemes = [];
            for (let i = 1; i <= 3; i++) {
                const category = filters[`schemeCategory${i}`];
                const schemeId = filters[`schemeList${i}`];

                if (category !== 'ALL' && schemeId !== 'ALL') {
                    const schemeName = $(`#schemeList${i} option:selected`).text();
                    const categoryName = $(`#schemeCategory${i} option:selected`).text();
                    selectedSchemes.push(`${categoryName}: ${schemeName}`);
                }
            }

            if (selectedSchemes.length > 0) {
                const logicText = schemeLogic === 'AND' ? 'AND' : 'OR';
                const schemesText = selectedSchemes.join(` ${logicText} `);
                summaryDiv.append(`<span class="active-filter-badge" style="background:#f59e0b;"><i class="bi bi-card-checklist"></i> Schemes (${logicText}): ${schemesText}</span>`);

                // Show array format info
                summaryDiv.append(`<span class="active-filter-badge" style="background:#28a745;"><i class="bi bi-code"></i> API Format: Array</span>`);
            }

            // Add logic badge
            summaryDiv.append(`<span class="active-filter-badge" style="background:#6c757d;"><i class="bi bi-funnel"></i> Logic: ${schemeLogic}</span>`);
        }
        // Reset all filters
        function resetAll() {
            console.log("Resetting all filters...");

            // Reset geographic filters
            $('#district').val('ALL').trigger('change');
            $('#taluk').val('ALL').prop('disabled', false);
            $('#village').val('ALL').prop('disabled', false);
            $('#shop').val('ALL');

            // Reset demographic filters
            $('#gender').val('ALL');
            $('#ageMin').val(18);
            $('#ageMax').val(80);

            // Reset dates
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            $('#dateFrom').val(oneYearAgo.toISOString().split('T')[0]);
            $('#dateTo').val(today.toISOString().split('T')[0]);

            // Reset scheme filters
            for (let i = 1; i <= 3; i++) {
                $(`#schemeCategory${i}`).val('ALL');
                $(`#schemeList${i}`).val('ALL');
            }

            // Reset logic to AND
            $('#schemeLogicAND').prop('checked', true);
            schemeLogic = 'AND';
            document.getElementById('schemeLogicIndicator').textContent = 'AND Logic';

            // Reset scheme descriptions
            updateSchemeDescriptions();

            // Clear filter summary
            $('#activeFiltersDisplay').empty();

            // Clear chart and summary
            if (pieChart) {
                pieChart.clear();
            }
            $('#filterSummary').text('');
            $('#totalFamiliesCount').text('0');
            $('#activeFamiliesCount').text('0');
            $('#totalDistrictsCount').text('0');
            $('#totalVillagesCount').text('0');

            // Apply filters to load default data
            applyFilters();

            console.log("All filters reset successfully");
        }

        // ================== EXPORT FUNCTIONS ==================

        // Export CSV
        function exportCSV() {
            if (API_DATA.filteredData.length === 0) {
                alert('No data to export. Please apply filters first.');
                return;
            }

            try {
                // Prepare CSV headers
                const headers = [
                    'District', 'Taluk', 'Village', 'Shop Code', 'Scheme Name',
                    'Type', 'Suggestion Remarks', 'Created Date', 'Status'
                ];

                // Prepare CSV rows
                const rows = API_DATA.filteredData.map(item => [
                    item.district_name || '',
                    item.taluk_name || '',
                    item.village_name || '',
                    item.shopcode || '',
                    item.scheme_name || '',
                    item.type || '',
                    item.suggestion_remarks || '',
                    item.created_ts ? new Date(item.created_ts).toLocaleDateString() : '',
                    item.active === 1 ? 'Active' : 'Inactive'
                ]);

                // Create CSV content
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', `dream_scheme_data_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert(`Exported ${API_DATA.filteredData.length} records to CSV`);
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting data. Please try again.');
            }
        }

        // Export PDF
        function exportPDF() {
            if (API_DATA.filteredData.length === 0) {
                alert('No data to export. Please apply filters first.');
                return;
            }

            try {
                // Use html2canvas to capture the chart
                html2canvas(document.getElementById('pie'), {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');

                    // Create PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('landscape');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();

                    // Add title
                    pdf.setFontSize(16);
                    pdf.text('Dream Scheme Analytics Report', pageWidth / 2, 15, { align: 'center' });

                    // Add date
                    pdf.setFontSize(10);
                    pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, 22, { align: 'center' });

                    // Add summary statistics
                    pdf.setFontSize(12);
                    pdf.text(`Total Records: ${API_DATA.filteredData.length}`, 20, 35);

                    // Count unique districts
                    const uniqueDistricts = new Set(API_DATA.filteredData.map(item => item.district_name).filter(Boolean));
                    pdf.text(`Districts: ${uniqueDistricts.size}`, 20, 42);

                    // Add chart image
                    const imgWidth = pageWidth - 40;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 20, 50, imgWidth, imgHeight);

                    // Add filter summary
                    const filterText = $('#activeFiltersDisplay').text().substring(0, 100) + '...';
                    pdf.setFontSize(10);
                    pdf.text(`Filters Applied: ${filterText}`, 20, imgHeight + 60);

                    // Save PDF
                    pdf.save(`dream_scheme_report_${new Date().toISOString().split('T')[0]}.pdf`);

                    alert('PDF exported successfully!');
                });
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Error exporting PDF. Please try again.');
            }
        }

        // ================== SIDEBAR FUNCTIONS ==================

        // Sidebar functions
        function toggleSidebar() {
            $("#sidebar").toggleClass("collapsed");
            $("#main").toggleClass("collapsed");
            setTimeout(() => {
                if (pieChart) {
                    pieChart.resize();
                }
            }, 300);
        }

        // Initialize sidebar for mobile
        if (window.innerWidth <= 768) {
            document.getElementById("sidebar").classList.add("collapsed");
            document.getElementById("main").classList.add("collapsed");
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener("click", function (e) {
            if (window.innerWidth <= 768) {
                let sidebar = document.getElementById("sidebar");
                let btn = document.querySelector(".bi-list");

                if (btn && !sidebar.contains(e.target) && !btn.contains(e.target)) {
                    sidebar.classList.add("collapsed");
                }
            }
        });

        // Initialize charts on window resize
        window.addEventListener('resize', function () {
            if (pieChart) {
                pieChart.resize();
            }
        });

        // Load initial data when page loads
        $(window).on('load', function () {
            // Apply filters to load initial data after a short delay
            setTimeout(() => {
                applyFilters();
            }, 1500);
        });
    </script>

</body>

</html>