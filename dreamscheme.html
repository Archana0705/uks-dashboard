<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>UKS Analytics - Dream Scheme</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background: #f5f7fb;
            font-family: Inter, system-ui;
        }

        .app-header {
            background: linear-gradient(135deg, #ffffff, #f8f9ff);
            border-bottom: 1px solid #eee;
            height: 64px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2000;
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: .3px;
        }

        .filter-bar {
            position: sticky;
            top: 64px;
            background: white;
            z-index: 9;
            border-radius: 14px;
            margin: 5px 12px;
            padding: 10px !important;
        }

        .filter-bar label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
            margin-bottom: 4px !important;
        }

        .form-select,
        .form-range,
        .form-control {
            border-radius: 10px;
            padding: 6px 12px !important;
            font-size: 14px !important;
        }

        .card {
            border-radius: 18px;
            border: none;
            background: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .06);
            transition: .25s;
        }

        .card:hover {
            box-shadow: 0 12px 35px rgba(0, 0, 0, .1);
        }

        .chart-actions {
            opacity: 0;
            transition: .2s;
        }

        .card:hover .chart-actions {
            opacity: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            border: none;
            border-radius: 10px;
            padding: 8px 16px !important;
            font-size: 14px;
        }

        .btn-outline-secondary {
            border-radius: 10px;
            padding: 6px 12px !important;
        }

        .app-wrapper {
            display: flex;
        }

        .sidebar {
            position: fixed;
            top: 64px;
            left: 0;
            width: 240px;
            height: calc(100vh - 64px);
            background: linear-gradient(180deg, #f9fafc, #f2f4f9);
            border-right: 1px solid #eee;
            transition: transform .3s ease;
            z-index: 2000;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li.active {
            background: linear-gradient(135deg, #5b5df0, #7b7dff);
            color: white;
            box-shadow: 0 6px 16px rgba(91, 93, 240, .35);
        }

        .sidebar-menu li a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            text-decoration: none;
            color: #444;
            font-size: 14px;
        }

        .sidebar-menu li a:hover {
            background: #f3f5ff;
            color: #4f46e5;
        }

        .main-content {
            margin-left: 240px;
            width: 100%;
            transition: .3s;
            margin-top: 64px;
        }

        .main-content.collapsed {
            margin-left: 0;
        }

        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }

        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px !important;
            margin-bottom: 10px !important;
            border-left: 4px solid;
        }

        .geographic-filter {
            border-left-color: #4f46e5;
        }

        .demographic-filter {
            border-left-color: #10b981;
        }

        .scheme-filter {
            border-left-color: #f59e0b;
        }

        .active-filter-badge {
            background: #4f46e5;
            color: white;
            border-radius: 12px;
            padding: 3px 10px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }

        .logic-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px !important;
        }

        .logic-toggle .btn-group {
            width: 120px;
        }

        .filter-group-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px !important;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .scheme-description-card {
            background: linear-gradient(135deg, #f8f9ff, #ffffff);
            border: 1px solid #e6e8ff;
            transition: transform 0.2s;
            border-radius: 10px;
        }

        .scheme-description-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .scheme-logic-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px !important;
        }

        /* Reduced spacing classes */
        .row.g-2 {
            --bs-gutter-x: 0.5rem;
            --bs-gutter-y: 0.5rem;
        }

        .row.g-3 {
            --bs-gutter-x: 1rem;
            --bs-gutter-y: 1rem;
        }

        .mb-1 {
            margin-bottom: 0.25rem !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .mt-1 {
            margin-top: 0.25rem !important;
        }

        .mt-2 {
            margin-top: 0.5rem !important;
        }

        .mt-3 {
            margin-top: 1rem !important;
        }

        .py-1 {
            padding-top: 0.25rem !important;
            padding-bottom: 0.25rem !important;
        }

        .py-2 {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }

        .py-3 {
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 240px;
            }

            .sidebar.open {
                transform: translateX(0);
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, .25);
            }

            .main-content {
                margin-left: 0 !important;
            }

            .filterWraps {
                width: auto !important;
                margin-left: 15px;
                margin-top: 10px;
            }

            .nomob {
                display: none !important;
            }

            .filter-bar {
                margin: 5px 8px !important;
                padding: 8px !important;
            }

            .filter-section {
                padding: 10px !important;
            }
        }

        @media (max-width: 992px) {
            .chart-row {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            h5 {
                font-size: 16px;
            }

            .app-title {
                font-size: 16px;
            }

            .filter-bar {
                margin: 5px 4px !important;
                padding: 6px !important;
            }
        }

        /* No Remarks Entry Styling */
        .no-remarks-entry {
            border-left: 4px solid #6c757d;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            transition: all 0.3s ease;
        }

        .no-remarks-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .no-remarks-entry .badge {
            font-size: 14px;
            padding: 6px 12px;
            min-width: 50px;
        }

        /* Unique Remarks Styling */
        .remark-entry {
            border-left: 4px solid #4f46e5;
            background: white;
            transition: all 0.3s ease;
            position: relative;
        }

        .remark-entry:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }

        .remark-entry:before {
            content: 'âœ“';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            background: #4f46e5;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .remark-entry:hover:before {
            opacity: 1;
        }

        /* District Header */
        .district-header {
            background: linear-gradient(135deg, #f8f9ff, #ffffff);
            border: 1px solid #e6e8ff;
            transition: all 0.3s ease;
        }

        .district-header:hover {
            border-color: #4f46e5;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
        }

        /* Load More Button */
        .btn-outline-primary {
            border-width: 2px;
            font-weight: 500;
        }

        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: white;
            transform: translateY(-2px);
        }

        /* All Entries Styling */
        .all-entries-list .remark-entry:nth-child(even) {
            background: #f8f9fa;
        }

        .all-entries-list .remark-entry .badge.bg-secondary {
            background: #6c757d !important;
        }

        /* Summary Header */
        .bg-light.rounded {
            border: 1px solid #e9ecef;
        }

        /* Scrollbar for scheme descriptions */
        .scheme-description-card {
            max-height: 70vh;
            overflow-y: auto;
        }

        .scheme-description-card::-webkit-scrollbar {
            width: 6px;
        }

        .scheme-description-card::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .scheme-description-card::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .scheme-description-card::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .no-remarks-entry {
                flex-direction: column !important;
                text-align: center;
            }

            .no-remarks-entry .d-flex.align-items-center {
                justify-content: center;
                margin-bottom: 10px;
            }

            .no-remarks-entry .text-end {
                text-align: center !important;
            }

            .remark-content .bg-light {
                font-size: 13px;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg app-header px-4">
        <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-light" onclick="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <img src="assets/img/tn_logo.png" height="36" class="me-2">
            <span class="ms-2 fw-bold">UKS Analytics</span>
        </div>
        <div class="ms-auto d-flex align-items-center gap-3 nomob">
            <div class="dropdown">
                <button class="btn btn-link text-decoration-none d-flex align-items-center gap-2"
                    data-bs-toggle="dropdown">
                    <span class="text-muted">Welcome, <b>User Name</b></span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i> Profile</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-box-arrow-right me-2"></i>
                            Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="app-wrapper">
        <div id="sidebar" class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="index.html"><i class="bi bi-speedometer2"></i> <span>Dashboard</span></a></li>
                <li><a href="#"><i class="bi bi-people"></i> <span>Beneficiary</span></a></li>
                <li><a href="#"><i class="bi bi-card-checklist"></i> <span>Beneficial Scheme</span></a></li>
                <li class="active"><a href="dreamscheme.html"><i class="bi bi-stars"></i> <span>Dream Scheme</span></a>
                </li>
            </ul>
        </div>

        <div id="main" class="main-content">
            <button class="btn btn-outline-primary w-100 d-md-none filterWraps" data-bs-toggle="collapse"
                data-bs-target="#mobileFilters">
                <i class="bi bi-funnel"></i> Filters
            </button>

            <div id="mobileFilters" class="collapse d-md-block">
                <div class="filter-bar shadow-sm">
                    <!-- Logic Toggle -->
                    <div class="logic-toggle">
                        <!-- <span class="filter-group-title">Overall Filter Logic:</span> -->
                    </div>

                    <!-- Geographic Filters -->
                    <div class="filter-section geographic-filter">
                        <div class="filter-group-title">
                            <i class="bi bi-geo-alt"></i>
                            Geographic Filters
                        </div>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3">
                                <label>District</label>
                                <select id="district" class="form-select">
                                    <option value="ALL" selected>Loading districts...</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label>Taluk</label>
                                <select id="taluk" class="form-select">
                                    <option value="ALL" selected>Select Taluk</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label>Village</label>
                                <select id="village" class="form-select">
                                    <option value="ALL" selected>Select Village</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label>Shop/Outlet</label>
                                <select id="shop" class="form-select">
                                    <option value="ALL" selected>All Shops</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Demographic Filters -->
                    <!-- <div class="filter-section demographic-filter">
                        <div class="filter-group-title">
                            <i class="bi bi-people"></i>
                            Demographic Filters
                        </div>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3">
                                <label>Gender</label>
                                <select id="gender" class="form-select">
                                    <option value="ALL" selected>All Genders</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label>Age Range</label>
                                <div class="d-flex gap-2">
                                    <input type="number" id="ageMin" class="form-control" placeholder="Min" min="18"
                                        max="100" value="18">
                                    <input type="number" id="ageMax" class="form-control" placeholder="Max" min="18"
                                        max="100" value="80">
                                </div>
                            </div>

                            <div class="col-md-3">
                                <label>Date Range</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="date" id="dateFrom" class="form-control form-control-sm"
                                        value="2024-01-01">
                                    <span class="text-muted">to</span>
                                    <input type="date" id="dateTo" class="form-control form-control-sm"
                                        value="2024-12-31">
                                </div>
                            </div>
                        </div>
                    </div> -->

                    <!-- Scheme Filters - Top 3 -->
                    <div class="filter-section scheme-filter">
                        <div class="filter-group-title">
                            <i class="bi bi-card-checklist"></i>
                            Scheme Filters
                        </div>

                        <!-- Scheme Logic Toggle -->
                        <div class="scheme-logic-toggle">
                            <span class="filter-group-title" style="margin-bottom: 0;">Scheme Logic:</span>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="schemeLogic" id="schemeLogicAND"
                                    autocomplete="off" checked onclick="updateSchemeLogic('AND')">
                                <label class="btn btn-outline-warning" for="schemeLogicAND">AND</label>

                                <input type="radio" class="btn-check" name="schemeLogic" id="schemeLogicOR"
                                    autocomplete="off" onclick="updateSchemeLogic('OR')">
                                <label class="btn btn-outline-warning" for="schemeLogicOR">OR</label>
                            </div>
                            <span id="schemeLogicIndicator" class="badge bg-warning">AND Logic</span>
                        </div>

                        <div class="row g-2 align-items-end mt-2">
                            <!-- Scheme Category 1 -->
                            <div class="col-md-4">
                                <label>Scheme Category 1</label>
                                <select id="schemeCategory1" class="form-select scheme-category-select">
                                    <option value="ALL" selected>Select Category</option>
                                    <option value="Food Security">Food Security</option>
                                    <option value="Cash Transfer">Cash Transfer</option>
                                    <option value="Agriculture">Agriculture</option>
                                    <option value="Employment">Employment</option>
                                </select>
                            </div>

                            <!-- Scheme Category 2 -->
                            <div class="col-md-4">
                                <label>Scheme Category 2</label>
                                <select id="schemeCategory2" class="form-select scheme-category-select">
                                    <option value="ALL" selected>Select Category</option>
                                    <option value="Food Security">Food Security</option>
                                    <option value="Cash Transfer">Cash Transfer</option>
                                    <option value="Agriculture">Agriculture</option>
                                    <option value="Employment">Employment</option>
                                </select>
                            </div>

                            <!-- Scheme Category 3 -->
                            <div class="col-md-4">
                                <label>Scheme Category 3</label>
                                <select id="schemeCategory3" class="form-select scheme-category-select">
                                    <option value="ALL" selected>Select Category</option>
                                    <option value="Food Security">Food Security</option>
                                    <option value="Cash Transfer">Cash Transfer</option>
                                    <option value="Agriculture">Agriculture</option>
                                    <option value="Employment">Employment</option>
                                </select>
                            </div>
                        </div>

                        <!-- Scheme Lists Row -->
                        <div class="row g-2 align-items-end mt-2">
                            <!-- Scheme List 1 -->
                            <div class="col-md-4">
                                <label>Scheme 1</label>
                                <select id="schemeList1" class="form-select scheme-list-select">
                                    <option value="ALL" selected>All Schemes</option>
                                </select>
                            </div>

                            <!-- Scheme List 2 -->
                            <div class="col-md-4">
                                <label>Scheme 2</label>
                                <select id="schemeList2" class="form-select scheme-list-select">
                                    <option value="ALL" selected>All Schemes</option>
                                </select>
                            </div>

                            <!-- Scheme List 3 -->
                            <div class="col-md-4">
                                <label>Scheme 3</label>
                                <select id="schemeList3" class="form-select scheme-list-select">
                                    <option value="ALL" selected>All Schemes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-2">
                        <div class="col-md-8">
                            <div id="activeFiltersDisplay" class="d-flex flex-wrap gap-2"></div>
                        </div>
                        <div class="col-md-4 d-flex gap-2 justify-content-end">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="bi bi-funnel me-2"></i> Apply Filters
                            </button>
                            <button class="btn btn-outline-danger" onclick="resetAll()">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid mt-3">
                <div class="row">
                    <!-- Left Column - Charts -->
                    <div class="col-lg-8">
                        <!-- Summary Cards -->
                        <div class="row g-2 mb-3">
                            <div class="col-md-3">
                                <div class="card p-2 shadow">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-people text-primary fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-1">Total Families</h6>
                                            <h4 id="totalFamiliesCount" class="mb-0">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="col-md-3">
                                <div class="card p-2 shadow">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-success bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-check-circle text-success fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-1">Active Families</h6>
                                            <h4 id="activeFamiliesCount" class="mb-0">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div> -->
                            <div class="col-md-3">
                                <div class="card p-2 shadow">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-warning bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-clock text-warning fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-1">Total Districts</h6>
                                            <h4 id="totalDistrictsCount" class="mb-0">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card p-2 shadow">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-info bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-shop text-info fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-1">Total Villages</h6>
                                            <h4 id="totalVillagesCount" class="mb-0">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Geographic Distribution Chart -->
                        <div class="row g-2">
                            <div class="col-lg-12">
                                <div class="card p-2 shadow">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="d-flex align-items-center gap-2 mb-0">
                                            <i class="bi bi-geo-alt-fill text-primary"></i>
                                            Geographic Distribution
                                            <span id="filterSummary" class="text-muted fs-6 ms-2"></span>
                                        </h5>
                                        <div class="chart-actions">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV()">
                                                <i class="bi bi-file-earmark-excel"></i> CSV
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="exportPDF()">
                                                <i class="bi bi-file-earmark-pdf"></i> PDF
                                            </button>
                                        </div>
                                    </div>
                                    <div id="pie" style="height:500px"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Scheme Descriptions -->
                    <div class="col-lg-4">
                        <div class="card p-2 shadow h-100" style="position: sticky; top: 100px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="d-flex align-items-center gap-2 mb-0">
                                    <i class="bi bi-stars text-warning"></i>
                                    Dream Scheme Descriptions
                                </h5>
                            </div>

                            <div id="schemeDescriptions">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-info-circle fs-1 mb-2 d-block"></i>
                                    <p>Select dream schemes to view descriptions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/js/global.js"></script>
    <script src="assets/js/crypto-js.min.js"></script>
    <script src="assets/js/encrypt_decrypt.js"></script>


    <script>
        $(document).ready(function () {
            // Initialize all data from APIs
            initializeAllData();

            // Set up event listeners
            setupEventListeners();
        });

        // ================== GLOBAL VARIABLES ==================

        // Global variables for filter logic
        let filterLogic = 'AND';
        let schemeLogic = 'AND';

        // Store data from APIs
        let API_DATA = {
            // Geographic data
            districts: [],
            allTaluks: [],
            allVillages: [],
            allShops: [],
            filteredTaluks: [],
            filteredVillages: [],
            filteredShops: [],

            // Scheme data
            schemeCategories: [],
            allSchemes: [],
            filteredSchemesByCategory: {},

            // Chart data
            filteredData: [],
            currentChartData: null,
            chartData: [],

            // Detailed data for descriptions
            detailedData: [],

            // Backward compatibility
            filteredData: []
        };

        // API endpoints configuration
        const API_CONFIG = {
            baseUrl: 'https://tngis.tnega.org/state_scholarship_portal_api/sfdb_survey/api/v1/dashboard2/',
            endpoints: {
                dynamic_input: 'dynamic_input',
                get_districts: 'get_districts',
                count_card_details: 'count_card_details',
                description_details: 'description_details',
            }
        };

        // Initialize charts
        let pieChart = echarts.init(document.getElementById("pie"));

        // ================== GEOGRAPHIC API FUNCTIONS ==================

        // Load districts
        async function loadDistricts() {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_master_district",
                    "selected_columns": ["district_id", "district_name"],
                    "filter_conditions": {},
                    "sort_columns": {},
                    "limit_rows": 50,
                    "offset_rows": 0
                };

                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let districtList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            districtList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            districtList = decryptedData;
                        }
                    }

                    if (Array.isArray(districtList)) {
                        API_DATA.districts = districtList;
                        return districtList;
                    } else {
                        console.error("District list is not an array:", districtList);
                        API_DATA.districts = [];
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1");
                    API_DATA.districts = [];
                    return [];
                }
            } catch (error) {
                console.error('Error loading districts:', error);
                API_DATA.districts = [];
                return [];
            }
        }

        // Load taluks for a specific district
        async function loadTaluks(districtId) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_master_taluk",
                    "selected_columns": ["district_id", "taluk_id", "taluk_name"],
                    "filter_conditions": {
                        "district_id": districtId
                    },
                    "sort_columns": {},
                    "limit_rows": 100,
                    "offset_rows": 0
                };

                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let talukList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            talukList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            talukList = decryptedData;
                        }
                    }

                    if (Array.isArray(talukList)) {
                        // Store in allTaluks for caching
                        API_DATA.allTaluks = API_DATA.allTaluks.concat(talukList.filter(t =>
                            !API_DATA.allTaluks.some(existing => existing.taluk_id === t.taluk_id)
                        ));

                        // Filter for current district
                        API_DATA.filteredTaluks = talukList;
                        // ////console.log(`Loaded ${talukList.length} taluks for district ${districtId}`);
                        return talukList;
                    } else {
                        console.error("Taluk list is not an array:", talukList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for taluks");
                    return [];
                }
            } catch (error) {
                console.error('Error loading taluks:', error);
                return [];
            }
        }

        // Load villages for a specific district and taluk
        async function loadVillages(districtId, talukId) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_village_master",
                    "selected_columns": ["district_id", "taluk_id", "village_id", "village_name"],
                    "filter_conditions": {
                        "district_id": districtId,
                        "taluk_id": talukId
                    },
                    "sort_columns": {},
                    "limit_rows": 200,
                    "offset_rows": 0
                };

                // ////console.log(`Loading villages for district ${districtId}, taluk ${talukId}...`);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let villageList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            villageList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            villageList = decryptedData;
                        }
                    }

                    if (Array.isArray(villageList)) {
                        // Store in allVillages for caching
                        API_DATA.allVillages = API_DATA.allVillages.concat(villageList.filter(v =>
                            !API_DATA.allVillages.some(existing => existing.village_id === v.village_id)
                        ));

                        // Filter for current district and taluk
                        API_DATA.filteredVillages = villageList;
                        // ////console.log(`Loaded ${villageList.length} villages`);
                        return villageList;
                    } else {
                        console.error("Village list is not an array:", villageList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for villages");
                    return [];
                }
            } catch (error) {
                console.error('Error loading villages:', error);
                return [];
            }
        }

        // Load shops for a specific district, taluk, and village
        async function loadShops(districtId, talukId, villageId) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "pds_master",
                    "selected_columns": ["id", "shop_code"],
                    "filter_conditions": {
                        "district_id": districtId,
                        "taluk_id": talukId,
                        "village_id": villageId
                    },
                    "sort_columns": {},
                    "limit_rows": 200,
                    "offset_rows": 0
                };

                // ////console.log(`Loading shops for district ${districtId}, taluk ${talukId}, village ${villageId}...`);
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let shopList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            shopList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            shopList = decryptedData;
                        }
                    }

                    if (Array.isArray(shopList)) {
                        // Store in allShops for caching
                        API_DATA.allShops = API_DATA.allShops.concat(shopList.filter(s =>
                            !API_DATA.allShops.some(existing => existing.id === s.id)
                        ));

                        // Filter for current location
                        API_DATA.filteredShops = shopList;
                        // ////console.log(`Loaded ${shopList.length} shops`);
                        return shopList;
                    } else {
                        console.error("Shop list is not an array:", shopList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for shops");
                    return [];
                }
            } catch (error) {
                console.error('Error loading shops:', error);
                return [];
            }
        }

        // ================== SCHEME API FUNCTIONS ==================

        // Load scheme categories
        async function loadSchemeCategories() {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "public.dropdown_scheme_type_master",
                    "selected_columns": ["id", "display_text_tamil"],
                    "filter_conditions": {},
                    "sort_columns": {
                    },
                    "limit_rows": 100,
                    "offset_rows": 0
                };

                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let categoryList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            categoryList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            categoryList = decryptedData;
                        }
                    }

                    if (Array.isArray(categoryList)) {
                        API_DATA.schemeCategories = categoryList;
                        return categoryList;
                    } else {
                        console.error("Category list is not an array:", categoryList);
                        API_DATA.schemeCategories = [];
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for scheme categories");
                    API_DATA.schemeCategories = [];
                    return [];
                }
            } catch (error) {
                console.error('Error loading scheme categories:', error);
                API_DATA.schemeCategories = [];
                return [];
            }
        }

        // Load schemes for a specific category
        async function loadSchemes(categoryType) {
            try {
                const payload = {
                    "action": "select",
                    "_table_name": "schemes",
                    "selected_columns": [
                        "dropdown_id",
                        "scheme_id",
                        "scheme_name",
                        "scheme_desc",
                        "scheme_name_tamil",
                        "scheme_desc_tamil",
                        "schemetype",
                        "schemename_asper_form",
                        "schemetype_new"],
                    "filter_conditions": {
                        "dropdown_id": categoryType
                    },
                    "sort_columns": {
                        "scheme_name": "asc"
                    },
                    "limit_rows": 200,
                    "offset_rows": 0
                };


                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let schemeList = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            schemeList = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing decrypted data:", parseError);
                            schemeList = decryptedData;
                        }
                    }

                    if (Array.isArray(schemeList)) {
                        // Store in allSchemes for caching
                        API_DATA.allSchemes = API_DATA.allSchemes.concat(schemeList.filter(s =>
                            !API_DATA.allSchemes.some(existing => existing.scheme_id === s.scheme_id)
                        ));

                        // Cache schemes by category
                        if (!API_DATA.filteredSchemesByCategory[categoryType]) {
                            API_DATA.filteredSchemesByCategory[categoryType] = schemeList;
                        }

                        return schemeList;
                    } else {
                        console.error("Scheme list is not an array:", schemeList);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for schemes");
                    return [];
                }
            } catch (error) {
                console.error('Error loading schemes:', error);
                return [];
            }
        }


        async function loadCountDataForChart(filters) {
            debugger;
            try {
                // Build filter conditions (same logic as before)
                const andConditions = {};
                const schemeFilters = [];

                // Geographic filters
                if (filters.district && filters.district !== 'ALL') {
                    andConditions.district_id = filters.district;
                }
                if (filters.taluk && filters.taluk !== 'ALL') {
                    andConditions.taluk_id = filters.taluk;
                }
                if (filters.village && filters.village !== 'ALL') {
                    andConditions.village_id = filters.village;
                }
                if (filters.shop && filters.shop !== 'ALL') {
                    const shopOption = $('#shop option:selected');
                    if (shopOption.length > 0 && shopOption.text()) {
                        andConditions.shopcode = shopOption.text();
                    }
                }

                // Scheme filters
                for (let i = 1; i <= 3; i++) {
                    const schemeId = filters[`schemeList${i}`];
                    if (schemeId && schemeId !== 'ALL') {
                        schemeFilters.push(schemeId.toString());
                    }
                }

                // Build filterConditions
                let filterConditions = {};

                if (schemeFilters.length === 0) {
                    if (Object.keys(andConditions).length > 0) {
                        filterConditions = { "and": andConditions };
                    }
                } else if (schemeLogic === 'AND') {
                    if (Object.keys(andConditions).length > 0) {
                        andConditions.type_id = schemeFilters.join(',');
                        filterConditions = { "and": andConditions };
                    } else {
                        filterConditions = { "and": { "type_id": schemeFilters.join(',') } };
                    }
                } else {
                    if (Object.keys(andConditions).length > 0) {
                        filterConditions = {
                            "and": { "district_id": filters.district },
                            "or": { "type_id": schemeFilters.join(',') }
                        };
                    } else {
                        filterConditions = { "or": { "type_id": schemeFilters.join(',') } };
                    }
                }

                const payload = {
                    district_id: filters.district && filters.district !== 'ALL'
                        ? Number(filters.district)
                        : null,

                    taluk_id: filters.taluk && filters.taluk !== 'ALL'
                        ? Number(filters.taluk)
                        : null,

                    village_id: filters.village && filters.village !== 'ALL'
                        ? Number(filters.village)
                        : null,

                    shopcode: filters.shop && filters.shop !== 'ALL'
                        ? $('#shop option:selected').text()
                        : null,

                    type_ids: schemeFilters.length > 0
                        ? schemeFilters.map(Number)   // âœ… MUST be array
                        : null,

                    condition: schemeLogic === 'AND' ? 'AND' : 'OR'
                };

                console.log("Loading count data for chart with payload:", payload);
                const response = await makeApiCountRequest(payload);

                if (response && response.success === 1) {
                    var decrypted = decryptData(response.data);
                    var countData = [];

                    if (typeof decrypted === 'string') {
                        try {
                            countData = JSON.parse(decrypted);
                        } catch (e) {
                            console.error("JSON parse failed after decrypt", decrypted);
                            countData = [];
                        }
                    }
                    // âœ… decrypt may already be object
                    else if ($.isArray(decrypted)) {
                        countData = decrypted;
                    }

                    return $.isArray(countData) ? countData : [];
                } else {
                    console.error("API did not return success: 1 for count data");
                    return [];
                }
            } catch (error) {
                console.error('Error loading count data:', error);
                return [];
            }
        }

        function isAnySchemeSelected(filters) {
            for (let i = 1; i <= 3; i++) {
                const val = filters[`schemeList${i}`];
                if (val && val !== 'ALL') {
                    return true;
                }
            }
            return false;
        }

        async function loadDetailedDataForDescriptions(filters) {
            try {
                const schemeFilters = [];

                // Collect selected scheme IDs
                for (let i = 1; i <= 3; i++) {
                    const schemeId = filters[`schemeList${i}`];
                    if (schemeId && schemeId !== 'ALL') {
                        schemeFilters.push(Number(schemeId)); // âœ… ARRAY OF NUMBERS
                    }
                }

                // ðŸš« Do not call API if no schemes selected
                if (schemeFilters.length === 0) {
                    console.log('â„¹ï¸ No schemes selected â€“ skipping description API');
                    return [];
                }

                const payload = {
                    district_id:
                        filters.district && filters.district !== 'ALL'
                            ? Number(filters.district)
                            : null,

                    taluk_id:
                        filters.taluk && filters.taluk !== 'ALL'
                            ? Number(filters.taluk)
                            : null,

                    village_id:
                        filters.village && filters.village !== 'ALL'
                            ? Number(filters.village)
                            : null,

                    shopcode:
                        filters.shop && filters.shop !== 'ALL'
                            ? $('#shop option:selected').text()
                            : null,

                    // âœ… THIS IS THE KEY FIX
                    type_ids: schemeFilters,   // ðŸ‘ˆ ARRAY

                    condition: schemeLogic === 'AND' ? 'AND' : 'OR',

                    // static pagination
                    p_page: 1,
                    p_page_size: 5000
                };

                console.log(
                    'ðŸ“¤ Description payload:',
                    JSON.stringify(payload, null, 2)
                );

                const response = await makeApiDescriptionRequest(payload);

                if (!response || response.success !== 1) {
                    console.error('âŒ API error:', response);
                    return [];
                }

                let decryptedData = decryptData(response.data);

                if (typeof decryptedData === 'string') {
                    decryptedData = JSON.parse(decryptedData);
                }

                // Backend may return single object
                if (!Array.isArray(decryptedData)) {
                    decryptedData = [decryptedData];
                }

                // Normalize keys for UI
                const detailedData = decryptedData.map(row => ({
                    ...row,
                    type_id: row.type_id ?? row.scheme_id, // ðŸ”¥ IMPORTANT
                    suggestion_remarks: row.suggestion_remarks ?? '',
                    district_name: row.district_name ?? 'Unknown District',
                    taluk_name: row.taluk_name ?? null,
                    village_name: row.village_name ?? null,
                    active: row.active ?? 1
                }));

                console.table(detailedData);
                return detailedData;

            } catch (err) {
                console.error('âŒ loadDetailedDataForDescriptions error:', err);
                return [];
            }
        }

        // Load scheme descriptions for multiple schemes
        async function loadSchemeDescriptions(schemeIds) {
            try {
                // Build filter conditions structure
                let filterConditions = {};

                // Apply current geographic filters to AND condition
                const district = $('#district').val();
                const taluk = $('#taluk').val();
                const village = $('#village').val();
                const shop = $('#shop').val();

                // Collect AND conditions
                const andConditions = {};

                if (district && district !== 'ALL') {
                    andConditions.district_id = district;
                }
                if (taluk && taluk !== 'ALL') {
                    andConditions.taluk_id = taluk;
                }
                if (village && village !== 'ALL') {
                    andConditions.village_id = village;
                }
                if (shop && shop !== 'ALL') {
                    const shopOption = $('#shop option:selected');
                    if (shopOption.length > 0 && shopOption.text()) {
                        andConditions.shopcode = shopOption.text();
                    }
                }

                // Check if schemeIds is an array or single value
                if (Array.isArray(schemeIds) && schemeIds.length > 0) {
                    // Convert array to array of strings
                    const schemeIdsArray = schemeIds.map(id => id.toString());

                    if (Object.keys(andConditions).length > 0) {
                        // For descriptions with geographic filters: AND(geographic) with OR(schemes)
                        filterConditions = {
                            "and": andConditions,
                            "or": {
                                "type_id": schemeIdsArray.join(',')
                            }
                        };
                    } else {
                        // Only scheme IDs with OR
                        filterConditions = {
                            "or": {
                                "type_id": schemeIdsArray.join(',')
                            }
                        };
                    }
                } else if (schemeIds) {
                    // Single scheme ID - combine with geographic filters in AND
                    andConditions.type_id = schemeIds;
                    filterConditions = {
                        "and": andConditions
                    };
                } else {
                    console.error("No scheme IDs provided");
                    return [];
                }

                // Clean up empty structures
                if (JSON.stringify(filterConditions) === '{"and":{}}') {
                    filterConditions = {};
                }
                if (JSON.stringify(filterConditions) === '{"or":{}}') {
                    filterConditions = {};
                }

                const payload = {
                    "action": "select",
                    "_table_name": "analytics.analytics_suggestionform_smple",
                    "selected_columns": [
                        "district_name", "taluk_name", "village_name",
                        "suggestion_remarks", "created_ts", "shopcode",
                        "scheme_name", "type", "active", "type_id"
                    ],
                    "filter_conditions": filterConditions,
                    "sort_columns": {
                        "created_ts": "desc"
                    },
                    "limit_rows": 1000,
                    "offset_rows": 0
                };

                ////console.log("Loading scheme descriptions with filter:", JSON.stringify(filterConditions, null, 2));
                const response = await makeApiRequest(payload);

                if (response && response.success === 1) {
                    const decryptedData = decryptData(response.data);
                    let descriptions = decryptedData;

                    if (typeof decryptedData === 'string') {
                        try {
                            descriptions = JSON.parse(decryptedData);
                        } catch (parseError) {
                            console.error("Error parsing description data:", parseError);
                            descriptions = decryptedData;
                        }
                    }

                    if (Array.isArray(descriptions)) {
                        ////console.log(`Loaded ${descriptions.length} descriptions for scheme(s) ${schemeIds}`);
                        return descriptions;
                    } else {
                        console.error("Description list is not an array:", descriptions);
                        return [];
                    }
                } else {
                    console.error("API did not return success: 1 for scheme descriptions");
                    return [];
                }
            } catch (error) {
                console.error('Error loading scheme descriptions:', error);
                return [];
            }
        }

        async function testAndOrApiStructure() {
            try {
                // Test payload with AND/OR structure
                const testPayload = {
                    "action": "select",
                    "_table_name": "analytics.analytics_suggestionform_smple",
                    "selected_columns": ["id", "type_id", "scheme_name"],
                    "filter_conditions": {
                        "and": {
                            "district_id": "26"
                        },
                        "or": {
                            "type_id": "265,623"
                        }
                    },
                    "sort_columns": {},
                    "limit_rows": 10,
                    "offset_rows": 0
                };

                ////console.log("Testing AND/OR API structure:", JSON.stringify(testPayload, null, 2));
                const response = await makeApiRequest(testPayload);

                if (response && response.success === 1) {
                    ////console.log("âœ… AND/OR API structure accepted successfully!");
                    const decryptedData = decryptData(response.data);
                    ////console.log("Test response data:", decryptedData);
                    return true;
                } else {
                    //console.log("âŒ API rejected AND/OR structure");
                    //console.log("Response:", response);

                    // Try with only AND condition
                    const testPayload2 = {
                        "action": "select",
                        "_table_name": "analytics.analytics_suggestionform_smple",
                        "selected_columns": ["id", "type_id", "scheme_name"],
                        "filter_conditions": {
                            "and": {
                                "district_id": "26",
                                "type_id": "265"
                            }
                        },
                        "sort_columns": {},
                        "limit_rows": 10,
                        "offset_rows": 0
                    };

                    //console.log("Testing AND-only structure:", JSON.stringify(testPayload2, null, 2));
                    const response2 = await makeApiRequest(testPayload2);

                    if (response2 && response2.success === 1) {
                        //console.log("âœ… AND-only structure accepted successfully!");
                        return 'and-only';
                    }

                    return false;
                }
            } catch (error) {
                console.error("Error testing AND/OR API structure:", error);
                return false;
            }
        }

        // ================== GENERIC API FUNCTION ==================

        // Generic API request function
        async function makeApiRequest(payload) {
            try {
                const encryptedPayload = encryptData(payload);
                const url = API_CONFIG.baseUrl + API_CONFIG.endpoints.dynamic_input;

                const response = await $.ajax({
                    url: url,
                    type: "POST",
                    dataType: "json",
                    data: { data: encryptedPayload },
                    success: function (response) {
                        //console.log("API Success Response received", response);
                        return response;
                    },
                    error: function (xhr, status, error) {
                        console.error("API Error:", {
                            status: status,
                            error: error,
                            responseText: xhr.responseText
                        });
                        throw new Error(`API Error: ${status} - ${error}`);
                    }
                });

                return response;
            } catch (error) {
                console.error('API Request Error:', error);
                throw error;
            }
        }

        async function makeApiCountRequest(payload) {
            try {
                var encryptedPayload = encryptData(payload);
                var url = API_CONFIG.baseUrl + API_CONFIG.endpoints.count_card_details;

                var response = await $.ajax({
                    url: url,
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    dataType: "json",
                    data: {
                        data: encryptedPayload
                    }
                });
                console.log("response", response);
                return response;

            } catch (err) {
                console.error("Count API error:", err);
                return null;
            }
        }


        async function makeApiDescriptionRequest(payload) {
            try {
                var encryptedPayload = encryptData(payload);
                var url = API_CONFIG.baseUrl + API_CONFIG.endpoints.description_details;

                var response = await $.ajax({
                    url: url,
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    dataType: "json",
                    data: {
                        data: encryptedPayload
                    }
                });
                console.log("response", response);
                return response;

            } catch (err) {
                console.error("Count API error:", err);
                return null;
            }
        }

        // ================== DROPDOWN POPULATION FUNCTIONS ==================

        // Populate district dropdown
        function populateDistrictDropdown() {
            const districtSelect = $('#district');
            districtSelect.empty();

            // Always add "All Districts" option
            districtSelect.append('<option value="ALL" selected>All Districts</option>');

            if (API_DATA.districts && API_DATA.districts.length > 0) {
                //console.log(`Populating dropdown with ${API_DATA.districts.length} districts`);

                // Sort districts by name
                const sortedDistricts = [...API_DATA.districts].sort((a, b) => {
                    const nameA = a.district_name || a.name || '';
                    const nameB = b.district_name || b.name || '';
                    return nameA.localeCompare(nameB);
                });

                // Add each district to dropdown
                sortedDistricts.forEach(district => {
                    const districtId = district.district_id || district.id || district.district_code;
                    const districtName = district.district_name || district.name || 'Unknown District';

                    districtSelect.append(`<option value="${districtId}">${districtName}</option>`);
                });

                //console.log("District dropdown populated successfully");
            } else {
                //console.log("No districts available, showing fallback options");
                districtSelect.append('<option value="ALL" selected>No districts available</option>');
            }
        }

        // Populate taluk dropdown
        function populateTalukDropdown(taluks) {
            const talukSelect = $('#taluk');
            const currentTalukValue = talukSelect.val();

            talukSelect.empty();
            talukSelect.append('<option value="ALL" selected>All Taluks</option>');

            if (taluks && taluks.length > 0) {
                //console.log(`Populating dropdown with ${taluks.length} taluks`);

                // Sort taluks by name
                const sortedTaluks = [...taluks].sort((a, b) => {
                    const nameA = a.taluk_name || a.name || '';
                    const nameB = b.taluk_name || b.name || '';
                    return nameA.localeCompare(nameB);
                });

                // Add each taluk to dropdown
                sortedTaluks.forEach(taluk => {
                    const talukId = taluk.taluk_id || taluk.id;
                    const talukName = taluk.taluk_name || taluk.name || 'Unknown Taluk';

                    talukSelect.append(`<option value="${talukId}">${talukName}</option>`);
                });

                // Try to restore previous selection
                if (currentTalukValue !== 'ALL' && taluks.some(t => (t.taluk_id || t.id) == currentTalukValue)) {
                    talukSelect.val(currentTalukValue);
                }

                //console.log("Taluk dropdown populated successfully");
            } else {
                //console.log("No taluks available for selected district");
                talukSelect.append('<option value="ALL" selected>No taluks available</option>');
            }

            // Enable taluk dropdown
            talukSelect.prop('disabled', false);
        }

        // Populate village dropdown
        function populateVillageDropdown(villages) {
            const villageSelect = $('#village');
            const currentVillageValue = villageSelect.val();

            villageSelect.empty();
            villageSelect.append('<option value="ALL" selected>All Villages</option>');

            if (villages && villages.length > 0) {
                //console.log(`Populating dropdown with ${villages.length} villages`);

                // Sort villages by name
                const sortedVillages = [...villages].sort((a, b) => {
                    const nameA = a.village_name || a.name || '';
                    const nameB = b.village_name || b.name || '';
                    return nameA.localeCompare(nameB);
                });

                // Add each village to dropdown
                sortedVillages.forEach(village => {
                    const villageId = village.village_id || village.id;
                    const villageName = village.village_name || village.name || 'Unknown Village';

                    villageSelect.append(`<option value="${villageId}">${villageName}</option>`);
                });

                // Try to restore previous selection
                if (currentVillageValue !== 'ALL' && villages.some(v => (v.village_id || v.id) == currentVillageValue)) {
                    villageSelect.val(currentVillageValue);
                }

                //console.log("Village dropdown populated successfully");
            } else {
                //console.log("No villages available for selected taluk");
                villageSelect.append('<option value="ALL" selected>No villages available</option>');
            }

            // Enable village dropdown
            villageSelect.prop('disabled', false);
        }

        // Populate shop dropdown
        function populateShopDropdown(shops) {
            const shopSelect = $('#shop');
            const currentShopValue = shopSelect.val();

            shopSelect.empty();
            shopSelect.append('<option value="ALL" selected>All Shops</option>');

            if (shops && shops.length > 0) {
                //console.log(`Populating dropdown with ${shops.length} shops`);

                // Sort shops by code
                const sortedShops = [...shops].sort((a, b) => {
                    const codeA = a.shop_code || a.code || '';
                    const codeB = b.shop_code || b.code || '';
                    return codeA.localeCompare(codeB);
                });

                // Add each shop to dropdown
                sortedShops.forEach(shop => {
                    const shopId = shop.id || shop.shop_id;
                    const shopCode = shop.shop_code || shop.code || `Shop ${shopId}`;

                    shopSelect.append(`<option value="${shopId}">${shopCode}</option>`);
                });

                // Try to restore previous selection
                if (currentShopValue !== 'ALL' && shops.some(s => (s.id || s.shop_id) == currentShopValue)) {
                    shopSelect.val(currentShopValue);
                }

                //console.log("Shop dropdown populated successfully");
            } else {
                //console.log("No shops available for selected location");
                shopSelect.append('<option value="ALL" selected>No shops available</option>');
            }

            // Shop dropdown is always enabled
            shopSelect.prop('disabled', false);
        }

        // Populate scheme category dropdowns
        function populateSchemeCategoryDropdowns() {
            // Update all three category dropdowns
            for (let i = 1; i <= 3; i++) {
                const categorySelect = $(`#schemeCategory${i}`);
                const currentValue = categorySelect.val();

                categorySelect.empty();
                categorySelect.append('<option value="ALL" selected>Select Category</option>');

                if (API_DATA.schemeCategories && API_DATA.schemeCategories.length > 0) {
                    //console.log(`Populating scheme category dropdown ${i}`);

                    // Get unique categories
                    const uniqueCategories = [];
                    const seenTypes = new Set();

                    API_DATA.schemeCategories.forEach(item => {

                        uniqueCategories.push({
                            id: item.id,
                            type: item.display_text_tamil,
                        });

                    });

                    // Sort by type name
                    uniqueCategories.sort((a, b) => a.type.localeCompare(b.type));

                    // Add categories to dropdown
                    uniqueCategories.forEach(item => {
                        // Use scheme_type for both value and display text
                        const value = item.id;
                        const display = item.type;
                        categorySelect.append(`<option value="${value}">${display}</option>`);
                    });

                    // Try to restore previous selection
                    if (currentValue && currentValue !== 'ALL') {
                        // Check if the value exists in the dropdown
                        const exists = uniqueCategories.some(item => item.type === currentValue);
                        if (exists) {
                            categorySelect.val(currentValue);
                        }
                    }

                    //console.log(`Scheme category dropdown ${i} populated with ${uniqueCategories.length} categories`);
                } else {
                    //console.log("No scheme categories available");
                    categorySelect.append('<option value="ALL" selected>No categories available</option>');
                }
            }
        }

        function populateSchemeDropdown(position, category) {
            const schemeSelect = $(`#schemeList${position}`);
            const currentValue = schemeSelect.val();

            schemeSelect.empty();
            schemeSelect.append('<option value="ALL">All Schemes</option>');

            let schemes = [];

            if (category === 'ALL') {
                schemes = API_DATA.allSchemes;
            } else {
                schemes = API_DATA.allSchemes.filter(
                    scheme => String(scheme.dropdown_id) === String(category)
                );
            }

            if (Array.isArray(schemes) && schemes.length > 0) {

                const sortedSchemes = [...schemes].sort((a, b) => {
                    const nameA = a.scheme_name_tamil || a.scheme_name || '';
                    const nameB = b.scheme_name_tamil || b.scheme_name || '';
                    return nameA.localeCompare(nameB, 'ta');
                });

                sortedSchemes.forEach(scheme => {
                    schemeSelect.append(`
                <option value="${scheme.scheme_id}">
                    ${scheme.scheme_name_tamil || scheme.scheme_name}
                </option>
            `);
                });

                // Restore selection
                if (
                    currentValue &&
                    currentValue !== 'ALL' &&
                    schemes.some(s => String(s.scheme_id) === String(currentValue))
                ) {
                    schemeSelect.val(currentValue);
                } else {
                    schemeSelect.val('ALL');
                }

            } else {
                schemeSelect.append(
                    '<option value="ALL" selected>No schemes available</option>'
                );
            }
        }

        // ================== EVENT HANDLER FUNCTIONS ==================

        // Handle district change
        async function handleDistrictChange() {
            const districtId = $('#district').val();
            //console.log("District changed to:", districtId);

            // Reset dependent dropdowns
            $('#taluk').html('<option value="ALL" selected>Loading taluks...</option>');
            $('#taluk').prop('disabled', true);
            $('#village').html('<option value="ALL" selected>Select taluk first</option>');
            $('#village').prop('disabled', true);
            $('#shop').html('<option value="ALL" selected>Select village first</option>');

            // When user changes district (scheme -> district), reset scheme category and scheme list so district -> scheme hierarchy holds
            for (let i = 1; i <= 3; i++) {
                $(`#schemeCategory${i}`).val('ALL');
                populateSchemeDropdown(i, 'ALL');
                $(`#schemeList${i}`).val('ALL');  // force scheme list to All Schemes (populateSchemeDropdown may restore previous)
            }
            showSchemeDescriptionsPlaceholder();

            if (districtId !== 'ALL') {
                try {
                    // Load taluks for selected district
                    const taluks = await loadTaluks(districtId);
                    populateTalukDropdown(taluks);

                    // Clear village and shop data
                    API_DATA.filteredVillages = [];
                    API_DATA.filteredShops = [];
                } catch (error) {
                    console.error("Error loading taluks:", error);
                    $('#taluk').html('<option value="ALL" selected>Error loading taluks</option>');
                }
            } else {
                // If "All Districts" is selected, enable taluk dropdown with empty options
                $('#taluk').html('<option value="ALL" selected>All Taluks</option>');
                $('#taluk').prop('disabled', false);

                // Clear all filtered data
                API_DATA.filteredTaluks = [];
                API_DATA.filteredVillages = [];
                API_DATA.filteredShops = [];
            }
        }

        // Handle taluk change
        async function handleTalukChange() {
            const districtId = $('#district').val();
            const talukId = $('#taluk').val();

            //console.log("Taluk changed to:", talukId);

            // Reset dependent dropdowns
            $('#village').html('<option value="ALL" selected>Loading villages...</option>');
            $('#village').prop('disabled', true);
            $('#shop').html('<option value="ALL" selected>Select village first</option>');

            if (districtId !== 'ALL' && talukId !== 'ALL') {
                try {
                    // Load villages for selected district and taluk
                    const villages = await loadVillages(districtId, talukId);
                    populateVillageDropdown(villages);

                    // Clear shop data
                    API_DATA.filteredShops = [];
                } catch (error) {
                    console.error("Error loading villages:", error);
                    $('#village').html('<option value="ALL" selected>Error loading villages</option>');
                }
            } else {
                // If "All Taluks" is selected, enable village dropdown with empty options
                $('#village').html('<option value="ALL" selected>All Villages</option>');
                $('#village').prop('disabled', false);

                // Clear village and shop data
                API_DATA.filteredVillages = [];
                API_DATA.filteredShops = [];
            }
        }

        // Handle village change
        async function handleVillageChange() {
            const districtId = $('#district').val();
            const talukId = $('#taluk').val();
            const villageId = $('#village').val();

            //console.log("Village changed to:", villageId);

            // Reset shop dropdown
            $('#shop').html('<option value="ALL" selected>Loading shops...</option>');

            if (districtId !== 'ALL' && talukId !== 'ALL' && villageId !== 'ALL') {
                try {
                    // Load shops for selected district, taluk, and village
                    const shops = await loadShops(districtId, talukId, villageId);
                    populateShopDropdown(shops);
                } catch (error) {
                    console.error("Error loading shops:", error);
                    $('#shop').html('<option value="ALL" selected>Error loading shops</option>');
                }
            } else {
                // If "All Villages" is selected, show all shops option
                $('#shop').html('<option value="ALL" selected>All Shops</option>');
                API_DATA.filteredShops = [];
            }
        }

        // Handle scheme category change
        async function handleSchemeCategoryChange(position) {
            const categorySelect = $(`#schemeCategory${position}`);
            const category = categorySelect.val();

            //   ////console.log(`Scheme category ${position} changed to:`, category);

            // Update scheme dropdown
            const schemeSelect = $(`#schemeList${position}`);
            schemeSelect.html('<option value="ALL" selected>Loading schemes...</option>');

            if (category !== 'ALL') {
                try {
                    // Check if we have schemes cached for this category
                    if (!API_DATA.filteredSchemesByCategory[category] || API_DATA.filteredSchemesByCategory[category].length === 0) {
                        // Load schemes for this category
                        const schemes = await loadSchemes(category);
                    }

                    // Populate scheme dropdown only; no API call for analytics_suggestionform_smple
                    populateSchemeDropdown(position, category);

                } catch (error) {
                    console.error(`Error loading schemes for category ${category}:`, error);
                    schemeSelect.html('<option value="ALL" selected>Error loading schemes</option>');
                }
            } else {
                // // If "ALL" is selected, populate with all schemes
                // if (API_DATA.allSchemes.length === 0) {
                //     await loadAllSchemes();
                // }
                populateSchemeDropdown(position, 'ALL');
            }

            // Show placeholder; user must click Apply Filters to load data
            showSchemeDescriptionsPlaceholder();
        }

        // ================== INITIALIZATION FUNCTION ==================

        // Initialize all data
        async function initializeAllData() {
            try {

                // Load districts
                await loadDistricts();
                populateDistrictDropdown();

                // Load scheme categories
                await loadSchemeCategories();
                populateSchemeCategoryDropdowns();

                // Load all schemes initially
                // await loadAllSchemes();

                // Initialize scheme dropdowns with "ALL" option
                for (let i = 1; i <= 3; i++) {
                    populateSchemeDropdown(i, 'ALL');
                }

                // No test API call on init - analytics_suggestionform_smple is only called when user clicks Apply Filters


            } catch (error) {
                console.error('Initialization error:', error);

                // Fallback initialization
                populateDistrictDropdown();
                populateSchemeCategoryDropdowns();

                for (let i = 1; i <= 3; i++) {
                    $(`#schemeList${i}`).html('<option value="ALL" selected>All Schemes</option>');
                }
            }
        }

        // ================== EVENT LISTENERS SETUP ==================

        // Debug filters function
        function debugFilters() {
            ////console.log("=== FILTER DEBUG INFO ===");

            // Collect all filter values
            const filters = {
                district: $('#district').val(),
                taluk: $('#taluk').val(),
                village: $('#village').val(),
                shop: $('#shop').val(),
                schemeLogic: schemeLogic
            };

            // Collect scheme filters
            const schemeFilters = [];
            for (let i = 1; i <= 3; i++) {
                const category = $(`#schemeCategory${i}`).val();
                const schemeId = $(`#schemeList${i}`).val();
                if (schemeId !== 'ALL' && category !== 'ALL') {
                    schemeFilters.push({
                        position: i,
                        category: category,
                        schemeId: schemeId,
                        schemeName: $(`#schemeList${i} option:selected`).text()
                    });
                }
            }

            ////console.log("Geographic Filters:", filters);
            ////console.log("Scheme Filters:", schemeFilters);
            ////console.log("Scheme Logic:", schemeLogic);

            alert(`Debug Info:\n\nScheme Filters: ${schemeFilters.length}\nScheme Logic: ${schemeLogic}\n\nCheck console for details.`);
        }

        // Add debug button
        function addDebugButton() {
            const debugBtn = $('<button>')
                .addClass('btn btn-sm btn-outline-info ms-2')
                .html('<i class="bi bi-bug"></i> Debug')
                .click(debugFilters);

            $('.justify-content-end').append(debugBtn);
        }

        // Set up event listeners
        function setupEventListeners() {
            ////console.log("Setting up enhanced event listeners");

            // Geographic filters
            $('#district').on('change', handleDistrictChange);
            $('#taluk').on('change', handleTalukChange);
            $('#village').on('change', handleVillageChange);
            // $('#shop').on('change', applyFilters);

            // Demographic filters
            // $('#gender, #ageMin, #ageMax, #dateFrom, #dateTo').on('change', applyFilters);

            // Scheme category filters
            for (let i = 1; i <= 3; i++) {
                $(`#schemeCategory${i}`).on('change', function () {
                    handleSchemeCategoryChange(i);
                });
            }

            // Scheme list filters - do NOT call API on change; user must click Apply Filters
            for (let i = 1; i <= 3; i++) {
                $(`#schemeList${i}`).on('change', function () {
                    showSchemeDescriptionsPlaceholder();
                });
            }

            // Add debug button
            addDebugButton();

            ////console.log("Event listeners setup complete");
        }

        // ================== SCHEME DESCRIPTIONS ==================

        // Show placeholder without API call (used when scheme/category changes)
        function showSchemeDescriptionsPlaceholder() {
            const descriptionsContainer = $('#schemeDescriptions');
            descriptionsContainer.empty();

            let selectedCount = 0;
            for (let i = 1; i <= 3; i++) {
                const schemeId = $(`#schemeList${i}`).val();
                const category = $(`#schemeCategory${i}`).val();
                if (schemeId !== 'ALL' && category !== 'ALL') selectedCount++;
            }

            if (selectedCount === 0) {
                descriptionsContainer.html(`
            <div class="text-center text-muted py-4">
                <i class="bi bi-stars fs-1 mb-2 d-block"></i>
                <p>Select dream schemes to view descriptions</p>
                <small class="text-muted">Select scheme categories and specific schemes, then click Apply Filters</small>
            </div>
        `);
            } else {
                descriptionsContainer.html(`
            <div class="text-center text-muted py-4">
                <i class="bi bi-funnel fs-1 mb-2 d-block"></i>
                <p>Click <strong>Apply Filters</strong> to load data</p>
                <small class="text-muted">Scheme selection updated. Apply filters to refresh results.</small>
            </div>
        `);
            }
        }

        function updateSchemeDescriptionsFromData(detailedData) {
            const descriptionsContainer = $('#schemeDescriptions');
            descriptionsContainer.empty();

            let selectedSchemes = [];

            // Collect selected schemes
            for (let i = 1; i <= 3; i++) {
                const schemeSelect = $(`#schemeList${i}`);
                const categorySelect = $(`#schemeCategory${i}`);
                const selectedSchemeId = schemeSelect.val();
                const selectedCategory = categorySelect.val();

                if (selectedSchemeId !== 'ALL' && selectedCategory !== 'ALL') {
                    const scheme = API_DATA.allSchemes.find(s =>
                        (s.scheme_id || s.id) == selectedSchemeId
                    );
                    if (scheme) {
                        selectedSchemes.push({
                            schemeId: selectedSchemeId,
                            schemeName: scheme.scheme_name || scheme.name || 'Unknown Scheme',
                            category: scheme.schemetype || selectedCategory,
                            position: i
                        });
                    }
                }
            }

            if (selectedSchemes.length === 0 || !Array.isArray(detailedData) || detailedData.length === 0) {
                if (selectedSchemes.length === 0) {
                    descriptionsContainer.html(`
                <div class="text-center text-muted py-4">
                    <i class="bi bi-stars fs-1 mb-2 d-block"></i>
                    <p>Select dream schemes to view descriptions</p>
                    <small class="text-muted">Select scheme categories and specific schemes to see details</small>
                </div>
            `);
                } else {
                    descriptionsContainer.html(`
                <div class="text-center text-muted py-4">
                    <i class="bi bi-stars fs-1 mb-2 d-block"></i>
                    <p>No descriptions found for selected schemes</p>
                    <small class="text-muted">Try selecting different schemes or adjust filters</small>
                </div>
            `);
                }
                return;
            }

            // Remove duplicates by ufcno for scheme descriptions
            const uniqueByUfcno = new Map();
            detailedData.forEach((row, idx) => {
                const key = row.ufcno != null ? String(row.ufcno) : (row.id != null ? `id_${row.id}` : `idx_${idx}`);
                if (!uniqueByUfcno.has(key)) {
                    uniqueByUfcno.set(key, row);
                }
            });
            const dataForDescriptions = Array.from(uniqueByUfcno.values());

            const descriptionsByScheme = {};
            selectedSchemes.forEach(scheme => {
                descriptionsByScheme[scheme.schemeId] = { scheme: scheme, descriptions: [] };
            });

            dataForDescriptions.forEach(row => {
                const schemeId = String(row.type_id);
                if (descriptionsByScheme[schemeId]) {
                    descriptionsByScheme[schemeId].descriptions.push(row);
                }
            });

            const schemeDescriptionData = Object.values(descriptionsByScheme);
            displaySchemeDescriptions(schemeDescriptionData);
        }
        // Update scheme descriptions with real data (legacy - used only when explicit API fetch needed)
        async function updateSchemeDescriptions() {
            const descriptionsContainer = $('#schemeDescriptions');
            descriptionsContainer.empty();

            // Check if any schemes are selected
            let selectedSchemes = [];
            let schemeIds = [];

            for (let i = 1; i <= 3; i++) {
                const schemeSelect = $(`#schemeList${i}`);
                const categorySelect = $(`#schemeCategory${i}`);
                const selectedSchemeId = schemeSelect.val();
                const selectedCategory = categorySelect.val();

                if (selectedSchemeId !== 'ALL' && selectedCategory !== 'ALL') {
                    // Find the scheme details
                    const scheme = API_DATA.allSchemes.find(s =>
                        (s.scheme_id || s.id) == selectedSchemeId
                    );

                    if (scheme) {
                        selectedSchemes.push({
                            schemeId: selectedSchemeId,
                            schemeName: scheme.scheme_name || scheme.name || 'Unknown Scheme',
                            category: scheme.schemetype || selectedCategory,
                            position: i
                        });
                        schemeIds.push(selectedSchemeId);
                    }
                }
            }

            if (selectedSchemes.length === 0) {
                // No schemes selected
                descriptionsContainer.html(`
            <div class="text-center text-muted py-4">
                <i class="bi bi-stars fs-1 mb-2 d-block"></i>
                <p>Select dream schemes to view descriptions</p>
                <small class="text-muted">Select scheme categories and specific schemes to see details</small>
            </div>
        `);
                return;
            }

            // Show loading state
            descriptionsContainer.html(`
        <div class="text-center py-3">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading scheme descriptions...</p>
        </div>
    `);

            try {
                // Load descriptions for all selected schemes in one API call
                const allDescriptions = await loadSchemeDescriptions(schemeIds);

                // Group descriptions by scheme ID for display
                const descriptionsByScheme = {};
                selectedSchemes.forEach(scheme => {
                    descriptionsByScheme[scheme.schemeId] = {
                        scheme: scheme,
                        descriptions: []
                    };
                });

                // Sort descriptions into their respective schemes
                if (Array.isArray(allDescriptions)) {
                    allDescriptions.forEach(desc => {
                        const schemeId = String(desc.type_id);
                        if (descriptionsByScheme[schemeId]) {
                            descriptionsByScheme[schemeId].descriptions.push(desc);
                        }
                    });
                }

                // Prepare data for display
                const schemeDescriptionData = Object.values(descriptionsByScheme);

                displaySchemeDescriptions(schemeDescriptionData);

            } catch (error) {
                console.error('Error loading scheme descriptions:', error);
                descriptionsContainer.html(`
            <div class="text-center text-danger py-4">
                <i class="bi bi-exclamation-triangle fs-1 mb-2 d-block"></i>
                <p>Error loading scheme descriptions</p>
                <small class="text-muted">Please try again</small>
            </div>
        `);
            }
        }

        // Display scheme descriptions
        function displaySchemeDescriptions(allDescriptions) {
            const descriptionsContainer = $('#schemeDescriptions');
            descriptionsContainer.empty();

            if (allDescriptions.length === 0) {
                descriptionsContainer.html(`
            <div class="text-center text-muted py-4">
                <i class="bi bi-stars fs-1 mb-2 d-block"></i>
                <p>No descriptions found for selected schemes</p>
                <small class="text-muted">Try selecting different schemes or adjust filters</small>
            </div>
        `);
                return;
            }

            // Create HTML for each scheme's descriptions
            allDescriptions.forEach((item, index) => {
                const cardHtml = createSchemeDescriptionCard(item.scheme, item.descriptions);
                if (index === 0) {
                    descriptionsContainer.append(cardHtml);
                } else {
                    descriptionsContainer.append('<hr class="my-3">' + cardHtml);
                }
            });
        }

        // Create HTML card for scheme descriptions with condensed "No remarks" entries
        function createSchemeDescriptionCard(schemeInfo, descriptions) {
            console.log("Creating description card for scheme:", schemeInfo);
            console.log("Total descriptions received:", descriptions);

            const hasDescriptions = descriptions && descriptions.length > 0;

            let descriptionContent = '';

            if (hasDescriptions) {
                // Calculate correct totals
                const totalEntries = descriptions.length;

                const totalRecordsFromDB =
                    descriptions[0]?.total_records != null
                        ? Number(descriptions[0].total_records)
                        : totalEntries;

                // Separate entries with actual remarks
                const entriesWithRemarks = descriptions.filter(desc => {
                    const remark = desc.suggestion_remarks;
                    return remark &&
                        remark.trim() !== '' &&
                        remark.toLowerCase() !== 'no remarks provided';
                });

                const entriesWithoutRemarks = descriptions.filter(desc => {
                    const remark = desc.suggestion_remarks;
                    return !remark ||
                        remark.trim() === '' ||
                        remark.toLowerCase() === 'no remarks provided';
                });

                // Get truly unique remarks (excluding duplicates)
                const uniqueRemarksSet = new Set();
                entriesWithRemarks.forEach(desc => {
                    uniqueRemarksSet.add(desc.suggestion_remarks.trim());
                });

                const uniqueRemarksCount = uniqueRemarksSet.size;
                const withoutRemarksCount = entriesWithoutRemarks.length;

                // Group descriptions by district
                const descriptionsByDistrict = {};

                descriptions.forEach(desc => {
                    const district = desc.district_name || 'Unknown District';
                    if (!descriptionsByDistrict[district]) {
                        descriptionsByDistrict[district] = {
                            allEntries: [],
                            entriesWithRemarks: [],
                            entriesWithoutRemarks: []
                        };
                    }

                    const remark = desc.suggestion_remarks;
                    const hasRemark = remark &&
                        remark.trim() !== '' &&
                        remark.toLowerCase() !== 'no remarks provided';

                    descriptionsByDistrict[district].allEntries.push(desc);

                    if (hasRemark) {
                        descriptionsByDistrict[district].entriesWithRemarks.push(desc);
                    } else {
                        descriptionsByDistrict[district].entriesWithoutRemarks.push(desc);
                    }
                });

                // Create sections for each district
                let districtSections = '';

                Object.keys(descriptionsByDistrict).forEach(district => {
                    const districtData = descriptionsByDistrict[district];
                    const districtEntries = districtData.allEntries;
                    const districtWithRemarks = districtData.entriesWithRemarks;
                    const districtWithoutRemarks = districtData.entriesWithoutRemarks;

                    // Get unique remarks for this district
                    const districtUniqueRemarksSet = new Set();
                    const districtUniqueRemarksEntries = [];

                    districtWithRemarks.forEach(desc => {
                        const remark = desc.suggestion_remarks.trim();
                        if (!districtUniqueRemarksSet.has(remark)) {
                            districtUniqueRemarksSet.add(remark);
                            districtUniqueRemarksEntries.push(desc);
                        }
                    });

                    districtSections += `
            <div class="district-section mb-3">
                <div class="district-header d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                    <div>
                        <h6 class="mb-0 fw-bold">
                            <i class="bi bi-geo-alt me-2"></i>
                            ${district}
                        </h6>
                        <small class="text-muted">
                            
                            ${districtEntries.length} entries â€¢ 
                            ${districtUniqueRemarksEntries.length} unique remarks
                            ${districtWithoutRemarks.length > 0 ? ` â€¢ ${districtWithoutRemarks.length} without remarks` : ''}
                        </small>
                    </div>
                </div>
                
                <!-- Condensed View -->
                <div class="condensed-view">
                    <!-- Show No Remarks Provided once with count -->
                    ${districtWithoutRemarks.length > 0 ? `
                        <div class="no-remarks-entry mb-2 p-2 border rounded bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-chat-x text-muted me-2 fs-5"></i>
                                    <div>
                                        <span class="fw-medium">No remarks provided</span>
                                        <div class="d-flex gap-2 mt-1">
                                            <small class="text-muted">
                                                <i class="bi bi-calendar me-1"></i>
                                                ${districtWithoutRemarks[0].created_ts ? new Date(districtWithoutRemarks[0].created_ts).toLocaleDateString() : 'N/A'}
                                            </small>
                                            ${districtWithoutRemarks[0].taluk_name ? `
                                                <small class="text-muted">
                                                    <i class="bi bi-geo me-1"></i>
                                                    ${districtWithoutRemarks[0].taluk_name}
                                                </small>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-secondary fs-6">${districtWithoutRemarks.length}</span>
                                    <small class="d-block text-muted mt-1">entries</small>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Show Unique Remarks -->
                    ${districtUniqueRemarksEntries.length > 0 ? districtUniqueRemarksEntries.slice(0, 5).map((desc, idx) => `
                        <div class="remark-entry mb-2 p-2 border rounded bg-white">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar me-1"></i>
                                        ${desc.created_ts ? new Date(desc.created_ts).toLocaleDateString() : 'N/A'}
                                    </small>
                                    ${desc.taluk_name ? `
                                        <small class="text-muted ms-2">
                                            <i class="bi bi-geo me-1"></i>
                                            ${desc.taluk_name}
                                        </small>
                                    ` : ''}
                                    ${desc.village_name ? `
                                        <small class="text-muted ms-2">
                                            <i class="bi bi-geo-alt me-1"></i>
                                            ${desc.village_name}
                                        </small>
                                    ` : ''}
                                </div>
                                <span class="badge ${desc.active === 1 ? 'bg-success' : 'bg-secondary'}">
                                    ${desc.active === 1 ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <div class="remark-content">
                                <p class="mb-1 fw-semibold">Remark:</p>
                                <div class="bg-light p-2 rounded">
                                    ${desc.suggestion_remarks}
                                </div>
                            </div>
                            ${desc.shopcode ? `
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-shop me-1"></i>
                                        Shop: ${desc.shopcode}
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    `).join('') : ''}
                </div>
            </div>
        `;
                });

                descriptionContent = `
        <div class="mb-3">
            <div class="summary-header d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded border">
                <div>
                    <h6 class="mb-1 fw-bold">
                        <i class="bi bi-bar-chart me-2"></i>
                        Summary Statistics
                    </h6>
                    <div>
                        <span class="badge bg-primary">
                            ${totalRecordsFromDB.toLocaleString()} total row records
                        </span>
                        <span class="badge bg-primary">${totalEntries} total entries</span>
                        <span class="badge bg-success ms-2">${uniqueRemarksCount} unique remarks</span>
                        <span class="badge bg-secondary ms-2">${withoutRemarksCount} without remarks</span>
                    </div>
                </div>
            </div>
            
            ${districtSections}
        </div>
    `;

            } else {
                descriptionContent = `
        <div class="text-center py-4">
            <i class="bi bi-chat-dots fs-4 text-muted mb-2 d-block"></i>
            <p class="text-muted mb-0">No descriptions found for this scheme</p>
            <small class="text-muted">Try adjusting filters or select a different scheme</small>
        </div>
    `;
            }

            return `
    <div class="scheme-description-card p-3 mb-3">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
                <h5 class="fw-bold mb-1">${schemeInfo.schemeName}</h5>
                <small class="text-muted">Dream Scheme ${schemeInfo.position}</small>
            </div>
            <div class="d-flex gap-1">
                <span class="badge bg-warning">${schemeInfo.category}</span>
                <span class="badge bg-info">ID: ${schemeInfo.schemeId}</span>
            </div>
        </div>
        
        ${descriptionContent}
        
        <div class="mt-2 pt-2 border-top">
            <div class="row g-1">
                <div class="col-6">
                    <small class="text-muted">
                        <i class="bi bi-database me-1"></i>
                        Total entries: ${hasDescriptions ? descriptions.length : 0}
                    </small>
                </div>
                <div class="col-6 text-end">
                    <small class="text-muted">
                        <i class="bi bi-clock me-1"></i>
                        Updated just now
                    </small>
                </div>
            </div>
        </div>
    </div>
`;
        }

        // ================== CHART FUNCTIONS ==================
        function normalizeToArray(data) {
            if (!data) return [];

            // If already an array
            if ($.isArray(data)) {
                return data;
            }

            // If API sends object like { success, data: [...] }
            if (typeof data === 'object' && $.isArray(data.data)) {
                return data.data;
            }

            // If single object, wrap it
            if (typeof data === 'object') {
                return [data];
            }

            return [];
        }

        function updateGeographicDistributionChart(filteredData) {
            debugger;

            filteredData = normalizeToArray(filteredData);
            if (!filteredData.length) return;

            const item = filteredData[0];

            if (!pieChart) {
                pieChart = echarts.init(document.getElementById("pie"));
            }

            // âœ… Parse scheme-wise data (string â†’ JSON)
            let schemeData = [];
            try {
                schemeData = JSON.parse(item.scheme_wise_count || '[]');
            } catch (e) {
                console.error('Invalid scheme_wise_count', e);
            }

            if (!schemeData.length) {
                pieChart.clear();
                return;
            }

            const chartData = schemeData.map(s => ({
                name: s.scheme_name,
                value: s.count
            }));

            pieChart.setOption({
                title: {
                    // text: 'Scheme-wise Distribution',
                    subtext: 'Total: ' + item.total_ufcno_count.toLocaleString(),
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                // legend: {
                //     orient: 'vertical',
                //     right: 10,
                //     top: 'middle'
                // },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['35%', '50%'],
                    data: chartData
                }]
            });

            updateSummaryCards(filteredData);

            $('#filterSummary').text(
                '(' + item.total_ufcno_count.toLocaleString() +
                ' records across ' +
                item.total_district_count + ' districts)'
            );
        }

        function updateSummaryCards(countData) {
            debugger;

            countData = normalizeToArray(countData);
            console.log("countData for summary cards:", countData);

            if (!countData.length) return;

            const item = countData[0];

            $('#totalFamiliesCount').text(item.total_ufcno_count.toLocaleString());
            $('#activeFamiliesCount').text(item.total_ufcno_count.toLocaleString());
            $('#totalDistrictsCount').text(item.total_district_count.toLocaleString());
            $('#totalVillagesCount').text(item.total_village_count.toLocaleString());
        }

        // ================== FILTER FUNCTIONS ==================

        // Update scheme filter logic
        function updateSchemeLogic(logic) {
            schemeLogic = logic;
            document.getElementById('schemeLogicIndicator').textContent = `${logic} Logic`;;
        }

        async function applyFilters() {
            console.log("========== APPLYING FILTERS ==========");

            $('#filterSummary').text('Loading data...');
            $('#totalFamiliesCount').text('0');
            $('#activeFamiliesCount').text('0');
            $('#totalDistrictsCount').text('0');
            $('#totalVillagesCount').text('0');

            var filters = {
                district: $('#district').val(),
                taluk: $('#taluk').val(),
                village: $('#village').val(),
                shop: $('#shop').val(),
                schemeLogic: schemeLogic
            };

            for (var i = 1; i <= 3; i++) {
                filters['schemeList' + i] = $('#schemeList' + i).val();
            }

            try {
                // âœ… ALWAYS call count API
                const countPromise = loadCountDataForChart(filters);

                // âœ… Call detailed API ONLY if scheme selected
                let detailedPromise = Promise.resolve([]);

                if (isAnySchemeSelected(filters)) {
                    detailedPromise = loadDetailedDataForDescriptions(filters);
                } else {
                    console.log("No schemes selected â†’ skipping detailed API");
                }

                const [countData, detailedData] = await Promise.all([
                    countPromise,
                    detailedPromise
                ]);

                if (!hasValidCountData(countData)) {
                    console.warn("No data found for selected filters");

                    // Reset summary cards
                    $('#totalFamiliesCount').text('0');
                    $('#activeFamiliesCount').text('0');
                    $('#totalDistrictsCount').text('0');
                    $('#totalVillagesCount').text('0');

                    // Update filter summary
                    $('#filterSummary').text('No data found for selected filters');

                    // Clear chart with message
                    showNoGeographicData();

                    // Clear descriptions
                    $('#schemeDescriptions').html(`
        <div class="text-center text-muted py-4">
            <i class="bi bi-search fs-1 mb-2 d-block"></i>
            <p>No data found</p>
            <small class="text-muted">
                Try changing filters or selecting different schemes
            </small>
        </div>
    `);

                    return; // â›” STOP further processing
                }
                API_DATA.chartData = countData;
                API_DATA.detailedData = detailedData;
                API_DATA.filteredData = countData;

                updateSummaryCards(countData);
                updateGeographicDistributionChart(countData);

                // âœ… Only update descriptions if data exists
                if (detailedData.length) {
                    updateSchemeDescriptionsFromData(detailedData);
                } else {
                    $('#schemeDescriptions').empty(); // optional: clear UI
                }

                console.log("Filters applied successfully");

            } catch (err) {
                console.error("Filter error:", err);
                $('#filterSummary').text('Error loading data');
                alert('Error loading data');
            }
        }


        function hasValidCountData(countData) {
            if (!countData) return false;

            const arr = normalizeToArray(countData);
            if (!arr.length) return false;

            // when API returns success but zero records
            return Number(arr[0].total_ufcno_count || 0) > 0;
        }
        // Update filter summary display
        function updateFilterSummary(filters) {
            const summaryDiv = $('#activeFiltersDisplay');
            summaryDiv.empty();

            // Add geographic filters
            if (filters.district !== 'ALL') {
                const districtName = $('#district option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> District: ${districtName}</span>`);
            }

            if (filters.taluk !== 'ALL') {
                const talukName = $('#taluk option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> Taluk: ${talukName}</span>`);
            }

            if (filters.village !== 'ALL') {
                const villageName = $('#village option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-geo-alt"></i> Village: ${villageName}</span>`);
            }

            if (filters.shop !== 'ALL') {
                const shopName = $('#shop option:selected').text();
                summaryDiv.append(`<span class="active-filter-badge"><i class="bi bi-shop"></i> Shop: ${shopName}</span>`);
            }

            // Add scheme filters
            const selectedSchemes = [];
            for (let i = 1; i <= 3; i++) {
                const category = filters[`schemeCategory${i}`];
                const schemeId = filters[`schemeList${i}`];

                if (category !== 'ALL' && schemeId !== 'ALL') {
                    const schemeName = $(`#schemeList${i} option:selected`).text();
                    const categoryName = $(`#schemeCategory${i} option:selected`).text();
                    selectedSchemes.push(`${categoryName}: ${schemeName}`);
                }
            }

            if (selectedSchemes.length > 0) {
                const logicText = schemeLogic === 'AND' ? 'AND' : 'OR';
                const schemesText = selectedSchemes.join(` ${logicText} `);
                summaryDiv.append(`<span class="active-filter-badge" style="background:#f59e0b;"><i class="bi bi-card-checklist"></i> Schemes (${logicText}): ${schemesText}</span>`);

                // Show API structure info
                summaryDiv.append(`<span class="active-filter-badge" style="background:#28a745;"><i class="bi bi-code-slash"></i> API: AND/OR Structure</span>`);
            }

            // Add logic badge
            summaryDiv.append(`<span class="active-filter-badge" style="background:#6c757d;"><i class="bi bi-funnel"></i> Logic: ${schemeLogic}</span>`);
        }

        // Reset all filters
        function resetAll() {
            ////console.log("Resetting all filters...");

            // Reset geographic filters
            $('#district').val('ALL').trigger('change');
            $('#taluk').val('ALL').prop('disabled', false);
            $('#village').val('ALL').prop('disabled', false);
            $('#shop').val('ALL');

            // Reset demographic filters
            $('#gender').val('ALL');
            $('#ageMin').val(18);
            $('#ageMax').val(80);

            // Reset dates
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            $('#dateFrom').val(oneYearAgo.toISOString().split('T')[0]);
            $('#dateTo').val(today.toISOString().split('T')[0]);

            // Reset scheme filters
            for (let i = 1; i <= 3; i++) {
                $(`#schemeCategory${i}`).val('ALL');
                $(`#schemeList${i}`).val('ALL');
            }

            // Reset logic to AND
            $('#schemeLogicAND').prop('checked', true);
            schemeLogic = 'AND';
            document.getElementById('schemeLogicIndicator').textContent = 'AND Logic';

            // Reset scheme descriptions placeholder (no API); applyFilters will load data
            showSchemeDescriptionsPlaceholder();

            // Clear filter summary
            $('#activeFiltersDisplay').empty();

            // Clear chart and summary
            if (pieChart) {
                pieChart.clear();
            }
            $('#filterSummary').text('');
            $('#totalFamiliesCount').text('0');
            $('#activeFamiliesCount').text('0');
            $('#totalDistrictsCount').text('0');
            $('#totalVillagesCount').text('0');

            // Apply filters to load default data
            // applyFilters();

            ////console.log("All filters reset successfully");
        }

        // ================== EXPORT FUNCTIONS ==================

        // Export CSV
        function exportCSV() {
            // Use detailedData if available, otherwise use chartData
            const dataToExport = API_DATA.detailedData && API_DATA.detailedData.length > 0
                ? API_DATA.detailedData
                : API_DATA.chartData;

            if (!dataToExport || dataToExport.length === 0) {
                alert('No data to export. Please apply filters first.');
                return;
            }

            try {
                // Prepare CSV headers
                const headers = [
                    'District', 'Taluk', 'Village', 'Shop Code', 'Scheme Name',
                    'Type', 'Suggestion Remarks', 'Created Date', 'Status'
                ];

                // Prepare CSV rows
                const rows = dataToExport.map(item => [
                    item.district_name || '',
                    item.taluk_name || '',
                    item.village_name || '',
                    item.shopcode || '',
                    item.scheme_name || '',
                    item.type || '',
                    item.suggestion_remarks || '',
                    item.created_ts ? new Date(item.created_ts).toLocaleDateString() : '',
                    item.active === 1 ? 'Active' : 'Inactive'
                ]);

                // Create CSV content
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', `dream_scheme_data_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert(`Exported ${dataToExport.length} records to CSV`);
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting data. Please try again.');
            }
        }

        // Export PDF
        function exportPDF() {
            if (API_DATA.filteredData.length === 0) {
                alert('No data to export. Please apply filters first.');
                return;
            }

            try {
                // Use html2canvas to capture the chart
                html2canvas(document.getElementById('pie'), {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');

                    // Create PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('landscape');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();

                    // Add title
                    pdf.setFontSize(16);
                    pdf.text('Dream Scheme Analytics Report', pageWidth / 2, 15, { align: 'center' });

                    // Add date
                    pdf.setFontSize(10);
                    pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, 22, { align: 'center' });

                    // Add summary statistics
                    pdf.setFontSize(12);
                    pdf.text(`Total Records: ${API_DATA.filteredData.length}`, 20, 35);

                    // Count unique districts
                    const uniqueDistricts = new Set(API_DATA.filteredData.map(item => item.district_name).filter(Boolean));
                    pdf.text(`Districts: ${uniqueDistricts.size}`, 20, 42);

                    // Add chart image
                    const imgWidth = pageWidth - 40;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 20, 50, imgWidth, imgHeight);

                    // Add filter summary
                    const filterText = $('#activeFiltersDisplay').text().substring(0, 100) + '...';
                    pdf.setFontSize(10);
                    pdf.text(`Filters Applied: ${filterText}`, 20, imgHeight + 60);

                    // Save PDF
                    pdf.save(`dream_scheme_report_${new Date().toISOString().split('T')[0]}.pdf`);

                    alert('PDF exported successfully!');
                });
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Error exporting PDF. Please try again.');
            }
        }

        // ================== SIDEBAR FUNCTIONS ==================

        // Sidebar functions
        function toggleSidebar() {
            $("#sidebar").toggleClass("collapsed");
            $("#main").toggleClass("collapsed");
            setTimeout(() => {
                if (pieChart) {
                    pieChart.resize();
                }
            }, 300);
        }

        // Initialize sidebar for mobile
        if (window.innerWidth <= 768) {
            document.getElementById("sidebar").classList.add("collapsed");
            document.getElementById("main").classList.add("collapsed");
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener("click", function (e) {
            if (window.innerWidth <= 768) {
                let sidebar = document.getElementById("sidebar");
                let btn = document.querySelector(".bi-list");

                if (btn && !sidebar.contains(e.target) && !btn.contains(e.target)) {
                    sidebar.classList.add("collapsed");
                }
            }
        });

        // Initialize charts on window resize
        window.addEventListener('resize', function () {
            if (pieChart) {
                pieChart.resize();
            }
        });

        // Load initial data when page loads
        $(window).on('load', function () {
            // Apply filters to load initial data after a short delay
            setTimeout(() => {
                // applyFilters();
            }, 1500);
        });
    </script>
</body>

</html>